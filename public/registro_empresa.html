<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Empresa</title>
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/components.css" />
  <link rel="stylesheet" href="/css/layout.css" />
  <style>
    body{background:linear-gradient(180deg,#eefaf3 0%, #e6f7ef 60%, #f6fbf7 100%)}
    .wrap{max-width:880px;margin:0 auto;padding:24px}
    .title{font-weight:800;font-size:28px;margin:0 0 8px}
    .subtitle{color:var(--color-muted);margin:0 0 18px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .full{grid-column:1 / -1}
    .hint{color:var(--color-muted);font-size:12px}
    .avatar{width:80px;height:80px;border-radius:999px;background:linear-gradient(180deg,#e8fbf2,#d6f5e6);border:1px solid #cfeeda;box-shadow:0 10px 20px rgba(34,197,94,0.20);display:flex;align-items:center;justify-content:center;font-size:30px}
  </style>
  <script>
    function setToken(t){ localStorage.setItem('token', t); }
    function setRole(r){ localStorage.setItem('role', r); }
    function setUser(u){ localStorage.setItem('user', JSON.stringify(u)); }
    function goHome(){ window.location.href='/'; }
    function prewarmGeo(){
      try{
        if(navigator.geolocation){
          try{
            const id = navigator.geolocation.watchPosition((p)=>{
              const acc = Number(p.coords.accuracy||9999);
              const cur = window.__bestPosEmp || null;
              if(!cur || acc < Number(cur.acc||9999)){
                window.__bestPosEmp = { lat:p.coords.latitude, lon:p.coords.longitude, acc };
                const lat=document.getElementById('lat');
                const lon=document.getElementById('lon');
                if(lat) lat.value=String(p.coords.latitude||'');
                if(lon) lon.value=String(p.coords.longitude||'');
              }
            }, ()=>{}, { enableHighAccuracy:true, maximumAge:0 });
            window.__geoWatchIdEmp = id;
          }catch{}
        }
      }catch{}
    }
    async function useLocation(){
      const lat=document.getElementById('lat');
      const lon=document.getElementById('lon');
      const btn=document.getElementById('use-loc-btn-emp');
      function set(llat,llon){ if(lat) lat.value=String(llat||''); if(lon) lon.value=String(llon||''); }
      window.__usedLocationEmp = true;
      try{
        if(navigator.geolocation){
          const MAX_WAIT_MS = 20000;
          const ACC_THRESHOLD = 25;
          const curBest = window.__bestPosEmp || null;
          if(curBest && curBest.lat!=null && curBest.lon!=null) set(curBest.lat, curBest.lon);
          if(btn) { try{ btn.setAttribute('disabled','true'); }catch{} }
          showAlert('Cargando ubicaci√≥n...', 'ok');
          let best = null;
          let done = false;
          const start = Date.now();
          try{
            const watchId = navigator.geolocation.watchPosition((p)=>{
              const acc = Number(p.coords.accuracy||9999);
              if(!best || acc < (best.acc||9999)){ best = { lat:p.coords.latitude, lon:p.coords.longitude, acc }; set(best.lat,best.lon); }
              if(acc <= ACC_THRESHOLD || (Date.now()-start) > MAX_WAIT_MS){
                try{ navigator.geolocation.clearWatch(watchId); }catch{}
                done = true;
                showAlert('Ubicaci√≥n lista','ok');
                if(btn) { try{ btn.removeAttribute('disabled'); }catch{} }
              }
            }, async ()=>{
              try{ const r=await fetch('https://ipapi.co/json'); const j=await r.json(); set(j?.latitude,j?.longitude); showAlert('Ubicaci√≥n lista (aprox.)','ok'); }catch{ showAlert('No se pudo obtener ubicaci√≥n','error'); }
              done = true;
              if(btn) { try{ btn.removeAttribute('disabled'); }catch{} }
            }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
            setTimeout(async ()=>{
              if(!done){
                try{ navigator.geolocation.clearWatch(watchId); }catch{}
                if(!best){
                  try{ const r=await fetch('https://ipapi.co/json'); const j=await r.json(); set(j?.latitude,j?.longitude); showAlert('Ubicaci√≥n lista (aprox.)','ok'); }catch{ showAlert('No se pudo obtener ubicaci√≥n','error'); }
                } else {
                  showAlert('Ubicaci√≥n lista','ok');
                }
                if(btn) { try{ btn.removeAttribute('disabled'); }catch{} }
              }
            }, MAX_WAIT_MS+1500);
          }catch{
            try{ const r=await fetch('https://ipapi.co/json'); const j=await r.json(); set(j?.latitude,j?.longitude); showAlert('Ubicaci√≥n lista (aprox.)','ok'); }catch{ showAlert('No se pudo obtener ubicaci√≥n','error'); }
            if(btn) { try{ btn.removeAttribute('disabled'); }catch{} }
          }
          return;
        }
      }catch{}
    }
    document.addEventListener('DOMContentLoaded', prewarmGeo);
    window.addEventListener('beforeunload', ()=>{ try{ const id = window.__geoWatchIdEmp; if(id!=null) navigator.geolocation.clearWatch(id); }catch{} });
    function readFileBase64(file){
      return new Promise((resolve)=>{ try{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.readAsDataURL(file); }catch{ resolve(null); } });
    }
    function showAlert(msg,type){ const el=document.getElementById('alert'); if(!el) return; el.textContent=msg; el.className='badge'; el.style.background= type==='error' ? '#ffecec' : '#F2FBF7'; el.style.borderColor= type==='error' ? '#fca5a5' : '#cfeeda'; }
    async function loadMateriales(){
      try{
        const r=await fetch('/api/materiales'); const list=await r.json();
        const box=document.getElementById('mat-box'); if(!box) return; box.innerHTML='';
        list.forEach((m)=>{
          const wrap=document.createElement('div'); wrap.className='row'; wrap.style.alignItems='flex-end'; wrap.style.gap='8px'; wrap.style.margin='6px 0';
          wrap.innerHTML = `
            <label class="check-wrap" style="min-width:180px"><input type="checkbox" data-mid="${m.id}" /><span>${m.nombre}</span></label>
            <div style="flex:1"><label>Precio/kg</label><input type="number" step="0.1" min="0" data-price-for="${m.id}" placeholder="0.00" /></div>
            <div style="flex:1"><label>Condiciones</label><input type="text" data-cond-for="${m.id}" placeholder="Opcional" /></div>
          `;
          box.appendChild(wrap);
        });
      }catch{}
    }
    async function submit(){
      const nombre=(document.getElementById('nombre')||{}).value||'';
      const ruc=(document.getElementById('ruc')||{}).value||'';
      const email=(document.getElementById('email')||{}).value||'';
      const pass=(document.getElementById('pass')||{}).value||'';
      const pass2=(document.getElementById('pass2')||{}).value||'';
      const lat=(document.getElementById('lat')||{}).value||'';
      const lon=(document.getElementById('lon')||{}).value||'';
      if(!nombre || !ruc){ showAlert('Nombre y RUC son requeridos','error'); return; }
      if(!/^\d{11}$/.test(ruc)){ showAlert('RUC debe tener exactamente 11 d√≠gitos','error'); return; }
      if(!email || !pass){ showAlert('Email y contrase√±a son requeridos','error'); return; }
      if(pass!==pass2){ showAlert('Las contrase√±as no coinciden','error'); return; }
      const usedLoc = Boolean(window.__usedLocationEmp);
      if(usedLoc && (!lat || !lon)){ showAlert('Lat y Lon son requeridas tras usar ubicaci√≥n','error'); return; }
      if(lat){ const n=Number(lat); if(Number.isNaN(n) || n<-90 || n>90){ showAlert('Lat inv√°lida (-90 a 90)','error'); return; } }
      if(lon){ const n=Number(lon); if(Number.isNaN(n) || n<-180 || n>180){ showAlert('Lon inv√°lida (-180 a 180)','error'); return; } }
      let logo=null; const file=(document.getElementById('logo')||{}).files? (document.getElementById('logo').files[0]||null) : null; if(file){ logo = await readFileBase64(file); }
      let f1=null; const file1=(document.getElementById('foto1')||{}).files? (document.getElementById('foto1').files[0]||null) : null; if(file1){ f1 = await readFileBase64(file1); }
      let f2=null; const file2=(document.getElementById('foto2')||{}).files? (document.getElementById('foto2').files[0]||null) : null; if(file2){ f2 = await readFileBase64(file2); }
      let f3=null; const file3=(document.getElementById('foto3')||{}).files? (document.getElementById('foto3').files[0]||null) : null; if(file3){ f3 = await readFileBase64(file3); }
      try{
        const body={ email, password:pass, ruc, nombre, logo_base64: logo, foto_local_1_base64: f1, foto_local_2_base64: f2, foto_local_3_base64: f3, lat: lat? Number(lat): null, lon: lon? Number(lon): null };
        const r=await fetch('/api/auth/register/empresa', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        const j=await r.json();
        if(j.token){
          setToken(j.token); setRole('empresa'); setUser(j.empresa);
          try{
            const items=[]; const box=document.getElementById('mat-box');
            const checks=box ? box.querySelectorAll('input[type="checkbox"][data-mid]') : [];
            checks.forEach((chk)=>{
              if(chk.checked){
                const mid=Number(chk.getAttribute('data-mid'));
                const priceEl=box.querySelector(`input[data-price-for="${mid}"]`);
                const condEl=box.querySelector(`input[data-cond-for="${mid}"]`);
                const precio = priceEl && priceEl.value? Number(priceEl.value): 0;
                const condiciones = condEl && condEl.value? String(condEl.value): null;
                items.push({ material_id: mid, precio_por_kg: precio, condiciones });
              }
            });
            if(items.length){ await fetch(`/api/empresas/${j.empresa.id}/materiales/upsert`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${j.token}` }, body: JSON.stringify({ items }) }); }
          }catch{}
          window.location.href='/dashboard.html';
          return;
        }
        showAlert('No se pudo registrar. Revisa los datos.','error');
      }catch{ showAlert('Error de red al registrar.','error'); }
    }
    document.addEventListener('DOMContentLoaded', loadMateriales);
  </script>
</head>
<body>
  <div class="wrap">
    <div class="row jc-between ai-center">
      <div class="row ai-center gap-12"><div class="avatar">üè¢</div><div><div class="title">Registro de Empresa</div><div class="subtitle">Crea tu cuenta y publica tu cat√°logo.</div></div></div>
      <button class="btn secondary" onclick="goHome()">Inicio</button>
    </div>
    <div id="alert" class="badge" style="display:block; margin-top:10px; background:#F2FBF7; border-color:#cfeeda"></div>
    <div class="panel mt-12">
      <div class="grid2">
        <div>
          <label>Nombre de empresa</label>
          <input id="nombre" type="text" placeholder="Nombre" />
        </div>
        <div>
          <label>RUC</label>
          <input id="ruc" type="text" placeholder="11 d√≠gitos" maxlength="11" inputmode="numeric" pattern="^\d{11}$" autocomplete="off" />
          <div class="hint">11 d√≠gitos (num√©rico)</div>
        </div>
        <div>
          <label>Correo</label>
          <input id="email" type="email" placeholder="correo@empresa.com" autocomplete="off" />
        </div>
        <div>
          <label>Password</label>
          <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
        </div>
        <div>
          <label>Confirmar</label>
          <input id="pass2" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
        </div>
        <div class="full">
          <label>Logo</label>
          <input id="logo" type="file" accept="image/png,image/jpeg" />
          <div class="hint">Se guardar√° en /public/img</div>
        </div>
        <div class="full">
          <label>Fotos del local</label>
          <div class="grid2">
            <div>
              <input id="foto1" type="file" accept="image/png,image/jpeg" />
              <div class="hint">foto_local_1</div>
            </div>
            <div>
              <input id="foto2" type="file" accept="image/png,image/jpeg" />
              <div class="hint">foto_local_2</div>
            </div>
            <div>
              <input id="foto3" type="file" accept="image/png,image/jpeg" />
              <div class="hint">foto_local_3</div>
            </div>
          </div>
        </div>
        <div class="full">
          <label>Materiales y precios</label>
          <div id="mat-box"></div>
        </div>
        <div>
          <label>Lat</label>
          <input id="lat" type="text" placeholder="opcional" />
        </div>
        <div>
          <label>Lon</label>
          <input id="lon" type="text" placeholder="opcional" />
        </div>
      </div>
      <div class="row jc-between mt-12">
        <button id="use-loc-btn-emp" class="btn secondary" onclick="useLocation()">Usar mi ubicaci√≥n</button>
        <button class="btn" onclick="submit()">Crear cuenta</button>
      </div>
    </div>
  </div>
</body>
</html>
