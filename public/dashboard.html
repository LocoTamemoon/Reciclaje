<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    :root{ --bg:#f6fbf7; --bg2:#eef7f2; --panel:#ffffff; --panel2:#f8fbf8; --muted:#7b978b; --primary:#3ac27f; --accent:#38c1b3; --text:#0f172a; --border:#d9e7de; --shadow:rgba(15,60,30,0.08); }
    body{ margin:0; font-family:system-ui, Segoe UI, Arial; background:linear-gradient(120deg, var(--bg), var(--bg2)); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    h2{ margin:0; font-weight:700; letter-spacing:0.2px; }
    h3{ margin:0; font-weight:600; }
    .layout{ display:grid; grid-template-columns: 280px 1fr; min-height:100vh; }
    .sidebar{ background:linear-gradient(180deg, #f0f7f2 0%, #eaf6f0 100%); padding:18px; border-right:1px solid var(--border); box-shadow:0 6px 20px var(--shadow); }
    .brand{ font-weight:700; font-size:18px; margin-bottom:14px; }
    .menu button{ width:100%; text-align:left; background:transparent; border:none; color:#475569; padding:10px 12px; border-radius:10px; cursor:pointer; transition:all .18s ease; }
    .menu button.active{ background:#e6f4ec; color:#0f172a; box-shadow:0 4px 12px var(--shadow); }
    .menu button:hover{ background:#edf7f2; transform:translateY(-1px); }
    .content{ padding:22px; }
    .panel{ background:linear-gradient(180deg, var(--panel), var(--panel2)); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 8px 20px var(--shadow); position:relative; overflow:hidden; }
    .panel::before{ content:""; position:absolute; inset:-18% 52% auto auto; width:200px; height:200px; background:radial-gradient(closest-side, rgba(56,193,179,0.10), transparent); transform:rotate(8deg); pointer-events:none; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:16px; }
    .card{ background:#ffffff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:0 6px 16px var(--shadow); transition:transform .14s ease, box-shadow .14s ease; }
    .card:hover{ transform:translateY(-2px); box-shadow:0 12px 28px var(--shadow); }
    .row{ display:flex; gap:10px; align-items:center; }
    .muted{ color:var(--muted); font-size:12px; }
    .badge{ display:inline-flex; align-items:center; background:#f2fbf7; border:1px solid var(--border); padding:4px 8px; border-radius:999px; font-size:12px; }
    .btn{ background:linear-gradient(180deg, #33cf79, var(--primary)); color:#083e2a; border:none; border-radius:10px; padding:8px 12px; cursor:pointer; box-shadow:0 6px 14px var(--shadow); transition:all .14s ease; font-weight:600; }
    .btn:hover{ filter:brightness(1.06); transform:translateY(-1px); }
    .btn:active{ transform:translateY(0); }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; filter:none; box-shadow:none; }
    .btn.secondary{ background:linear-gradient(180deg, #3ed1c3, var(--accent)); color:#083333; }
    .right{ text-align:right; }
    .list{ list-style:none; padding:0; margin:0; }
    .list li{ padding:10px 12px; background:#ffffff; border:1px solid var(--border); border-radius:12px; margin:8px 0; box-shadow:0 6px 14px var(--shadow); }
    .cards-row{ align-items:flex-start; gap:12px; }
    .stats-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:12px; }
    .stat-card{ background:#ffffff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:0 6px 14px var(--shadow); }
    .stat-title{ color:var(--muted); font-size:12px; }
    .stat-value{ font-weight:700; }
    .mono{ font-family: ui-monospace, Menlo, monospace; font-size:12px; }
    input, select{ background:#ffffff; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; outline:none; transition:border-color .14s ease, box-shadow .14s ease; }
    input:focus, select:focus, textarea:focus{ border-color:#3ac27f; box-shadow:0 0 0 3px rgba(58,194,127,0.25); }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    th, td{ padding:10px; border-bottom:1px solid var(--border); }
    th{ text-align:left; color:#cbd5e1; font-weight:600; }
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,0.12); display:flex; align-items:center; justify-content:center; backdrop-filter:saturate(160%) blur(4px); }
    .modal[hidden]{ display:none !important; }
    .modal-card{ background:linear-gradient(180deg, #ffffff, #fbfdfc); border:1px solid var(--border); border-radius:16px; width:440px; max-width:92vw; padding:16px; box-shadow:0 10px 24px var(--shadow); }
    .modal-card h3{ margin:0 0 12px; font-weight:700; }
    .modal-card textarea{ width:100%; min-height:92px; border-radius:10px; border:1px solid var(--border); background:#ffffff; color:var(--text); padding:10px; }
    .modal-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:14px; }
    @media (max-width: 880px){ .layout{ grid-template-columns: 1fr; } .sidebar{ position:sticky; top:0; z-index:10; } }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">Reciclaje App</div>
      <div class="mono" id="user-info"></div>
      <div class="menu">
        <button id="m-empresas" onclick="setView('empresas')">Empresas</button>
        <button id="m-solicitudes" onclick="setView('solicitudes')">Mis Solicitudes</button>
        <button id="m-historial" onclick="setView('historial')">Historial</button>
        <button id="m-perfil" onclick="setView('perfil')">Perfil</button>
        <button id="m-resenas" onclick="setView('resenas')">Reseñas</button>
        <button id="m-rewards" onclick="setView('rewards')">Usa Puntos</button>
        <button id="m-mapa" onclick="setView('mapa')">Mapa</button>
        <button onclick="logout()" style="margin-top:12px;">Salir</button>
      </div>
    </aside>
    <main class="content">
      <section id="view-empresas" class="panel" hidden>
        <div class="row" style="justify-content:space-between;">
          <h2>Empresas disponibles</h2>
          <button class="btn secondary" onclick="loadEmpresas()">Actualizar</button>
        </div>
        <div id="empresas" class="grid"></div>
      </section>
      <section id="view-recolector" class="panel" hidden>
        <div class="row" style="justify-content:space-between;">
          <h2>Solicitudes Disponibles</h2>
          <button class="btn secondary" onclick="loadRecolectorFeed()">Actualizar</button>
        </div>
        <ul id="reco-feed" class="list"></ul>
      </section>
      <section id="view-empresa" class="panel" hidden>
        <div class="row" style="justify-content:space-between;">
          <h2 id="empresa-titulo">Empresa</h2>
          <div class="row">
            <button class="btn secondary" onclick="setView('empresas')">Volver</button>
            <button class="btn" onclick="confirmarSolicitud()">Crear solicitud</button>
          </div>
        </div>
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <div id="empresa-meta" class="muted"></div>
          </div>
          <div class="right">
            <div>Estimado total: <strong id="estimado-total">S/ 0.00</strong></div>
          </div>
        </div>
        <div style="margin-top:12px; overflow:auto;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:1px solid #1f2937;">
                <th style="text-align:left; padding:8px;">Material</th>
                <th style="text-align:right; padding:8px;">Precio/kg (S/)</th>
                <th style="text-align:right; padding:8px;">Kg a entregar</th>
                <th style="text-align:right; padding:8px;">Subtotal (S/)</th>
              </tr>
            </thead>
            <tbody id="materiales-body"></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:10px;" id="empresa-cond"></div>
        <div style="margin-top:10px;">
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="delivery-check" />
            <span>Solicito el delivery sabiendo las condiciones del Acuerdo de Usuario a VidaVerde</span>
          </label>
          <div class="muted" id="delivery-hint" style="margin-top:6px;">Delivery disponible desde S/ 35</div>
        </div>
        <div style="margin-top:16px;">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <h3>Reseñas</h3>
            <button class="btn secondary" onclick="empresaResenasRefresh()">Actualizar</button>
          </div>
          <ul id="empresa-resenas-list" class="list"></ul>
        </div>
      </section>
      <section id="view-solicitudes" class="panel" hidden>
        <div class="row" style="justify-content:space-between;">
          <h2>Mis Solicitudes</h2>
          <button class="btn secondary" onclick="loadSolicitudes()">Actualizar</button>
        </div>
        <div class="row cards-row">
          <div style="flex:1" class="card">
            <div class="row" style="justify-content:space-between; align-items:center;">
              <h3>Pendientes</h3>
              <button class="btn secondary" onclick="loadSolicitudes()">Refrescar</button>
            </div>
            <ul id="sol-pend" class="list"></ul>
          </div>
          <div style="flex:1" class="card">
            <div class="row" style="justify-content:space-between; align-items:center;">
              <h3>Anteriores</h3>
              <button class="btn secondary" onclick="loadSolicitudes()">Refrescar</button>
            </div>
            <ul id="sol-ant" class="list"></ul>
          </div>
        </div>
      </section>
      <section id="view-historial" class="panel" hidden>
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h2 id="hist-title">Historial de Transacciones</h2>
          <div class="badge" id="hist-earnings" style="margin-left:8px;">Ganancia total: S/ 0.00</div>
          <div class="row">
            <button class="btn secondary" id="hist-refresh">Actualizar</button>
            <button class="btn" id="hist-toggle">Gasto de Puntos</button>
          </div>
        </div>
        <ul id="hist-list" class="list"></ul>
        <div id="hist-detalle" class="panel" style="margin-top:12px; display:none;"></div>
      </section>
      <section id="view-empresa-solicitudes" class="panel" hidden>
        <div class="row" style="justify-content:space-between;">
          <h2>Solicitudes Entrantes</h2>
          <button class="btn secondary" onclick="loadSolicitudesEmpresa()">Actualizar</button>
        </div>
        <ul id="emp-sol-list" class="list"></ul>
      </section>
      <section id="view-rewards" class="panel" hidden>
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h2>Usa tus puntos</h2>
          <div class="badge" id="rewards-puntos">Puntos: 0</div>
        </div>
        <ul id="rewards-list" class="list"></ul>
      </section>
      <section id="view-resenas" class="panel" hidden>
        <div class="row" style="justify-content:space-between;">
          <h2>Reseñas de la empresa</h2>
          <button class="btn secondary" onclick="loadResenasEmpresa()">Actualizar</button>
        </div>
        <ul id="resenas-list" class="list"></ul>
      </section>
      <section id="view-mapa" class="panel" hidden>
        <div class="row" style="justify-content:space-between; align-items:center; gap:10px;">
          <h2>Mapa</h2>
          <div class="row" style="gap:8px; align-items:center;">
            <span class="badge" id="acc-badge">Precisión —</span>
            <span class="badge" id="dist-badge">Distrito —</span>
            <button class="btn secondary" id="buscar-btn">Mi ubicación</button>
          </div>
        </div>
        <div class="row" style="gap:8px; margin-top:8px;">
          <input id="addr-input" placeholder="Dirección" style="flex:1" />
          <button class="btn secondary" id="addr-btn">Buscar dirección</button>
          <button class="btn" id="distrito-btn">Ver distrito</button>
        </div>
        <div class="card" style="margin-top:8px; padding:8px;">
          <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap;">
            <select id="map-filtro" style="min-width:240px;">
              <option value="none">---SELECCIONE---</option>
              <option value="mejor_material">Mejores pagos por material</option>
              <option value="mas_cercana">Empresa recicladora más cercana</option>
              <option value="empresas_count">Empresas registradas en distrito</option>
              <option value="mas_tx">Distrito con más transacciones</option>
              <option value="mejor_distrito">Distrito con mejores calificaciones</option>
            </select>
            <select id="map-material" style="min-width:240px; display:none;"></select>
            <label style="display:none; align-items:center; gap:6px;" id="limit-dist-wrap">
              <input type="checkbox" id="map-limit-distrito" /> Limitar por distrito
            </label>
            <select id="map-limit-distrito-sel" style="min-width:240px; display:none;"></select>
            <select id="map-filtro-distrito" style="min-width:240px; display:none;"></select>
            <button class="btn" id="aplicar-filtro">Aplicar filtro</button>
            <button class="btn secondary" id="quitar-filtro">Quitar filtro</button>
            <span id="filtro-res" class="muted"></span>
          </div>
        </div>
        <div class="card" style="margin-top:12px;">
          <div id="map" style="height:60vh; width:100%; border-radius:12px;"></div>
        </div>
      </section>
      <section id="view-pesaje" class="panel" hidden>
        <div class="row" style="justify-content:space-between;">
          <h2 id="pesaje-titulo">Pesaje</h2>
          <div class="row">
            <button class="btn secondary" onclick="cancelarPesaje()">Cancelar</button>
            <button class="btn" id="btn-pesaje-confirm" onclick="confirmarPesaje()" disabled>Registrar pesaje y pago</button>
          </div>
        </div>
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <div id="pesaje-meta" class="muted"></div>
          </div>
          <div class="right">
            <div>Método de pago
              <select id="metodo-pago">
                <option value="efectivo">Efectivo</option>
                <option value="transferencia">Transferencia</option>
              </select>
            </div>
          </div>
        </div>
        <div style="margin-top:12px; overflow:auto;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:1px solid #1f2937;">
                <th style="text-align:left; padding:8px;">Material</th>
                <th style="text-align:right; padding:8px;">Precio/kg (S/)</th>
                <th style="text-align:right; padding:8px;">Kg finales</th>
                <th style="text-align:right; padding:8px;">Subtotal (S/)</th>
              </tr>
            </thead>
            <tbody id="pesaje-body"></tbody>
          </table>
        </div>
        <div class="right" style="margin-top:10px; display:flex; gap:12px; align-items:center; justify-content:flex-end; flex-wrap:wrap;">
          <div>Total estimado: <strong id="pesaje-total">S/ 0.00</strong></div>
          <div>Comisión (10%): <strong id="pesaje-fee">S/ 0.00</strong></div>
          <div>Total a pagar: <strong id="pesaje-net">S/ 0.00</strong></div>
          <div class="row" style="gap:8px; align-items:center;">
            <input type="checkbox" id="pesaje-agree" />
            <label for="pesaje-agree" style="font-size:12px;">Acepto las condiciones del Acuerdo de Suscriptor a Vida Verde</label>
          </div>
        </div>
      </section>
      <section id="view-perfil" class="panel" hidden>
        <h2>Perfil</h2>
        <div id="perfil" class="mono"></div>
        <div id="perfil-materiales" style="margin-top:12px;" hidden>
          <div class="row" style="justify-content:space-between;">
            <h3>Materiales y precios</h3>
            <button class="btn" onclick="perfilSaveMaterials()">Guardar cambios</button>
          </div>
          <div class="row" style="gap:12px; margin:8px 0;">
            <select id="perfil-add-select" style="flex:1"></select>
            <input id="perfil-add-precio" type="number" step="0.01" placeholder="Precio base" style="width:140px" />
            <button class="btn secondary" onclick="perfilAddMaterial()">Agregar material</button>
          </div>
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:1px solid #1f2937;">
                <th style="text-align:left; padding:8px;">Material</th>
                <th style="text-align:right; padding:8px;">Precio/kg (S/)</th>
                <th style="text-align:right; padding:8px;">Acciones</th>
              </tr>
            </thead>
            <tbody id="perfil-materiales-body"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <div id="rating-modal" class="modal" hidden>
    <div class="modal-card">
      <h3 id="rating-title">Calificar</h3>
      <label>Puntaje (1-5)</label>
      <select id="rating-score">
        <option value="5">5</option>
        <option value="4">4</option>
        <option value="3">3</option>
        <option value="2">2</option>
        <option value="1">1</option>
      </select>
      <label class="mt">Mensaje (opcional)</label>
      <textarea id="rating-msg" placeholder="Escribe un comentario..."></textarea>
      <div class="modal-actions">
        <button class="btn" onclick="submitRating()">Enviar</button>
        <button class="btn secondary" onclick="closeRating()">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="aceptar-modal" class="modal" hidden>
    <div class="modal-card">
      <h3>Confirmar aceptación</h3>
      <div id="aceptar-detalle" class="mono"></div>
      <div class="row" style="align-items:center; gap:8px; margin-top:10px;">
        <input type="checkbox" id="aceptar-agree" />
        <label for="aceptar-agree" style="font-size:12px;">Acepto las condiciones del Acuerdo de Suscriptor a Vida Verde</label>
      </div>
      <div id="aceptar-fee-box" class="right" style="margin-top:8px;" hidden>
        <div>Comisión (10%): <strong id="aceptar-fee">S/ 0.00</strong></div>
        <div>Total a pagar: <strong id="aceptar-net">S/ 0.00</strong></div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="btn-aceptar-go">Aceptar</button>
        <button class="btn secondary" id="btn-aceptar-pesaje">Pesaje</button>
        <button class="btn secondary" onclick="closeAceptar()">Volver</button>
      </div>
    </div>
  </div>

  <div id="solicitud-modal" class="modal" hidden>
    <div class="modal-card">
      <h3>Detalle de solicitud</h3>
      <div id="solicitud-detalle" class="mono"></div>
      <div class="modal-actions">
        <button class="btn secondary" onclick="closeSolicitudDetalle()">Cerrar</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    const user = JSON.parse(localStorage.getItem('user')||'null');
    if (!token || !user) { window.location.href = '/login.html'; }

    document.getElementById('user-info').textContent = `${role || 'usuario'} #${user.id}`;

    // Ajuste de texto del menú para recolector
    if (role === 'recolector') {
      const btnSol = document.getElementById('m-solicitudes');
      if (btnSol) btnSol.textContent = 'Solicitudes Disponibles';
    }

    function setView(v){
      for (const id of ['empresas','solicitudes','historial','perfil','resenas','rewards','mapa']){
        document.getElementById('view-'+id).hidden = (id!==v);
        document.getElementById('m-'+id).classList.toggle('active', id===v);
      }
      document.getElementById('view-empresa').hidden = (v!=='empresa');
      document.getElementById('view-empresa-solicitudes').hidden = (v!=='empresa_solicitudes');
      document.getElementById('view-pesaje').hidden = (v!=='pesaje');
      if (role === 'recolector' && v === 'solicitudes') {
        document.getElementById('view-solicitudes').hidden = true;
        const rview = document.getElementById('view-recolector');
        if (rview) rview.hidden = false;
        loadRecolectorFeed();
        return;
      } else {
        const rview = document.getElementById('view-recolector');
        if (rview) rview.hidden = true;
      }
      if (v==='empresas') loadEmpresas();
      if (v==='solicitudes') loadSolicitudes();
      if (v==='historial') {
        if (role==='empresa') {
          loadHistorialEmpresa();
          const he = document.getElementById('hist-earnings');
          if (he) he.style.display = 'none';
        } else if (role==='recolector') {
          const title = document.getElementById('hist-title');
          if (title) title.textContent = 'Historial de trabajos';
          const toggle = document.getElementById('hist-toggle');
          if (toggle) toggle.style.display = 'none';
          const refresh = document.getElementById('hist-refresh');
          if (refresh) refresh.onclick = ()=> loadHistorialRecolector();
          const he = document.getElementById('hist-earnings');
          if (he) he.style.display = 'inline-block';
          loadHistorialRecolector();
        } else {
          initHistorialUI();
          if (histGastosMode) loadHistorialGastos(); else loadHistorial();
          const he = document.getElementById('hist-earnings');
          if (he) he.style.display = 'none';
        }
      }
      if (v==='perfil') loadPerfil();
      if (v==='empresa_solicitudes') loadSolicitudesEmpresa();
      if (v==='resenas' && role==='empresa') loadResenasEmpresa();
      if (v==='rewards' && role==='usuario') loadRewards();
      if (v==='mapa'){ if (!mapaInit) initMapa(); }
    }
    function logout(){ localStorage.clear(); window.location.href='/login.html'; }
    function authHeaders(){ return { 'Content-Type':'application/json', 'Authorization': 'Bearer '+token }; }
    function displayEstadoSolicitud(estado){ return estado === 'aceptada' ? 'completada' : estado; }

    let empresaSeleccionada = null;
    let materialesSeleccionados = [];
    let solicitudSeleccionada = null;
    let perfilMateriales = [];
    let perfilCatalogo = [];
    let histDetalleId = null;

    async function loadEmpresas(){
      const r = await fetch('/api/empresas', { headers: authHeaders() });
      const list = await r.json();
      const container = document.getElementById('empresas');
      container.innerHTML = '';
      list.forEach(e=>{
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>${e.nombre}</strong> <span class="badge">RUC ${e.ruc}</span></div>
            <div class="muted">Reputación: ${Number(e.reputacion_promedio).toFixed(2)} (${e.resenas_recibidas_count} reseñas)</div>
          </div>
          <div class="right">
            <button class="btn secondary" onclick="verEmpresa(${e.id}, '${e.nombre}', '${e.ruc}', ${Number(e.reputacion_promedio)})">Ver materiales</button>
          </div>
        </div>
        <div class="muted">Materiales: ${(e.materiales||[]).map(m=>`#${m.material_id} S/${m.precio_por_kg}`).join(', ') || '—'}</div>`;
        container.appendChild(div);
      });
    }
    async function verEmpresa(id, nombre, ruc, reputacion){
      empresaSeleccionada = { id, nombre, ruc, reputacion };
      document.getElementById('empresa-titulo').textContent = nombre;
      document.getElementById('empresa-meta').textContent = `RUC ${ruc} · Reputación ${reputacion.toFixed ? reputacion.toFixed(2) : reputacion}`;
      const r = await fetch(`/api/empresas/${id}/materiales`, { headers: authHeaders() });
      const mats = await r.json();
      materialesSeleccionados = mats.map(m=>({ material_id: m.material_id, nombre: m.nombre, precio: Number(m.precio_por_kg), kg: 0, condiciones: m.condiciones || '' }));
      renderMateriales();
      setView('empresa');
      await loadEmpresaResenas(id);
    }
    function renderMateriales(){
      const tbody = document.getElementById('materiales-body');
      tbody.innerHTML = '';
      materialesSeleccionados.forEach((m, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:8px;">${m.nombre}</td>
          <td style="padding:8px; text-align:right;">${m.precio.toFixed(2)}</td>
          <td style="padding:8px; text-align:right;"><input type="number" min="0" step="0.1" value="${m.kg}" style="width:120px;" data-idx="${idx}" /></td>
          <td style="padding:8px; text-align:right;" id="sub-${idx}">0.00</td>
        `;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('input[type="number"]').forEach(inp=>{
        inp.addEventListener('input', (ev)=>{
          const i = Number(ev.target.getAttribute('data-idx'));
          const val = Number(ev.target.value);
          materialesSeleccionados[i].kg = isNaN(val) ? 0 : val;
          actualizarEstimado();
        });
      });
      actualizarEstimado();
      const condText = materialesSeleccionados.map(m=> m.condiciones ? `${m.nombre}: ${m.condiciones}` : '').filter(Boolean).join(' · ');
      document.getElementById('empresa-cond').textContent = condText ? `Condiciones: ${condText}` : '';
    }
    function actualizarEstimado(){
      let total = 0;
      materialesSeleccionados.forEach((m, idx)=>{
        const sub = m.kg * m.precio;
        total += sub;
        const el = document.getElementById('sub-'+idx);
        if (el) el.textContent = sub.toFixed(2);
      });
      document.getElementById('estimado-total').textContent = 'S/ ' + total.toFixed(2);
      const dchk = document.getElementById('delivery-check');
      const dhint = document.getElementById('delivery-hint');
      if (dchk) dchk.disabled = total < 35;
      if (dhint) dhint.textContent = total < 35 ? 'Delivery disponible desde S/ 35' : 'Delivery habilitado';
    }
    async function loadEmpresaResenas(empresaId){
      const ul = document.getElementById('empresa-resenas-list');
      if (ul) ul.innerHTML = '';
      const r = await fetch(`/api/resenas/empresa/${empresaId}`, { headers: authHeaders() });
      const list = await r.json();
      const target = document.getElementById('empresa-resenas-list');
      if (!target) return;
      list.forEach(re=>{
        const li = document.createElement('li');
        li.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>Puntaje ${Number(re.puntaje)}</strong> · Tx #${re.transaccion_id}</div>
            <div class="muted">${re.mensaje || '—'}</div>
          </div>
          <div class="right"><span class="badge">${new Date(re.creado_en).toLocaleString()}</span></div>
        </div>`;
        target.appendChild(li);
      });
    }
    function empresaResenasRefresh(){ if (empresaSeleccionada) loadEmpresaResenas(empresaSeleccionada.id); }
    async function confirmarSolicitud(){
      if (!empresaSeleccionada) return;
      const totalKg = materialesSeleccionados.reduce((a,m)=>a+(m.kg||0),0);
      if (totalKg <= 0) { alert('Indica los kg a entregar para al menos un material.'); return; }
      if (!confirm('Crear solicitud con empresa '+empresaSeleccionada.nombre+' y estimado '+document.getElementById('estimado-total').textContent+'?')) return;
      const items = materialesSeleccionados.filter(m=>Number(m.kg)>0).map(m=>({ material_id: Number(m.material_id), kg: Number(m.kg) }));
      const delivery = Boolean(document.getElementById('delivery-check')?.checked);
      const delivery_consent = delivery ? true : false;
      const totalText = document.getElementById('estimado-total').textContent||'S/ 0';
      const totalNum = Number(totalText.replace('S/','').trim());
      if (delivery && totalNum < 35) { alert('Para solicitar delivery el total mínimo es S/ 35'); return; }
      const r = await fetch('/api/solicitudes', { method:'POST', headers: authHeaders(), body: JSON.stringify({ usuario_id: user.id, empresa_id: empresaSeleccionada.id, items, delivery, delivery_consent, delivery_terms_version: 'v1' }) });
      let j;
      try { j = await r.json(); } catch { j = {}; }
      if (j?.error === 'delivery_min_total') { alert('Para solicitar delivery el total mínimo es S/ 35'); return; }
      alert('Solicitud creada: #'+j.id);
      setView('solicitudes');
    }

    async function loadRecolectorFeed(){
      const r = await fetch('/api/recolector/feed', { headers: authHeaders() });
      const list = await r.json();
      const ul = document.getElementById('reco-feed');
      if (!ul) return;
      ul.innerHTML = '';
      list.forEach(s=>{
        const li = document.createElement('li');
        li.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>Solicitud #${s.id}</strong> → Empresa ${s.empresa_id}</div>
            <div class="muted">Clasificación: ${s.clasificacion_distancia||'—'} · Fee: S/ ${Number(s.delivery_fee||0).toFixed(2)}</div>
          </div>
          <div class="right">
            <button class="btn" onclick="recolectorAceptar(${s.id})">Aceptar</button>
          </div>
        </div>`;
        ul.appendChild(li);
      });
    }

    async function recolectorAceptar(sid){
      const body = { recolector_id: user.id };
      const r = await fetch(`/api/recolector/${sid}/aceptar`, { method:'POST', headers: authHeaders(), body: JSON.stringify(body) });
      const j = await r.json();
      if (j?.error === 'no_disponible') { alert('Ya no está disponible'); return; }
      alert('Solicitud aceptada: #'+j.id);
      loadRecolectorFeed();
    }
    async function loadSolicitudes(){
      const r = await fetch(`/api/usuarios/${user.id}/dashboard`, { headers: authHeaders() });
      const j = await r.json();
      const empList = await (await fetch('/api/empresas', { headers: authHeaders() })).json();
      const empNames = new Map(empList.map((e)=> [Number(e.id), String(e.nombre||('Empresa '+e.id))]));
      const pend = document.getElementById('sol-pend');
      const ant = document.getElementById('sol-ant');
      pend.innerHTML = '';
      ant.innerHTML = '';
      (j.solicitudes_pendientes||[]).forEach(s=>{
        const li = document.createElement('li');
        const en = empNames.get(Number(s.empresa_id)) || String(s.empresa_id);
        li.innerHTML = `Solicitud #${s.id} → ${en} <span class="badge">${displayEstadoSolicitud(s.estado)}</span> <button class="btn secondary" onclick="openSolicitudDetalle(${s.id}, ${s.empresa_id})">Ver detalle</button> <button class="btn" onclick="usuarioCancelarSolicitud(${s.id})">Cancelar</button>`;
        pend.appendChild(li);
      });
      (j.solicitudes_anteriores||[]).forEach(s=>{
        const li = document.createElement('li');
        const en = empNames.get(Number(s.empresa_id)) || String(s.empresa_id);
        li.innerHTML = `Solicitud #${s.id} → ${en} <span class="badge">${displayEstadoSolicitud(s.estado)}</span> <button class="btn secondary" onclick="openSolicitudDetalle(${s.id}, ${s.empresa_id})">Ver detalle</button>`;
        ant.appendChild(li);
      });
    }
    async function usuarioCancelarSolicitud(sid){
      const r = await fetch(`/api/solicitudes/${sid}/cancelar`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ usuario_id: user.id }) });
      const j = await r.json();
      alert('Solicitud cancelada: #'+j.id);
      loadSolicitudes();
    }

    let solicitudDetalleCtx = { sid: null, empresa_id: null };
    function closeSolicitudDetalle(){ document.getElementById('solicitud-modal').hidden = true; solicitudDetalleCtx = { sid:null, empresa_id:null }; }
    async function openSolicitudDetalle(sid, empresaId){
      solicitudDetalleCtx = { sid, empresa_id: empresaId };
      const sol = await (await fetch(`/api/solicitudes/${sid}`, { headers: authHeaders() })).json();
      const cat = await (await fetch('/api/materiales', { headers: authHeaders() })).json();
      const nombresCat = new Map(cat.map(m=> [Number(m.id), String(m.nombre)]));
      const empresas = await (await fetch('/api/empresas', { headers: authHeaders() })).json();
      const emp = Array.isArray(empresas) ? empresas.find((e)=> Number(e.id) === Number(empresaId)) : null;
      const matsEmp = await (await fetch(`/api/empresas/${empresaId}/materiales`, { headers: authHeaders() })).json();
      const precios = new Map(matsEmp.map(m=> [Number(m.material_id), Number(m.precio_por_kg)]));
      const nombresEmp = new Map(matsEmp.map(m=> [Number(m.material_id), String(m.nombre)]));
      const items = Array.isArray(sol?.items_json) ? sol.items_json : [];
      let total = 0;
      const rows = items.map(it=>{
        const mid = Number(it.material_id);
        const nombre = nombresEmp.get(mid) || nombresCat.get(mid) || ('Material '+mid);
        const kg = Number(it.kg)||0;
        const precio = precios.get(mid) || 0;
        const sub = precio * kg;
        total += sub;
        return { nombre, precio, kg, sub };
      });
      const fee = (String(sol?.tipo_entrega||'')==='delivery') ? Number(sol?.delivery_fee||0) : 0;
      const banda = String(sol?.clasificacion_distancia||'');
      const usuarioNeto = (fee>0) ? (total - fee) : total;
      const html = [
        `<div class='row' style='justify-content:space-between; margin-bottom:8px;'>`,
          `<div><span class='muted'>Empresa</span> <strong>${emp?.nombre || ('Empresa '+empresaId)}</strong>${banda? ` · <span class='badge'>${banda}</span>`:''}</div>`,
          `<div class='right'><span class='muted'>Total estimado</span> <strong>S/ ${total.toFixed(2)}</strong></div>`,
        `</div>`,
        `<table style=\"width:100%; border-collapse:collapse;\">`,
        `<thead><tr><th style='text-align:left'>Material</th><th style='text-align:right'>Precio/kg (S/)</th><th style='text-align:right'>Kg</th><th style='text-align:right'>Subtotal (S/)</th></tr></thead>`,
        `<tbody>`,
        ...rows.map(r=>`<tr><td style='padding:6px'>${r.nombre}</td><td style='padding:6px; text-align:right'>${r.precio.toFixed(2)}</td><td style='padding:6px; text-align:right'>${r.kg.toFixed(2)}</td><td style='padding:6px; text-align:right'>${r.sub.toFixed(2)}</td></tr>`),
        `</tbody>`,
        `</table>`,
        (fee>0 ? `<div class='right' style='margin-top:8px;'>Delivery: <strong>S/ ${fee.toFixed(2)}</strong></div>` : ``),
        (fee>0 ? `<div class='right' style='margin-top:6px;'>Neto para ti: <strong>S/ ${usuarioNeto.toFixed(2)}</strong></div>` : ``)
      ].join('');
      document.getElementById('solicitud-detalle').innerHTML = html;
      document.getElementById('solicitud-modal').hidden = false;
    }
    let histGastosMode = false;
    async function loadHistorial(){
      const r = await fetch(`/api/usuarios/${user.id}/historial`, { headers: authHeaders() });
      const list = await r.json();
      const ul = document.getElementById('hist-list');
      ul.innerHTML = '';
      list.forEach(t=>{
        const li = document.createElement('li');
        li.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>Transacción #${t.id}</strong> con ${t.empresa_nombre||t.empresa_id}</div>
            <div class="muted">Monto: S/${Number(t.monto_pagado).toFixed(2)} · Puntos: ${t.puntos_obtenidos} · Estado: ${t.estado}</div>
          </div>
          <div class="right"><span class="badge">${new Date(t.fecha).toLocaleString()}</span> <button class="btn" onclick="verDetalleTx(${t.id})">Ver detalle</button> ${role==='usuario' ? `<button class=\"btn secondary\" id=\"rate-emp-${t.id}\" onclick=\"openRating('empresa', ${t.id}, ${t.empresa_id}, null)\">Calificar empresa</button>` : ''}</div>
        </div>`;
        ul.appendChild(li);
        setTimeout(()=>updateRatingButtonsForTx(t.id),0);
      });
    }
    async function loadHistorialGastos(){
      const ul = document.getElementById('hist-list');
      ul.innerHTML = '';
      const gastos = await (await fetch(`/api/usuarios/${user.id}/puntos/gastos`, { headers: authHeaders() })).json();
      const rewards = await (await fetch('/api/usuarios/recompensas', { headers: authHeaders() })).json();
      const names = new Map(rewards.map((r)=> [String(r.key), String(r.nombre)]));
      gastos.forEach(g=>{
        const li = document.createElement('li');
        const nombre = names.get(String(g.reward_key)) || String(g.reward_key);
        li.innerHTML = `<div class=\"row\" style=\"justify-content:space-between;\">\n          <div>\n            <div><strong>${nombre}</strong></div>\n            <div class=\"muted\">Gasto de puntos: ${Number(g.puntos)} · ${new Date(g.creado_en).toLocaleString()}</div>\n          </div>\n        </div>`;
        ul.appendChild(li);
      });
      document.getElementById('hist-detalle').style.display = 'none';
    }
    function initHistorialUI(){
      const refresh = document.getElementById('hist-refresh');
      const toggle = document.getElementById('hist-toggle');
      if (refresh) refresh.onclick = ()=>{ if (histGastosMode) loadHistorialGastos(); else loadHistorial(); };
      if (toggle) toggle.onclick = ()=>{
        histGastosMode = !histGastosMode;
        document.getElementById('hist-title').textContent = histGastosMode ? 'Gasto de Puntos' : 'Historial de Transacciones';
        toggle.textContent = histGastosMode ? 'Transacciones de Empresas' : 'Gasto de Puntos';
        if (histGastosMode) loadHistorialGastos(); else loadHistorial();
      };
    }
    async function loadHistorialEmpresa(){
      const r = await fetch(`/api/empresas/${user.id}/historial`, { headers: authHeaders() });
      const list = await r.json();
      const ul = document.getElementById('hist-list');
      ul.innerHTML = '';
      list.forEach(t=>{
        const li = document.createElement('li');
        li.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>Transacción #${t.id}</strong></div>
            <div class="muted">Monto: S/${Number(t.monto_pagado).toFixed(2)} · Puntos: ${t.puntos_obtenidos} · Estado: ${t.estado}</div>
          </div>
          <div class="right"><span class="badge">${new Date(t.fecha).toLocaleString()}</span> <button class="btn" onclick="verDetalleTx(${t.id})">Ver detalle</button> <button class="btn secondary" id="rate-usr-${t.id}" onclick="openRating('usuario', ${t.id}, null, ${t.usuario_id})">Calificar usuario</button></div>
        </div>`;
        ul.appendChild(li);
        setTimeout(()=>updateRatingButtonsForTx(t.id),0);
      });
    }
    async function verDetalleTx(id){
      if (document.getElementById('view-historial').hidden) setView('historial');
      const panel = document.getElementById('hist-detalle');
      if (panel && panel.style.display !== 'none' && histDetalleId === id){
        panel.style.display = 'none';
        histDetalleId = null;
        return;
      }
      const r = await fetch(`/api/transacciones/${id}`, { headers: authHeaders() });
      const j = await r.json();
      const filas = j.detalle.map(d=> `<tr><td>${d.nombre}</td><td style=\"text-align:right\">${Number(d.precio_por_kg).toFixed(2)}</td><td style=\"text-align:right\">${Number(d.kg_finales).toFixed(2)}</td><td style=\"text-align:right\">${Number(d.subtotal).toFixed(2)}</td></tr>`).join('');
      const footer = role === 'usuario'
        ? `<div class=\"right\" style=\"margin-top:10px\">Total: <strong>S/ ${Number(j.total).toFixed(2)}</strong>${Number(j.delivery_fee||0)>0 ? ` · Delivery: <strong>S/ ${Number(j.delivery_fee||0).toFixed(2)}</strong> · Neto: <strong>S/ ${Number(j.usuario_neto||j.total).toFixed(2)}</strong>` : ''}</div>`
        : `<div class=\"right\" style=\"margin-top:10px\">Total: <strong>S/ ${Number(j.total).toFixed(2)}</strong> · Comisión 10%: <strong>S/ ${Number(j.comision_10).toFixed(2)}</strong> · Total con comisión: <strong>S/ ${Number(j.total_con_comision).toFixed(2)}</strong></div>`;
      panel.innerHTML = `
        <h3>Detalle Transacción #${j.transaccion.id} · ${j.transaccion.empresa_nombre}</h3>
        <table style=\"width:100%; border-collapse:collapse\"><thead><tr><th>Material</th><th style=\"text-align:right\">Precio/kg</th><th style=\"text-align:right\">Kg</th><th style=\"text-align:right\">Subtotal</th></tr></thead><tbody>${filas}</tbody></table>
        ${footer}
        <div class=\"muted\">Puntos obtenidos: ${j.transaccion.puntos_obtenidos}</div>
      `;
      panel.style.display = 'block';
      histDetalleId = id;
    }
    async function loadHistorialRecolector(){
      const r = await fetch(`/api/recolector/${user.id}/historial`, { headers: authHeaders() });
      const list = await r.json();
      const ul = document.getElementById('hist-list');
      ul.innerHTML = '';
      const total = list.reduce((a, s)=> a + Number(s.delivery_fee||0), 0);
      const he = document.getElementById('hist-earnings');
      if (he) he.textContent = 'Ganancia total: S/ ' + total.toFixed(2);
      list.forEach(s=>{
        const li = document.createElement('li');
        const banda = String(s.clasificacion_distancia||'').toLowerCase();
        li.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>Trabajo #${s.id}</strong> · Gana: <strong>S/ ${Number(s.delivery_fee||0).toFixed(2)}</strong></div>
            <div class="muted">Usuario #${s.usuario_id} · Empresa ${s.empresa_nombre||s.empresa_id} · Viaje: ${banda||'—'}</div>
          </div>
          <div class="right"><span class="badge">${new Date(s.creado_en).toLocaleString()}</span> <button class="btn" onclick="verDetalleTrabajo(${s.id})">Detalles</button></div>
        </div>`;
        ul.appendChild(li);
      });
      const panel = document.getElementById('hist-detalle');
      if (panel) panel.style.display = 'none';
    }
    async function verDetalleTrabajo(sid){
      if (document.getElementById('view-historial').hidden) setView('historial');
      const panel = document.getElementById('hist-detalle');
      if (panel && panel.style.display !== 'none' && histDetalleId === sid){
        panel.style.display = 'none';
        histDetalleId = null;
        return;
      }
      const r = await fetch(`/api/recolector/trabajos/${sid}/detalle`, { headers: authHeaders() });
      const j = await r.json();
      const filas = (j.materiales||[]).map(d=> `<tr><td>${d.nombre}</td><td style=\"text-align:right\">${Number(d.kg_finales).toFixed(2)}</td></tr>`).join('');
      const distRU = (j.dist_recolector_usuario_km!=null) ? `${Number(j.dist_recolector_usuario_km).toFixed(2)} km` : '—';
      const distUE = (j.dist_usuario_empresa_km!=null) ? `${Number(j.dist_usuario_empresa_km).toFixed(2)} km` : '—';
      panel.innerHTML = `
        <h3>Detalle Trabajo #${sid}</h3>
        <table style=\"width:100%; border-collapse:collapse\"><thead><tr><th>Material</th><th style=\"text-align:right\">Kg finales</th></tr></thead><tbody>${filas}</tbody></table>
        <div class=\"right\" style=\"margin-top:10px\">Total kg: <strong>${Number(j.total_kg||0).toFixed(2)}</strong> · Viaje: <span class=\"badge\">${j.clasificacion||'—'}</span></div>
        <div class=\"right\" style=\"margin-top:6px\">Recolector → Usuario: <strong>${distRU}</strong> · Usuario → Empresa: <strong>${distUE}</strong></div>
      `;
      panel.style.display = 'block';
      histDetalleId = sid;
    }
    let ratingCtx = { tipo:null, txId:null, empresaId:null, usuarioId:null };
    function openRating(tipo, txId, empresaId, usuarioId){
      ratingCtx = { tipo, txId, empresaId, usuarioId };
      document.getElementById('rating-title').textContent = tipo==='empresa' ? 'Calificar empresa' : 'Calificar usuario';
      document.getElementById('rating-score').value = '5';
      document.getElementById('rating-msg').value = '';
      document.getElementById('rating-modal').hidden = false;
    }
    function closeRating(){ document.getElementById('rating-modal').hidden = true; }
    async function updateRatingButtonsForTx(txId){
      const det = await (await fetch(`/api/transacciones/${txId}`, { headers: authHeaders() })).json();
      const yaEmp = det?.ya_resena_empresa;
      const yaUsr = det?.ya_resena_usuario;
      const b1 = document.getElementById('rate-emp-'+txId);
      const b2 = document.getElementById('rate-usr-'+txId);
      if (b1 && yaEmp) b1.style.display = 'none';
      if (b2 && yaUsr) b2.style.display = 'none';
    }
    async function submitRating(){
      const puntaje = Number(document.getElementById('rating-score').value);
      const mensaje = document.getElementById('rating-msg').value;
      if (!puntaje || puntaje < 1 || puntaje > 5) { alert('Puntaje inválido'); return; }
      if (ratingCtx.tipo === 'empresa'){
        const r = await fetch('/api/resenas/empresa', { method:'POST', headers: authHeaders(), body: JSON.stringify({ empresa_id: ratingCtx.empresaId, usuario_id: user.id, transaccion_id: ratingCtx.txId, puntaje, mensaje }) });
        await r.json();
        alert('Reseña enviada');
        const btn = document.getElementById('rate-emp-'+ratingCtx.txId);
        if (btn) btn.style.display = 'none';
      } else {
        let usuarioId = ratingCtx.usuarioId;
        if (!usuarioId){
          const det = await (await fetch(`/api/transacciones/${ratingCtx.txId}`, { headers: authHeaders() })).json();
          usuarioId = det?.transaccion?.usuario_id;
        }
        if (!usuarioId) { alert('No se pudo identificar al usuario'); return; }
        const r = await fetch('/api/resenas/usuario', { method:'POST', headers: authHeaders(), body: JSON.stringify({ usuario_id: usuarioId, empresa_id: user.id, transaccion_id: ratingCtx.txId, puntaje, mensaje }) });
        await r.json();
        alert('Reseña enviada');
        const btn = document.getElementById('rate-usr-'+ratingCtx.txId);
        if (btn) btn.style.display = 'none';
      }
      closeRating();
    }
    async function loadHistorialEmpresa(){
      const r = await fetch(`/api/empresas/${user.id}/historial`, { headers: authHeaders() });
      const list = await r.json();
      const ul = document.getElementById('hist-list');
      ul.innerHTML = '';
      list.forEach(t=>{
        const li = document.createElement('li');
        li.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>Transacción #${t.id}</strong></div>
            <div class="muted">Monto: S/${Number(t.monto_pagado).toFixed(2)} · Puntos: ${t.puntos_obtenidos} · Estado: ${t.estado}</div>
          </div>
          <div class="right"><span class="badge">${new Date(t.fecha).toLocaleString()}</span> <button class="btn" onclick="verDetalleTx(${t.id})">Ver detalle</button> <button class="btn secondary" id="rate-usr-${t.id}" onclick="openRating('usuario', ${t.id}, null, ${t.usuario_id})">Calificar usuario</button></div>
        </div>`;
        ul.appendChild(li);
        setTimeout(()=>updateRatingButtonsForTx(t.id),0);
      });
    }
    async function loadSolicitudesEmpresa(){
      const r = await fetch(`/api/empresas/${user.id}/solicitudes`, { headers: authHeaders() });
      const list = await r.json();
      const ul = document.getElementById('emp-sol-list');
      ul.innerHTML = '';
      list.forEach(s=>{
        const li = document.createElement('li');
        li.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>Solicitud #${s.id}</strong> del usuario ${s.usuario_id}</div>
            <div class="muted">Estado: ${displayEstadoSolicitud(s.estado)} · ${new Date(s.creado_en).toLocaleString()}</div>
          </div>
          <div class="right">
            <button class="btn secondary" onclick="openAceptar(${s.id}, ${s.usuario_id})">Aceptar</button>
            <button class="btn" onclick="empresaRechazar(${s.id})">Rechazar</button>
            <button class="btn" onclick="empresaPesaje(${s.id}, ${s.usuario_id})">Pesaje</button>
          </div>
        </div>`;
        ul.appendChild(li);
      });
    }
    async function loadRewards(){
      document.getElementById('rewards-puntos').textContent = 'Puntos: ' + Number(user.puntos_acumulados||0);
      const ul = document.getElementById('rewards-list');
      ul.innerHTML = '';
      const r = await fetch('/api/usuarios/recompensas', { headers: authHeaders() });
      const list = await r.json();
      list.forEach(it=>{
        const li = document.createElement('li');
        const puede = Number(user.puntos_acumulados||0) >= Number(it.costo);
        li.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>${it.nombre}</strong></div>
            <div class="muted">Costo: ${it.costo} puntos</div>
          </div>
          <div class="right"><button class="btn" ${puede? '' : 'disabled'} onclick="redeemReward('${it.key}', ${it.costo})">Canjear</button></div>
        </div>`;
        ul.appendChild(li);
      });
    }
    async function redeemReward(key, costo){
      const r = await fetch(`/api/usuarios/${user.id}/recompensas/redimir`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ reward_key: key }) });
      const j = await r.json();
      if (j?.error==='insufficient_points') { alert('No tienes puntos suficientes'); return; }
      alert('Canje realizado');
      user.puntos_acumulados = Number(j.nuevo_puntos||user.puntos_acumulados);
      loadRewards();
      if (document.getElementById('view-perfil') && document.getElementById('view-perfil').hidden===false) loadPerfil();
    }
    async function loadResenasEmpresa(){
      const ul = document.getElementById('resenas-list');
      ul.innerHTML = '';
      const r = await fetch(`/api/resenas/empresa/${user.id}`, { headers: authHeaders() });
      const list = await r.json();
      list.forEach(re=>{
        const li = document.createElement('li');
        li.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>Puntaje ${Number(re.puntaje)}</strong> · Tx #${re.transaccion_id} · ${re.usuario_email||('Usuario '+re.usuario_id)}</div>
            <div class="muted">${re.mensaje || '—'}</div>
          </div>
          <div class="right"><span class="badge">${new Date(re.creado_en).toLocaleString()}</span> <button class="btn" onclick="verDetalleTx(${re.transaccion_id})">Ver transacción</button></div>
        </div>`;
        ul.appendChild(li);
      });
    }
    async function empresaAceptar(sid){
      await fetch(`/api/empresas/${user.id}/solicitudes/${sid}/aceptar`, { method:'POST', headers: authHeaders() });
      loadSolicitudesEmpresa();
    }
    async function empresaRechazar(sid){
      await fetch(`/api/empresas/${user.id}/solicitudes/${sid}/rechazar`, { method:'POST', headers: authHeaders() });
      loadSolicitudesEmpresa();
    }

    let aceptarCtx = { sid: null, usuario_id: null };
    function closeAceptar(){ document.getElementById('aceptar-modal').hidden = true; aceptarCtx = { sid:null, usuario_id:null }; }
  async function openAceptar(sid, usuarioId){
    aceptarCtx = { sid, usuario_id: usuarioId };
    const sol = await (await fetch(`/api/solicitudes/${sid}`, { headers: authHeaders() })).json();
    const mats = await (await fetch(`/api/empresas/${user.id}/materiales`, { headers: authHeaders() })).json();
    const precios = new Map(mats.map(m=> [Number(m.material_id), Number(m.precio_por_kg)]));
    const nombres = new Map(mats.map(m=> [Number(m.material_id), String(m.nombre)]));
    const items = Array.isArray(sol?.items_json) ? sol.items_json : [];
    let total = 0;
    const rows = items.map(it=>{
      const precio = precios.get(Number(it.material_id)) || 0;
      const kg = Number(it.kg)||0;
      const sub = precio * kg;
      total += sub;
      return { material_id: Number(it.material_id), nombre: (nombres.get(Number(it.material_id)) || ('#'+Number(it.material_id))), kg, precio, sub };
    });
    const detalle = document.getElementById('aceptar-detalle');
    const html = [`<table style=\"width:100%; border-collapse:collapse;\">`,
      `<thead><tr><th style='text-align:left'>Material</th><th style='text-align:right'>Precio/kg</th><th style='text-align:right'>Kg</th><th style='text-align:right'>Subtotal</th></tr></thead>`,
      `<tbody>`,
      ...rows.map(r=>`<tr><td style='padding:6px'>${r.nombre}</td><td style='padding:6px; text-align:right'>${r.precio.toFixed(2)}</td><td style='padding:6px; text-align:right'>${r.kg.toFixed(2)}</td><td style='padding:6px; text-align:right'>${r.sub.toFixed(2)}</td></tr>`),
      `</tbody>`,
      `</table>`,
      `<div class='right' style='margin-top:10px;'>Total estimado: <strong>S/ ${total.toFixed(2)}</strong></div>`
    ].join('');
    detalle.innerHTML = html;
    const btnGo = document.getElementById('btn-aceptar-go');
    const btnPes = document.getElementById('btn-aceptar-pesaje');
    const chk = document.getElementById('aceptar-agree');
    const feeBox = document.getElementById('aceptar-fee-box');
    const feeEl = document.getElementById('aceptar-fee');
    const netEl = document.getElementById('aceptar-net');
    btnGo.disabled = true;
    if (chk) chk.checked = false;
    if (feeBox) feeBox.hidden = true;
    if (feeEl) feeEl.textContent = 'S/ 0.00';
    if (netEl) netEl.textContent = 'S/ 0.00';
    btnGo.onclick = async ()=>{ await empresaAceptar(sid); closeAceptar(); };
    btnPes.onclick = ()=>{ closeAceptar(); empresaPesaje(sid, usuarioId); };
    chk.onchange = ()=>{
      const ok = chk.checked;
      btnGo.disabled = !ok;
      feeBox.hidden = !ok;
      if (ok){
        const fee = total * 0.10;
        const net = total + fee;
        if (feeEl) feeEl.textContent = 'S/ ' + fee.toFixed(2);
        if (netEl) netEl.textContent = 'S/ ' + net.toFixed(2);
      }
    };
    document.getElementById('aceptar-modal').hidden = false;
  }
    async function empresaPesaje(sid, usuarioId){
      solicitudSeleccionada = { id: sid, usuario_id: usuarioId };
      const mats = await (await fetch(`/api/empresas/${user.id}/materiales`, { headers: authHeaders() })).json();
      const sol = await (await fetch(`/api/solicitudes/${sid}`, { headers: authHeaders() })).json();
      const items = Array.isArray(sol?.items_json) ? sol.items_json : [];
      const kgByMat = new Map(items.map((it)=> [Number(it.material_id), Number(it.kg)]));
      materialesSeleccionados = mats.map(m=>({ material_id: m.material_id, nombre: m.nombre, precio: Number(m.precio_por_kg), kg: kgByMat.get(Number(m.material_id)) || 0 }));
      renderPesaje();
      setView('pesaje');
    }
    function renderPesaje(){
      document.getElementById('pesaje-titulo').textContent = 'Pesaje solicitud #' + (solicitudSeleccionada?.id || '');
      document.getElementById('pesaje-meta').textContent = 'Usuario ' + (solicitudSeleccionada?.usuario_id || '');
      const tbody = document.getElementById('pesaje-body');
      tbody.innerHTML = '';
      materialesSeleccionados.forEach((m, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style=\"padding:8px;\">${m.nombre}</td>
          <td style=\"padding:8px; text-align:right;\">${m.precio.toFixed(2)}</td>
          <td style=\"padding:8px; text-align:right;\"><input type=\"number\" min=\"0\" step=\"0.1\" value=\"${m.kg}\" style=\"width:120px;\" data-idx=\"${idx}\" /></td>
          <td style=\"padding:8px; text-align:right;\" id=\"p-sub-${idx}\">0.00</td>
        `;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('input[type=\"number\"]').forEach(inp=>{
        inp.addEventListener('input', (ev)=>{
          const i = Number(ev.target.getAttribute('data-idx'));
          const val = Number(ev.target.value);
          materialesSeleccionados[i].kg = isNaN(val) ? 0 : val;
          actualizarPesajeTotal();
        });
      });
      actualizarPesajeTotal();
      const chk = document.getElementById('pesaje-agree');
      const btn = document.getElementById('btn-pesaje-confirm');
      if (chk) chk.checked = false;
      if (btn) btn.disabled = true;
      if (chk) chk.onchange = ()=>{ if (btn) btn.disabled = !chk.checked; };
    }
    function actualizarPesajeTotal(){
      let total = 0;
      materialesSeleccionados.forEach((m, idx)=>{
        const sub = m.kg * m.precio;
        total += sub;
        const el = document.getElementById('p-sub-'+idx);
        if (el) el.textContent = sub.toFixed(2);
      });
      const totalEl = document.getElementById('pesaje-total');
      const feeEl = document.getElementById('pesaje-fee');
      const netEl = document.getElementById('pesaje-net');
      const fee = total * 0.10;
      const net = total + fee;
      if (totalEl) totalEl.textContent = 'S/ ' + total.toFixed(2);
      if (feeEl) feeEl.textContent = 'S/ ' + fee.toFixed(2);
      if (netEl) netEl.textContent = 'S/ ' + net.toFixed(2);
    }
    function cancelarPesaje(){ setView('empresa_solicitudes'); }
    async function confirmarPesaje(){
      const metodo = document.getElementById('metodo-pago').value;
      const payload = {
        usuario_id: solicitudSeleccionada.usuario_id,
        metodo_pago: metodo,
        lat: null,
        lon: null,
        pesajes: materialesSeleccionados.filter(m=> (m.kg||0) > 0).map(m=> ({ material_id: m.material_id, kg_finales: m.kg }))
      };
      const r = await fetch(`/api/empresas/${user.id}/solicitudes/${solicitudSeleccionada.id}/pesaje_pago`, { method:'POST', headers: authHeaders(), body: JSON.stringify(payload) });
      const j = await r.json();
      alert('Transacción registrada: #'+j.id+' · Monto S/ '+Number(j.monto_pagado).toFixed(2));
      setView('empresa_solicitudes');
      loadSolicitudesEmpresa();
    }
    async function loadPerfil(){
      if (role === 'empresa'){
        const p = {
          id: user.id,
          ruc: user.ruc,
          nombre: user.nombre,
          reputacion: user.reputacion_promedio,
          reseñas: user.resenas_recibidas_count
        };
        document.getElementById('perfil').textContent = JSON.stringify(p,null,2);
        document.getElementById('perfil-materiales').hidden = false;
        const cat = await (await fetch('/api/materiales', { headers: authHeaders() })).json();
        perfilCatalogo = cat.map((m)=>({ id: Number(m.id||m.material_id||m.id_material||m), nombre: m.nombre||String(m.nombre||m), precio_base_por_kg: Number(m.precio_base_por_kg||0) }));
        const mats = await (await fetch(`/api/empresas/${user.id}/materiales`, { headers: authHeaders() })).json();
        perfilMateriales = mats.map(m=>({ material_id: Number(m.material_id), nombre: m.nombre, precio_por_kg: Number(m.precio_por_kg) }));
        renderPerfilMateriales();
      } else {
        const st = await (await fetch(`/api/usuarios/${user.id}/stats`, { headers: authHeaders() })).json();
        const puntos = Number(user.puntos_acumulados||0);
        const kg = Number(user.kg_totales||0);
        const rep = Number(user.reputacion_promedio||0);
        const resenas = Number(user.resenas_recibidas_count||0);
        const monto = Number(st?.monto_total||0);
        document.getElementById('perfil').innerHTML = `
          <div class="stats-grid">
            <div class="stat-card"><div class="stat-title">Puntos</div><div class="stat-value">${puntos}</div></div>
            <div class="stat-card"><div class="stat-title">Kg totales</div><div class="stat-value">${kg.toFixed(2)}</div></div>
            <div class="stat-card"><div class="stat-title">Monto ganado (S/)</div><div class="stat-value">${monto.toFixed(2)}</div></div>
            <div class="stat-card"><div class="stat-title">Reputación</div><div class="stat-value">${rep.toFixed(2)}</div></div>
            <div class="stat-card"><div class="stat-title">Reseñas</div><div class="stat-value">${resenas}</div></div>
          </div>
        `;
        document.getElementById('perfil-materiales').hidden = true;
      }
    }

    function renderPerfilMateriales(){
      const tbody = document.getElementById('perfil-materiales-body');
      tbody.innerHTML = '';
      perfilMateriales.forEach(m=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:8px;">${m.nombre}</td>
          <td style="padding:8px; text-align:right;"><input type="number" step="0.01" value="${m.precio_por_kg.toFixed(2)}" style="width:120px;" data-mid="${m.material_id}" /></td>
          <td style="padding:8px; text-align:right;"><button class="btn" onclick="perfilRemoveMaterial(${m.material_id})">Quitar</button></td>
        `;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('input[data-mid]').forEach(inp=>{
        inp.addEventListener('input', (ev)=>{
          const mid = Number(ev.target.getAttribute('data-mid'));
          const val = Number(ev.target.value);
          const idx = perfilMateriales.findIndex(x=>x.material_id===mid);
          if (idx>=0) perfilMateriales[idx].precio_por_kg = isNaN(val) ? 0 : val;
        });
      });
      const sel = document.getElementById('perfil-add-select');
      sel.innerHTML = '';
      const ya = new Set(perfilMateriales.map(m=>m.material_id));
      perfilCatalogo.filter(c=>!ya.has(c.id)).forEach(c=>{
        const opt = document.createElement('option');
        opt.value = String(c.id);
        opt.textContent = c.nombre;
        sel.appendChild(opt);
      });
      const precioInp = document.getElementById('perfil-add-precio');
      sel.onchange = (ev)=>{
        const mid = Number(sel.value);
        const c = perfilCatalogo.find(x=>x.id===mid);
        if (c && precioInp) precioInp.value = (Number(c.precio_base_por_kg)||0).toFixed(2);
      };
      if (sel.options.length>0){
        const firstId = Number(sel.options[0].value);
        const c0 = perfilCatalogo.find(x=>x.id===firstId);
        if (c0 && precioInp) precioInp.value = (Number(c0.precio_base_por_kg)||0).toFixed(2);
      }
    }

    async function perfilAddMaterial(){
      const sel = document.getElementById('perfil-add-select');
      const mid = Number(sel.value);
      let precio = Number(document.getElementById('perfil-add-precio').value);
      if (!mid) return;
      const c = perfilCatalogo.find(x=>x.id===mid);
      if (!c) return;
      if (perfilMateriales.some(x=>x.material_id===mid)) return;
      if (!precio || precio<=0 || isNaN(precio)) precio = Number(c.precio_base_por_kg)||0;
      perfilMateriales.push({ material_id: mid, nombre: c.nombre, precio_por_kg: precio });
      document.getElementById('perfil-add-precio').value = '';
      renderPerfilMateriales();
    }

    async function perfilRemoveMaterial(mid){
      await fetch(`/api/empresas/${user.id}/materiales/${mid}`, { method:'DELETE', headers: authHeaders() });
      perfilMateriales = perfilMateriales.filter(m=>m.material_id!==Number(mid));
      renderPerfilMateriales();
    }

    async function perfilSaveMaterials(){
      const items = perfilMateriales.map(m=>({ material_id: m.material_id, precio_por_kg: m.precio_por_kg }));
      const r = await fetch(`/api/empresas/${user.id}/materiales/upsert`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ items }) });
      await r.json();
      alert('Cambios guardados');
      const mats = await (await fetch(`/api/empresas/${user.id}/materiales`, { headers: authHeaders() })).json();
      perfilMateriales = mats.map(m=>({ material_id: Number(m.material_id), nombre: m.nombre, precio_por_kg: Number(m.precio_por_kg) }));
      renderPerfilMateriales();
    }

    if (role === 'empresa') {
      document.getElementById('m-empresas').style.display = 'none';
      document.getElementById('m-solicitudes').textContent = 'Solicitudes Entrantes';
      document.getElementById('m-solicitudes').setAttribute('onclick', "setView('empresa_solicitudes')");
      document.getElementById('m-resenas').style.display = '';
      document.getElementById('m-rewards').style.display = 'none';
      setView('empresa_solicitudes');
    } else if (role === 'recolector') {
      document.getElementById('m-empresas').style.display = 'none';
      document.getElementById('m-resenas').style.display = 'none';
      document.getElementById('m-rewards').style.display = 'none';
      document.getElementById('m-solicitudes').textContent = 'Solicitudes Disponibles';
      setView('solicitudes');
    } else {
      document.getElementById('m-resenas').style.display = 'none';
      document.getElementById('m-rewards').style.display = '';
      setView('empresas');
    }
  </script>
</body>
<!-- Tu HTML termina aquí -->
</html>

<script>
  let mapaInit = false;
  let mapa = null;
  let selfMarker = null;
  let geoAccuracy = null;
  let distritosData = null;
  let distritoLayer = null;
  let distritoActual = null;
  let empresasList = [];
  let highlightLayer = null;
  let materialCatalog = [];

  function distanciaMetros(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) ** 2;

    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  async function initMapa() {
    mapaInit = true;

    let center = [-12.05, -77.03];

    try {
      await new Promise((resolve) => {
        if (!navigator.geolocation) return resolve(null);

        navigator.geolocation.getCurrentPosition(
          pos => {
            center = [pos.coords.latitude, pos.coords.longitude];
            resolve(null);
          },
          () => resolve(null),
          { enableHighAccuracy: true, timeout: 3000 }
        );
      });
    } catch {}

    // Inicializar mapa
    mapa = L.map("map").setView(center, 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(mapa);

    selfMarker = L.circleMarker(center, {
      radius: 8,
      color: '#3ac27f',
      weight: 2,
      fillColor: '#38c1b3',
      fillOpacity: 0.9
    }).addTo(mapa);
    selfMarker.bindPopup('Tu ubicación');

    const dbtn = document.getElementById('distrito-btn');
    if (dbtn) dbtn.onclick = verDistrito;
    if (document.getElementById('buscar-btn')) document.getElementById('buscar-btn').onclick = obtenerUbicacion;
    obtenerUbicacion();
    if (document.getElementById('addr-btn')) document.getElementById('addr-btn').onclick = geocodeAddress;
    if (mapa) mapa.on('click', (e)=> updateSelf(e.latlng.lat, e.latlng.lng));

    // Obtener empresas
    const r = await fetch("/api/empresas", { headers: authHeaders() });
    const list = await r.json();
    empresasList = list.map((e)=>({ ...e }));

    empresasList.forEach(e => {
      const lat = parseFloat(e.lat);
      const lon = parseFloat(e.lon);
      if (isNaN(lat) || isNaN(lon)) return;

      const d = distanciaMetros(center[0], center[1], lat, lon);

      const marker = L.marker([lat, lon]).addTo(mapa);

      // Materiales
      const mat =
        (e.materiales || [])
          .map(m => `#${m.material_id} S/${m.precio_por_kg}`)
          .join(", ") || "Materiales no listados";

      // Escape seguro para popup
      const safeNombre = e.nombre.replace(/'/g, "\\'");
      const safeRuc = String(e.ruc).replace(/'/g, "\\'");
      const reputacion = Number(e.reputacion_promedio) || 0;

      const popupHTML = `
        <strong>${e.nombre}</strong>
        <div>RUC ${e.ruc}</div>
        <div>Distancia ${(d / 1000).toFixed(2)} km</div>
        <div class="muted">${mat}</div>
        <div style="margin-top:8px; text-align:right;">
          <button class="btn secondary"
            onclick="verEmpresa(${e.id}, '${safeNombre}', '${safeRuc}', ${reputacion})">
            Ver
          </button>
        </div>
      `;

      marker.bindPopup(popupHTML);
    });

    const aplicarBtn = document.getElementById('aplicar-filtro');
    if (aplicarBtn) aplicarBtn.onclick = aplicarFiltroMapa;
    const quitarBtn = document.getElementById('quitar-filtro');
    if (quitarBtn) quitarBtn.onclick = quitarFiltroMapa;
    const filtroSel = document.getElementById('map-filtro');
    if (filtroSel) filtroSel.onchange = onFiltroChange;

    try{
      const mr = await fetch('/api/materiales', { headers: authHeaders() });
      materialCatalog = await mr.json();
      const msel = document.getElementById('map-material');
      if (msel){
        msel.innerHTML='';
        materialCatalog.forEach((m)=>{
          const opt = document.createElement('option');
          opt.value = String(m.id);
          opt.textContent = m.nombre;
          msel.appendChild(opt);
        });
      }
    }catch{}
  }
  function updateSelf(lat, lon){
    center = [lat, lon];
    if (selfMarker) selfMarker.setLatLng(center);
    if (mapa) mapa.panTo(center);
    updateAccBadge();
    updateDistritoBadge();
  }
  async function usarIP(){
    try{
      const r = await fetch("https://ipapi.co/json/");
      const d = await r.json();
      if (d && typeof d.latitude === 'number' && typeof d.longitude === 'number') updateSelf(d.latitude, d.longitude);
      geoAccuracy = null;
      updateAccBadge();
    }catch{}
  }
  function obtenerUbicacion(){
    if (navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        p=>{ geoAccuracy = Number(p.coords.accuracy)||null; updateSelf(p.coords.latitude, p.coords.longitude); },
        _=>usarIP(),
        { enableHighAccuracy:true, timeout:8000 }
      );
    } else {
      usarIP();
    }
  }
  function updateAccBadge(){
    const b = document.getElementById('acc-badge');
    if (!b) return;
    if (geoAccuracy!=null) b.textContent = 'Precisión ~'+Math.round(geoAccuracy)+' m';
    else b.textContent = 'Precisión aprox.';
  }
  async function updateDistritoBadge(){
    const bd = document.getElementById('dist-badge');
    if (!bd || !selfMarker) return;
    const ll = selfMarker.getLatLng();
    if (!distritosData){
      try{
        const r = await fetch('/data/lima_callao_distritos.geojson');
        distritosData = await r.json();
      }catch{
        bd.textContent = 'Distrito —';
        return;
      }
    }
    let nombre = null;
    const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
    for (const f of feats){
      if (contieneFeature(f, ll.lat, ll.lng)){
        const p = f.properties||{};
        nombre = p.nombre||p.name||p.NOMBREDIST||p.distrito||null;
        break;
      }
    }
    if (nombre){
      const t = String(nombre).trim();
      const display = /^lurigancho$/i.test(t) ? 'LURIGANCHO-CHOSICA' : t;
      bd.textContent = 'Distrito: '+display;
    } else {
      bd.textContent = 'Distrito —';
    }
  }

  async function populateDistritosSelect(){
    if (!distritosData){ try{ const r = await fetch('/data/lima_callao_distritos.geojson'); distritosData = await r.json(); }catch{ return; } }
    const sel = document.getElementById('map-filtro-distrito');
    if (!sel) return;
    sel.innerHTML = '';
    const names = [];
    const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
    feats.forEach(f=>{ const p = f.properties||{}; const n = p.nombre||p.name||p.NOMBREDIST||p.distrito||null; if (n) names.push(String(n)); });
    names.sort((a,b)=> a.localeCompare(b, 'es-PE'));
    names.forEach(n=>{ const opt = document.createElement('option'); opt.value = n; opt.textContent = n; sel.appendChild(opt); });
  }

  async function populateDistritosSelectTo(sel){
    if (!distritosData){ try{ const r = await fetch('/data/lima_callao_distritos.geojson'); distritosData = await r.json(); }catch{ return; } }
    if (!sel) return;
    sel.innerHTML = '';
    const names = [];
    const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
    feats.forEach(f=>{ const p = f.properties||{}; const n = p.nombre||p.name||p.NOMBREDIST||p.distrito||null; if (n) names.push(String(n)); });
    names.sort((a,b)=> a.localeCompare(b, 'es-PE'));
    names.forEach(n=>{ const opt = document.createElement('option'); opt.value = n; opt.textContent = n; sel.appendChild(opt); });
  }

  async function onFiltroChange(){
    const sel = document.getElementById('map-filtro');
    const distSel = document.getElementById('map-filtro-distrito');
    const out = document.getElementById('filtro-res');
    const msel = document.getElementById('map-material');
    const limitWrap = document.getElementById('limit-dist-wrap');
    const limitChk = document.getElementById('map-limit-distrito');
    const limitSel = document.getElementById('map-limit-distrito-sel');
    if (!sel || !distSel || !out) return;
    out.textContent = '';
    const v = String(sel.value);
    if (v==='empresas_count'){
      await populateDistritosSelect();
      distSel.style.display = '';
    } else {
      distSel.style.display = 'none';
      distSel.innerHTML = '';
    }
    if (v==='mejor_material'){
      if (msel) msel.style.display='';
      if (limitWrap) limitWrap.style.display='';
      if (limitChk && limitSel){
        limitChk.onchange = async ()=>{
          if (limitChk.checked){ await populateDistritosSelectTo(limitSel); limitSel.style.display=''; }
          else { limitSel.style.display='none'; limitSel.innerHTML=''; }
        };
      }
    } else {
      if (msel) msel.style.display='none';
      if (limitWrap) limitWrap.style.display='none';
      if (limitSel){ limitSel.style.display='none'; limitSel.innerHTML=''; }
      if (limitChk) limitChk.checked = false;
    }
  }

  function empresaDistrito(e){
    const lat = parseFloat(e.lat), lon = parseFloat(e.lon);
    if (isNaN(lat) || isNaN(lon)) return null;
    if (!distritosData) return null;
    const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
    for (const f of feats){ if (contieneFeature(f, lat, lon)) { const p = f.properties||{}; return (p.nombre||p.name||p.NOMBREDIST||p.distrito||null); } }
    return null;
  }

  function avgPrecioEmpresa(e){
    const arr = Array.isArray(e.materiales) ? e.materiales : [];
    if (arr.length===0) return 0;
    let s=0; for (const m of arr) s += Number(m.precio_por_kg)||0;
    return s/arr.length;
  }

  function clearHighlight(){ if (highlightLayer){ try{ mapa.removeLayer(highlightLayer); }catch{} highlightLayer=null; } }
  function highlightEmpresas(list){
    clearHighlight();
    highlightLayer = L.layerGroup();
    list.forEach(e=>{
      const lat = parseFloat(e.lat), lon = parseFloat(e.lon);
      if (isNaN(lat)||isNaN(lon)) return;
      const c = L.circleMarker([lat,lon], { radius:10, color:'#f59e0b', weight:3, fillColor:'#fde68a', fillOpacity:0.5 });
      c.addTo(highlightLayer);
    });
    highlightLayer.addTo(mapa);
  }

  async function aplicarFiltroMapa(){
    const sel = document.getElementById('map-filtro');
    const out = document.getElementById('filtro-res');
    const distSel = document.getElementById('map-filtro-distrito');
    const msel = document.getElementById('map-material');
    const limitChk = document.getElementById('map-limit-distrito');
    const limitSel = document.getElementById('map-limit-distrito-sel');
    if (!sel || !out) return;
    const v = String(sel.value);
    if (v==='none'){ out.textContent = 'Seleccione un filtro'; return; }
    if (!distritosData){ try{ const r = await fetch('/data/lima_callao_distritos.geojson'); distritosData = await r.json(); }catch{ out.textContent='No se pudo cargar distritos'; return; } }
    const current = distritoActual;
    let empresasDistrito = empresasList.filter(e=> empresaDistrito(e) === current);
    if (v==='mejor_material'){
      if (!msel || !msel.value){ out.textContent='Seleccione un material'; return; }
      const materialId = Number(msel.value);
      let pool = empresasList.slice();
      if (limitChk && limitSel && limitChk.checked && limitSel.value){
        const target = String(limitSel.value);
        pool = pool.filter(e=> empresaDistrito(e) === target);
      }
      let best = null; let bestPrecio = -1;
      for (const e of pool){
        const arr = Array.isArray(e.materiales) ? e.materiales : [];
        const item = arr.find((m)=> Number(m.material_id)===materialId);
        const precio = item ? Number(item.precio_por_kg) : -1;
        if (precio>bestPrecio){ bestPrecio=precio; best=e; }
      }
      clearHighlight();
      if (!best || bestPrecio<0){ out.textContent='Sin datos de precios para el material seleccionado'; return; }
      const lat = parseFloat(best.lat), lon = parseFloat(best.lon);
      if (!isNaN(lat)&&!isNaN(lon)){
        highlightLayer = L.layerGroup();
        const c = L.circleMarker([lat,lon], { radius:12, color:'#ef4444', weight:3, fillColor:'#fecaca', fillOpacity:0.6 });
        c.addTo(highlightLayer);
        highlightLayer.addTo(mapa);
        try{ mapa.panTo([lat,lon]); }catch{}
      }
      const matName = (materialCatalog.find((m)=> Number(m.id)===materialId)?.nombre) || ('#'+String(materialId));
      out.textContent = 'Mejor pago por '+matName+': '+best.nombre+' — S/ '+bestPrecio.toFixed(2);
      return;
    }
    if (v==='mas_cercana'){
      if (!selfMarker){ out.textContent='Ubicación no disponible'; return; }
      const ll = selfMarker.getLatLng();
      let best = null; let bestDist = Infinity;
      for (const e of empresasList){
        const lat = parseFloat(e.lat), lon = parseFloat(e.lon);
        if (isNaN(lat)||isNaN(lon)) continue;
        const d = distanciaMetros(ll.lat, ll.lng, lat, lon);
        if (d < bestDist){ bestDist = d; best = e; }
      }
      clearHighlight();
      if (!best || !isFinite(bestDist)){ out.textContent='No se encontró empresa cercana'; return; }
      const lat = parseFloat(best.lat), lon = parseFloat(best.lon);
      if (!isNaN(lat)&&!isNaN(lon)){
        highlightLayer = L.layerGroup();
        const c = L.circleMarker([lat,lon], { radius:12, color:'#0ea5e9', weight:3, fillColor:'#bae6fd', fillOpacity:0.6 });
        c.addTo(highlightLayer);
        highlightLayer.addTo(mapa);
        try{ mapa.panTo([lat,lon]); }catch{}
      }
      out.textContent = 'Empresa más cercana: '+best.nombre+' — '+(bestDist/1000).toFixed(2)+' km';
      return;
    }
    if (v==='top_pagan'){
      const sorted = empresasDistrito.slice().sort((a,b)=> avgPrecioEmpresa(b)-avgPrecioEmpresa(a));
      const top = sorted.slice(0, Math.min(5, sorted.length));
      highlightEmpresas(top);
      out.textContent = top.length ? ('Top pagadores ('+top.length+') en '+(current||'—')) : 'Sin empresas en distrito';
      return;
    }
    if (v==='empresas_count'){
      if (!distSel || !distSel.value){ out.textContent = 'Seleccione un distrito'; return; }
      const target = String(distSel.value);
      empresasDistrito = empresasList.filter(e=> empresaDistrito(e) === target);
      clearHighlight();
      const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
      let found = null;
      for (const f of feats){ const p = f.properties||{}; const name = p.nombre||p.name||p.NOMBREDIST||p.distrito||null; if (name===target){ found=f; break; } }
      if (found){
        if (distritoLayer){ try{ mapa.removeLayer(distritoLayer); }catch{} distritoLayer=null; }
        distritoLayer = L.geoJSON(found, { style: { color:'#22c55e', weight:3, fillColor:'#86efac', fillOpacity:0.2 } });
        distritoLayer.addTo(mapa);
        try{ mapa.fitBounds(distritoLayer.getBounds(), { padding:[20,20] }); }catch{}
      }
      out.textContent = 'Empresas registradas en '+target+': '+String(empresasDistrito.length);
      return;
    }
    if (v==='mas_tx'){
      try{
        const r = await fetch('/api/empresas/stats_distritos', { headers: authHeaders() });
        const stats = await r.json();
        const best = stats && stats[0] ? String(stats[0].distrito) : null;
        const bestCount = stats && stats[0] ? Number(stats[0].transacciones_count) : 0;
        if (!best){ out.textContent='Sin datos de transacciones'; clearHighlight(); return; }
        if (!distritosData){ const rr = await fetch('/data/lima_callao_distritos.geojson'); distritosData = await rr.json(); }
        const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
        let found = null;
        for (const f of feats){ const p = f.properties||{}; const name = p.nombre||p.name||p.NOMBREDIST||p.distrito||null; if (name===best){ found=f; break; } }
        clearHighlight();
        if (found){
          if (distritoLayer){ try{ mapa.removeLayer(distritoLayer); }catch{} distritoLayer=null; }
          distritoLayer = L.geoJSON(found, { style: { color:'#22c55e', weight:3, fillColor:'#86efac', fillOpacity:0.2 } });
          distritoLayer.addTo(mapa);
          try{ mapa.fitBounds(distritoLayer.getBounds(), { padding:[20,20] }); }catch{}
        }
        out.textContent = 'Distrito con más transacciones: '+best+' ('+String(bestCount)+')';
      }catch{ out.textContent='No se pudo cargar estadísticas'; }
      return;
    }
    if (v==='mejor_distrito'){
      const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
      const byDist = new Map();
      empresasList.forEach(e=>{
        const d = empresaDistrito(e);
        if (!d) return;
        const arr = byDist.get(d)||[];
        arr.push(Number(e.reputacion_promedio)||0);
        byDist.set(d, arr);
      });
      let best = null; let bestAvg = -1;
      for (const [d, arr] of byDist.entries()){
        const avg = arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0;
        if (avg>bestAvg){ bestAvg=avg; best=d; }
      }
      if (!best){ out.textContent='Sin datos de reputación'; clearHighlight(); return; }
      let found = null;
      for (const f of feats){ const p = f.properties||{}; const name = p.nombre||p.name||p.NOMBREDIST||p.distrito||null; if (name===best){ found=f; break; } }
      if (!found){ out.textContent='Distrito no encontrado'; clearHighlight(); return; }
      if (distritoLayer){ try{ mapa.removeLayer(distritoLayer); }catch{} distritoLayer=null; }
      distritoLayer = L.geoJSON(found, { style: { color:'#22c55e', weight:3, fillColor:'#86efac', fillOpacity:0.2 } });
      distritoLayer.addTo(mapa);
      try{ mapa.fitBounds(distritoLayer.getBounds(), { padding:[20,20] }); }catch{}
      out.textContent = 'Mejor distrito por reputación: '+best+' (avg '+bestAvg.toFixed(2)+')';
      return;
    }
  }

  function quitarFiltroMapa(){
    const out = document.getElementById('filtro-res');
    if (out) out.textContent = '';
    clearHighlight();
    if (distritoLayer){ try{ mapa.removeLayer(distritoLayer); }catch{} distritoLayer=null; }
  }
  async function geocodeAddress(){
    const inp = document.getElementById('addr-input');
    if (!inp) return;
    const q = String(inp.value||'').trim();
    if (!q) return;
    try{
      const r = await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(q));
      const list = await r.json();
      if (Array.isArray(list) && list[0]) updateSelf(parseFloat(list[0].lat), parseFloat(list[0].lon));
    }catch{}
  }

  function puntoEnAnillo(lat, lon, ring){
    let inside = false;
    for (let i=0,j=ring.length-1;i<ring.length;j=i++){
      const xi = ring[i][1], yi = ring[i][0];
      const xj = ring[j][1], yj = ring[j][0];
      const intersect = ((yi>lon)!=(yj>lon)) && (lat < (xj - xi) * (lon - yi) / (yj - yi + 0.0000001) + xi);
      if (intersect) inside = !inside;
    }
    return inside;
  }
  function contieneFeature(feature, lat, lon){
    const g = feature && feature.geometry;
    if (!g) return false;
    if (g.type === 'Polygon'){
      const rings = g.coordinates || [];
      return puntoEnAnillo(lat, lon, rings[0]||[]);
    }
    if (g.type === 'MultiPolygon'){
      const polys = g.coordinates || [];
      for (const p of polys){ if (puntoEnAnillo(lat, lon, (p[0]||[]))) return true; }
      return false;
    }
    return false;
  }
  async function verDistrito(){
    if (!selfMarker) return;
    const ll = selfMarker.getLatLng();
    if (!distritosData){
      try{
        const r = await fetch('/data/lima_callao_distritos.geojson');
        distritosData = await r.json();
      }catch{ alert('No se pudo cargar distritos'); return; }
    }
    let found = null;
    const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
    for (const f of feats){ if (contieneFeature(f, ll.lat, ll.lng)) { found = f; break; } }
    if (!found){ alert('Ubicación fuera de distritos de Lima/Callao'); return; }
    if (distritoLayer){ try{ mapa.removeLayer(distritoLayer); }catch{} distritoLayer = null; }
    distritoLayer = L.geoJSON(found, { style: { color:'#0ea5e9', weight:3, fillColor:'#60a5fa', fillOpacity:0.15 } });
    distritoLayer.addTo(mapa);
    try{ mapa.fitBounds(distritoLayer.getBounds(), { padding:[20,20] }); }catch{}
    updateDistritoBadge();
  }
</script>
