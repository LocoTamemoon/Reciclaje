<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">
  <style>
    :root{ --bg:#f6fbf7; --bg2:#eef7f2; --panel:#ffffff; --panel2:#f8fbf8; --muted:#7b978b; --primary:#3ac27f; --accent:#38c1b3; --text:#0f172a; --border:#d9e7de; --shadow:rgba(15,60,30,0.08); }
    body{ margin:0; font-family:system-ui, Segoe UI, Arial; background:linear-gradient(120deg, var(--bg), var(--bg2)); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    h2{ margin:0; font-weight:700; letter-spacing:0.2px; }
    h3{ margin:0; font-weight:600; }
    .layout{ display:grid; grid-template-columns: 280px 1fr; min-height:100vh; }
    .sidebar{ background:linear-gradient(180deg, #f0f7f2 0%, #eaf6f0 100%); padding:18px; border-right:1px solid var(--border); box-shadow:0 6px 20px var(--shadow); }
    .brand{ font-weight:700; font-size:18px; margin-bottom:14px; }
    .menu button{ width:100%; text-align:left; background:transparent; border:none; color:#475569; padding:10px 12px; border-radius:10px; cursor:pointer; transition:all .18s ease; }
    .menu button.active{ background:#e6f4ec; color:#0f172a; box-shadow:0 4px 12px var(--shadow); }
    .menu button:hover{ background:#edf7f2; transform:translateY(-1px); }
    .content{ padding:22px; }
    .panel{ background:linear-gradient(180deg, var(--panel), var(--panel2)); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 8px 20px var(--shadow); position:relative; overflow:hidden; }
    .panel::before{ content:""; position:absolute; inset:-18% 52% auto auto; width:200px; height:200px; background:radial-gradient(closest-side, rgba(56,193,179,0.10), transparent); transform:rotate(8deg); pointer-events:none; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:16px; }
    .card{ background:#ffffff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:0 6px 16px var(--shadow); transition:transform .14s ease, box-shadow .14s ease; }
    .card:hover{ transform:translateY(-2px); box-shadow:0 12px 28px var(--shadow); }
    .row{ display:flex; gap:10px; align-items:center; }
    .muted{ color:var(--muted); font-size:12px; }
    .badge{ display:inline-flex; align-items:center; background:#f2fbf7; border:1px solid var(--border); padding:4px 8px; border-radius:999px; font-size:12px; }
    .btn{ background:linear-gradient(180deg, #33cf79, var(--primary)); color:#083e2a; border:none; border-radius:10px; padding:8px 12px; cursor:pointer; box-shadow:0 6px 14px var(--shadow); transition:all .14s ease; font-weight:600; }
    .btn:hover{ filter:brightness(1.06); transform:translateY(-1px); }
    .btn:active{ transform:translateY(0); }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; filter:none; box-shadow:none; }
    .btn.secondary{ background:linear-gradient(180deg, #3ed1c3, var(--accent)); color:#083333; }
    .right{ text-align:right; }
    .list{ list-style:none; padding:0; margin:0; }
    .list li{ padding:10px 12px; background:#ffffff; border:1px solid var(--border); border-radius:12px; margin:8px 0; box-shadow:0 6px 14px var(--shadow); }
    .cards-row{ align-items:flex-start; gap:12px; }
    .stats-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:12px; }
    .stat-card{ background:#ffffff; border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:0 6px 14px var(--shadow); }
    .stat-title{ color:var(--muted); font-size:12px; }
    .stat-value{ font-weight:700; }
    .mono{ font-family: ui-monospace, Menlo, monospace; font-size:12px; }
    .perfil-mat-table{ font-family: ui-sans-serif, system-ui, Segoe UI, Arial; }
    .perfil-mat-table th{ font-size:12px; }
    .perfil-mat-table td{ font-size:12px; }
    .thumb-wrap{ position:relative; display:inline-flex; flex-direction:column; gap:4px; }
    .thumb{ width:120px; height:80px; border-radius:10px; object-fit:cover; border:1px solid #e5e7eb; background:#f8fafc; }
    .edit-badge{ position:absolute; top:-10px; left:-10px; width:28px; height:28px; border-radius:999px; background:#22c55e; color:#fff; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 20px rgba(16,185,129,0.35); cursor:pointer; border:2px solid #fff; }
    input, select{ background:#ffffff; color:var(--text); border:1px solid var(--border); border-radius:0px; padding:8px 10px; outline:none; transition:border-color .14s ease, box-shadow .14s ease; }
    input:focus, select:focus, textarea:focus{ border-color:#3ac27f; box-shadow:0 0 0 3px rgba(58,194,127,0.25); }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    th, td{ padding:10px; border-bottom:1px solid var(--border); }
    th{ text-align:left; color:#cbd5e1; font-weight:600; }
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,0.12); display:flex; align-items:center; justify-content:center; backdrop-filter:saturate(160%) blur(4px); }
    .modal[hidden]{ display:none !important; }
    .modal-card{ background:linear-gradient(180deg, #ffffff, #fbfdfc); border:1px solid var(--border); border-radius:16px; width:440px; max-width:92vw; padding:16px; box-shadow:0 10px 24px var(--shadow); }
    .modal-card h3{ margin:0 0 12px; font-weight:700; }
    .modal-card textarea{ width:100%; min-height:92px; border-radius:10px; border:1px solid var(--border); background:#ffffff; color:var(--text); padding:10px; }
    #ruta-modal .modal-card{ width:720px; max-width:95vw; }
    #viaje-modal .modal-card{ width:720px; max-width:95vw; }
    .modal-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:14px; }
    @media (max-width: 880px){ .layout{ grid-template-columns: 1fr; } .sidebar{ position:sticky; top:0; z-index:10; } }
  </style>
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/layout.css">
  <script src="/js/micro.js" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="relative min-h-screen bg-gradient-to-br from-emerald-50 via-emerald-100 to-emerald-200">
  <div class="absolute inset-0 pointer-events-none bg-[radial-gradient(ellipse_at_top,_rgba(56,193,179,0.10),_transparent_40%)]"></div>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">Reciclaje App</div>
      <div class="mono" id="user-info"></div>
      <div class="menu">
        <button id="m-empresas" onclick="setView('empresas')">Empresas</button>
        <button id="m-solicitudes" onclick="setView('solicitudes')">Mis Solicitudes</button>
        <div id="sol-submenu" style="margin-left:12px; margin-top:6px;" hidden>
          <button id="sol-nav-pend">Pendientes</button>
          <button id="sol-nav-ant">Anteriores</button>
        </div>
        <button id="m-historial" onclick="setView('historial')">Historial</button>
        <div id="hist-submenu" style="margin-left:12px; margin-top:6px;" hidden>
          <button id="hist-nav-direct">Viaje Directo</button>
          <button id="hist-nav-handoff">Viaje Handoff</button>
        </div>
        <button id="m-perfil" onclick="setView('perfil')">Perfil</button>
        <button id="m-resenas" onclick="setView('resenas')">Reseñas</button>
        <button id="m-rewards" onclick="setView('rewards')">Usa Puntos</button>
        <button id="m-mapa" onclick="setView('mapa')">Mapa</button>
        <button id="m-notificaciones" onclick="setView('notificaciones')">Notificaciones <span id="notif-count" class="badge">0</span></button>
        <button id="m-progreso" onclick="setView('progreso')">Trabajo en Progreso ni bien que le doy aceptar</button>
      </div>
      <div class="sidebar-footer">
        <button class="btn danger icon" onclick="logout()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 3H6C4.895 3 4 3.895 4 5V19C4 20.105 4.895 21 6 21H10" stroke="#3b0b0b" stroke-width="2" stroke-linecap="round"/>
            <path d="M17 16L21 12L17 8" stroke="#3b0b0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M21 12H10" stroke="#3b0b0b" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Salir
        </button>
      </div>
    </aside>
    <main class="content">
      <section id="view-empresas" class="panel bg-white/60 backdrop-blur-md ring-emerald-200 rounded-2xl" hidden>
        <div class="row jc-between">
          <h2>Empresas disponibles</h2>
          <button class="btn secondary" onclick="loadEmpresas()">Actualizar</button>
        </div>
        <div id="empresas" class="grid"></div>
      </section>
      <section id="view-recolector" class="panel bg-white/60 backdrop-blur-md ring-emerald-200 rounded-2xl" hidden>
        <div class="row jc-between">
          <h2>Solicitudes Disponibles</h2>
          <div class="row gap-8">
            <button class="btn secondary" onclick="loadRecolectorFeed()">Actualizar</button>
          </div>
        </div>
        <div class="row" style="gap:8px; align-items:center; margin-top:8px;">
          <div class="muted">Vehículo activo:</div>
          <select id="reco-vehiculo" style="min-width:220px;"></select>
          <button class="btn secondary" onclick="loadVehiculosRecolector()">Actualizar vehículos</button>
        </div>
        <div id="reco-current" class="card" style="display:none; margin-top:8px;">
          <div class="row jc-between ai-center">
            <div>Trabajo en curso · Solicitud <strong id="reco-current-sid">—</strong></div>
          </div>
        </div>
        <ul id="reco-feed" class="list"></ul>
        <div class="panel mt-12">
          <div class="row jc-between ai-center"><h3>Handoffs disponibles</h3><button class="btn secondary" onclick="loadHandoffFeed()">Actualizar</button></div>
          <ul id="handoff-feed" class="list"></ul>
        </div>
        <div id="reco-preview" class="panel mt-12" style="display:none;">
          <div id="reco-map" class="map-box"></div>
          <div id="reco-route-meta" class="muted mt-8"></div>
        </div>
        <div id="reco-detalle" class="panel mt-12" style="display:none;">
          <div class="row jc-between ai-center">
            <h3>Detalles de la solicitud</h3>
            <button class="btn secondary" onclick="(function(){ const d=document.getElementById('reco-detalle'); if(d) d.style.display='none'; })()">Cerrar</button>
          </div>
          <div id="reco-detalle-body" class="muted"></div>
        </div>
      </section>
      <section id="view-progreso" class="panel bg-white/60 backdrop-blur-md ring-emerald-200 rounded-2xl" hidden>
        <div class="row jc-between">
          <h2>Trabajo en Progreso</h2>
          <button class="btn secondary" onclick="loadProgreso()">Actualizar</button>
        </div>
        <ul id="progreso-list" class="list"></ul>
      </section>
      <section id="view-empresa" class="panel bg-white/60 backdrop-blur-md ring-emerald-200 rounded-2xl" hidden>
        <div class="row jc-between">
          <h2 id="empresa-titulo">Empresa</h2>
          <div class="row">
            <button class="btn secondary" onclick="setView('empresas')">Volver</button>
            <button class="btn" onclick="confirmarSolicitud()">Crear solicitud</button>
          </div>
        </div>
        <div class="row jc-between ai-end">
          <div>
            <div id="empresa-meta" class="muted"></div>
          </div>
          <div class="right">
            <div>Estimado total: <strong id="estimado-total">S/ 0.00</strong></div>
          </div>
        </div>
        <div class="mt-12" style="overflow:auto;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:1px solid #1f2937;">
                <th style="text-align:left; padding:8px;">Material</th>
                <th style="text-align:right; padding:8px;">Precio/kg (S/)</th>
                <th style="text-align:right; padding:8px;">Kg a entregar</th>
                <th style="text-align:right; padding:8px;">Subtotal (S/)</th>
              </tr>
            </thead>
            <tbody id="materiales-body"></tbody>
          </table>
        </div>
        <div class="muted mt-10" id="empresa-cond"></div>
        <div class="mt-10">
          <label class="check-wrap">
            <input type="checkbox" id="delivery-check" />
            <span>Solicito el delivery sabiendo las condiciones del Acuerdo de Usuario a VidaVerde</span>
          </label>
          <div class="muted mt-8" id="delivery-hint">Delivery disponible desde S/ 35</div>
          <label class="check-wrap mt-8">
            <input type="checkbox" id="delivery-actual-check" />
            <span>Quiero que el recojo sea en mi ubicación actual (por defecto se usa el domicilio previamente registrado)</span>
          </label>
          <div class="muted mt-8" id="delivery-actual-hint" style="display:none;">Activa tu geolocalización para usar tu ubicación actual</div>
        </div>
        <div class="mt-21">
          <div class="row jc-between ai-center">
            <h3>Reseñas</h3>
            <button class="btn secondary" onclick="empresaResenasRefresh()">Actualizar</button>
          </div>
          <ul id="empresa-resenas-list" class="list"></ul>
        </div>
      </section>
      <section id="view-solicitudes" class="panel bg-white/60 backdrop-blur-md ring-emerald-200 rounded-2xl" hidden>
        <div class="row jc-between">
          <h2>Mis Solicitudes</h2>
          <button class="btn secondary" onclick="loadSolicitudes()">Actualizar</button>
        </div>
        <div class="row cards-row">
          <div id="sol-card-pend" style="flex:1" class="card">
            <div class="row jc-between ai-center">
              <h3>Pendientes</h3>
            </div>
            <div class="row my-8">
              <input id="sol-pend-search" type="text" placeholder="Buscar solicitud pendiente..." class="flex-1" />
            </div>
            <div class="row gap-8" style="margin:4px 0 8px;">
              <select id="sol-pend-estado">
                <option value="todos">Todos</option>
                <option value="pendiente_empresa">pendiente_empresa</option>
                <option value="pendiente_delivery">pendiente_delivery</option>
                <option value="completada">completada</option>
                <option value="expirada">expirada</option>
                <option value="rechazada">rechazada</option>
                <option value="cancelada">cancelada</option>
              </select>
              <select id="sol-pend-tipo">
                <option value="todos">Todos</option>
                <option value="delivery">Delivery</option>
                <option value="recoger">Recoger en empresa</option>
              </select>
            </div>
            <ul id="sol-pend" class="list"></ul>
          </div>
          <div id="sol-card-ant" style="flex:1" class="card">
            <div class="row jc-between ai-center">
              <h3>Anteriores</h3>
            </div>
            <div class="row my-8">
              <input id="sol-ant-search" type="text" placeholder="Buscar solicitud anterior..." class="flex-1" />
            </div>
            <div class="row gap-8" style="margin:4px 0 8px;">
              <select id="sol-ant-estado">
                <option value="todos">Todos</option>
                <option value="pendiente_empresa">pendiente_empresa</option>
                <option value="pendiente_delivery">pendiente_delivery</option>
                <option value="completada">completada</option>
                <option value="expirada">expirada</option>
                <option value="rechazada">rechazada</option>
                <option value="cancelada">cancelada</option>
              </select>
              <select id="sol-ant-tipo">
                <option value="todos">Todos</option>
                <option value="delivery">Delivery</option>
                <option value="recoger">Recoger en empresa</option>
              </select>
            </div>
            <ul id="sol-ant" class="list"></ul>
          </div>
        </div>
        <div id="usr-preview" class="panel mt-12" style="display:none;">
          <div id="usr-map" class="map-box"></div>
          <div id="usr-route-meta" class="muted mt-8"></div>
        </div>
      </section>
      <section id="view-historial" class="panel bg-white/60 backdrop-blur-md ring-emerald-200 rounded-2xl" hidden>
        <div class="row jc-between ai-center">
          <h2 id="hist-title">Historial de Transacciones</h2>
          <div class="badge" id="hist-earnings" style="margin-left:8px;">Ganancia total: S/ 0.00</div>
          <div class="row">
            <button class="btn secondary" id="hist-refresh">Actualizar</button>
          </div>
        </div>
        <div class="row my-8">
          <input id="hist-search" type="text" placeholder="Buscar transacción..." style="flex:1;" />
        </div>

        <div id="hist-reco-tabs" class="row gap-8" style="display:none;">
          <button id="hist-reco-tab-direct" class="btn">Viaje Directo</button>
          <button id="hist-reco-tab-handoff" class="btn secondary">Viaje Handoff</button>
        </div>

        <ul id="hist-list" class="list"></ul>
        <div id="hist-reco-groups" style="display:none;" class="mt-8">
          <h3>Viaje Directo</h3>
          <ul id="hist-list-direct" class="list"></ul>
          <h3 class="mt-12">Viaje Handoff</h3>
          <ul id="hist-list-handoff" class="list"></ul>
        </div>
        <div id="hist-detalle" class="panel mt-12" style="display:none;"></div>
      </section>
      <section id="view-empresa-solicitudes" class="panel bg-white/60 backdrop-blur-md ring-emerald-200 rounded-2xl" hidden>
        <div class="row jc-between">
          <h2>Solicitudes Entrantes</h2>
          <button class="btn secondary" onclick="loadSolicitudesEmpresa()">Actualizar</button>
        </div>
        <ul id="emp-sol-list" class="list"></ul>
      </section>
      <section id="view-rewards" class="panel bg-white/60 backdrop-blur-md ring-emerald-200 rounded-2xl" hidden>
        <div class="row jc-between ai-center">
          <h2>Usa tus puntos</h2>
          <div class="badge" id="rewards-puntos">Puntos: 0</div>
        </div>
        <ul id="rewards-list" class="list"></ul>
      </section>
      <section id="view-resenas" class="panel bg-white/60 backdrop-blur-md ring-emerald-200 rounded-2xl" hidden>
        <div class="row jc-between">
          <h2>Reseñas de la empresa</h2>
          <button class="btn secondary" onclick="loadResenasEmpresa()">Actualizar</button>
        </div>
        <ul id="resenas-list" class="list"></ul>
      </section>
      <section id="view-mapa" class="panel bg-white/60 backdrop-blur-md ring-emerald-200 rounded-2xl" hidden>
        <div class="row jc-between ai-center gap-10">
          <h2>Mapa</h2>
          <div class="row gap-8 ai-center">
            <span class="badge" id="acc-badge">Precisión —</span>
            <span class="badge" id="dist-badge">Distrito —</span>
            <button class="btn secondary" id="buscar-btn">Mi ubicación</button>
          </div>
        </div>
        <div class="row gap-8 mt-8">
          <input id="addr-input" placeholder="Dirección" style="flex:1" />
          <button class="btn secondary" id="addr-btn">Buscar dirección</button>
          <button class="btn" id="distrito-btn">Ver distrito</button>
          <button class="btn secondary" id="casa-btn">Ver ubicación de casa</button>
        </div>
        <div class="card mt-8" style="padding:8px;">
          <div class="row gap-8 ai-center flex-wrap">
            <select id="map-filtro" class="min-240">
              <option value="none">---SELECCIONE---</option>
              <option value="mejor_material">Mejores pagos por material</option>
              <option value="mas_cercana">Empresa recicladora más cercana</option>
              <option value="empresas_count">Empresas registradas en distrito</option>
              <option value="mas_tx">Distrito con más transacciones</option>
              <option value="mejor_distrito">Distrito con mejores calificaciones</option>
            </select>
            <select id="map-material" class="min-240" style="display:none;"></select>
            <label class="check-wrap" style="display:none;" id="limit-dist-wrap">
              <input type="checkbox" id="map-limit-distrito" /> Limitar por distrito
            </label>
            <select id="map-limit-distrito-sel" class="min-240" style="display:none;"></select>
            <select id="map-filtro-distrito" class="min-240" style="display:none;"></select>
            <button class="btn" id="aplicar-filtro">Aplicar filtro</button>
            <button class="btn secondary" id="quitar-filtro">Quitar filtro</button>
            <span id="filtro-res" class="muted"></span>
          </div>
        </div>
        <div class="card mt-12">
          <div id="map" class="map-box"></div>
        </div>
      </section>
      <section id="view-notificaciones" class="panel bg-white/60 backdrop-blur-md ring-emerald-200 rounded-2xl" hidden>
        <div class="row jc-between ai-center">
          <h2>Notificaciones</h2>
          <div class="row gap-8">
            <button class="btn secondary" id="notif-refresh">Actualizar</button>
          </div>
        </div>
        <ul id="notif-list" class="list"></ul>
        <div id="notif-pager" class="row jc-end gap-8 mt-10"></div>
      </section>
      <section id="view-pesaje" class="panel bg-white/60 backdrop-blur-md ring-emerald-200 rounded-2xl" hidden>
        <div class="row jc-between">
          <h2 id="pesaje-titulo">Pesaje</h2>
          <div class="row">
            <button class="btn secondary" onclick="cancelarPesaje()">Cancelar</button>
            <button class="btn" id="btn-pesaje-confirm" onclick="confirmarPesaje()" disabled>Registrar pesaje y pago</button>
          </div>
        </div>
        <div class="row jc-between ai-end">
          <div>
            <div id="pesaje-meta" class="muted"></div>
          </div>
          <div class="right">
            <div>Método de pago
              <select id="metodo-pago">
                <option value="efectivo">Efectivo</option>
                <option value="transferencia">Transferencia</option>
              </select>
            </div>
          </div>
        </div>
        <div class="mt-12 overflow-auto">
          <table class="table">
            <thead>
              <tr>
                <th class="ta-left">Material</th>
                <th class="ta-right">Precio/kg (S/)</th>
                <th class="ta-right">Kg finales</th>
                <th class="ta-right">Subtotal (S/)</th>
              </tr>
            </thead>
            <tbody id="pesaje-body"></tbody>
          </table>
        </div>
        <div class="right mt-10" style="display:flex; gap:12px; align-items:center; justify-content:flex-end; flex-wrap:wrap;">
          <div>Total estimado: <strong id="pesaje-total">S/ 0.00</strong></div>
          <div>Comisión (10%): <strong id="pesaje-fee">S/ 0.00</strong></div>
          <div>Total a pagar: <strong id="pesaje-net">S/ 0.00</strong></div>
          <div class="row" style="gap:8px; align-items:center;">
            <input type="checkbox" id="pesaje-agree" />
            <label for="pesaje-agree" class="check-wrap" style="font-size:12px;">Acepto las condiciones del Acuerdo de Suscriptor a Vida Verde</label>
          </div>
        </div>
      </section>
      <section id="view-perfil" class="panel bg-white/60 backdrop-blur-md ring-emerald-200 rounded-2xl" hidden>
        <div class="row jc-between ai-center">
          <h2>Perfil</h2>
        </div>
        <div id="perfil" class="mono"></div>
        <div id="perfil-usuario-extra" style="margin-top:12px;" hidden>
          <div class="card">
            <div class="row jc-between ai-center">
              <h3>Materiales reciclados</h3>
              <button id="perfil-usuario-materiales-refresh" class="btn secondary">Actualizar</button>
            </div>
            <table class="table perfil-mat-table">
              <thead>
                <tr>
                  <th class="ta-left">Material</th>
                  <th class="ta-right">Kg totales</th>
                </tr>
              </thead>
              <tbody id="perfil-usuario-materiales-body"></tbody>
            </table>
          </div>
          <div class="card" style="margin-top:12px;">
            <div class="row jc-between ai-center">
              <h3>Reseñas</h3>
              <button id="perfil-usuario-resenas-refresh" class="btn secondary">Actualizar</button>
            </div>
            <ul id="perfil-usuario-resenas-list" class="mono list"></ul>
          </div>
        </div>
        <div id="perfil-materiales" style="margin-top:12px;" hidden>
          <div class="row jc-between">
            <h3>Materiales y precios</h3>
            <button class="btn" onclick="perfilSaveMaterials()">Guardar cambios</button>
          </div>
          <div class="row gap-12 my-8">
            <select id="perfil-add-select" style="flex:1"></select>
            <input id="perfil-add-precio" type="number" step="0.01" placeholder="Precio base" style="width:140px" />
            <button class="btn secondary" onclick="perfilAddMaterial()">Agregar material</button>
          </div>
          <table class="table">
            <thead>
              <tr>
                <th class="ta-left">Material</th>
                <th class="ta-right">Precio/kg (S/)</th>
                <th class="ta-left">Condiciones</th>
                <th class="ta-right">Acciones</th>
              </tr>
            </thead>
            <tbody id="perfil-materiales-body"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <div id="rating-modal" class="modal" hidden>
    <div class="modal-card">
      <h3 id="rating-title">Calificar</h3>
      <label>Puntaje (1-5)</label>
      <select id="rating-score">
        <option value="5">5</option>
        <option value="4">4</option>
        <option value="3">3</option>
        <option value="2">2</option>
        <option value="1">1</option>
      </select>
      <label class="mt">Mensaje (opcional)</label>
      <textarea id="rating-msg" placeholder="Escribe un comentario..."></textarea>
      <div class="modal-actions">
        <button class="btn" onclick="submitRating()">Enviar</button>
        <button class="btn secondary" onclick="closeRating()">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="aceptar-modal" class="modal" hidden>
    <div class="modal-card">
      <h3>Confirmar aceptación</h3>
      <div id="aceptar-detalle" class="mono"></div>
      <div class="row ai-center gap-8 mt-10">
        <input type="checkbox" id="aceptar-agree" />
        <label for="aceptar-agree" class="check-wrap" style="font-size:12px;">Acepto las condiciones del Acuerdo de Suscriptor a Vida Verde</label>
      </div>
      <div id="aceptar-fee-box" class="right mt-8" hidden>
        <div>Comisión (10%): <strong id="aceptar-fee">S/ 0.00</strong></div>
        <div>Total a pagar: <strong id="aceptar-net">S/ 0.00</strong></div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="btn-aceptar-go">Aceptar</button>
        <button class="btn secondary" id="btn-aceptar-pesaje">Pesaje</button>
        <button class="btn secondary" onclick="closeAceptar()">Volver</button>
      </div>
    </div>
  </div>

  <div id="solicitud-modal" class="modal" hidden>
    <div class="modal-card">
      <h3>Detalle de solicitud</h3>
      <div id="solicitud-detalle" class="mono"></div>
      <div class="modal-actions">
        <button class="btn secondary" onclick="closeSolicitudDetalle()">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="ruta-modal" class="modal" hidden>
    <div class="modal-card">
      <div class="row jc-between ai-center">
        <h3>Ruta a la empresa</h3>
        <button class="btn secondary" id="usr-instr-toggle">Ocultar indicaciones</button>
      </div>
      <div id="usr-map-modal" class="map-box"></div>
      <div id="usr-route-meta-modal" class="muted mt-8"></div>
      <div class="modal-actions">
        <button class="btn secondary" onclick="closeRuta()">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="viaje-modal" class="modal" hidden>
    <div class="modal-card">
      <div class="row jc-between ai-center">
        <h3>Ver viaje</h3>
        <button class="btn secondary" id="viaje-instr-toggle">Ocultar indicaciones</button>
        <button class="btn secondary" id="viaje-speed-toggle">x2</button>
      </div>
      <div id="usr-map-viaje" class="map-box"></div>
      <div id="usr-route-meta-viaje" class="muted mt-8"></div>
      <div class="modal-actions">
        <button class="btn secondary" onclick="closeViaje()">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="historial-modal" class="modal" hidden>
    <div class="modal-card">
      <h3 id="historial-modal-title">Detalle</h3>
      <div id="historial-modal-content"></div>
      <div class="modal-actions">
        <button class="btn secondary" onclick="closeHistorialModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="perfil-edit-modal" class="modal" hidden>
    <div class="modal-card">
      <h3>Editar perfil</h3>
      <div class="row gap-12">
        <div style="flex:1;">
          <label>Nombre</label>
          <input type="text" id="perfil-edit-nombre" />
        </div>
        <div style="flex:1;">
          <label>Apellidos</label>
          <input type="text" id="perfil-edit-apellidos" />
        </div>
      </div>
      <div class="row ai-center gap-12 mt-10">
        <input type="file" id="perfil-edit-foto" accept="image/*" />
      </div>
      <div class="modal-actions">
        <button class="btn secondary" onclick="closePerfilEdit()">Cancelar</button>
        <button class="btn" onclick="savePerfilEdit()">Guardar</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script>
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    const user = JSON.parse(localStorage.getItem('user')||'null');
    if (!token || !user) { window.location.href = '/login.html'; }

    document.getElementById('user-info').textContent = `${role || 'usuario'} #${user.id}`;

    // Ajuste de texto del menú para recolector
    if (role === 'recolector') {
      const btnSol = document.getElementById('m-solicitudes');
      if (btnSol) btnSol.textContent = 'Solicitudes Disponibles';
    }
    const navDirect = document.getElementById('hist-nav-direct');
    const navHandoff = document.getElementById('hist-nav-handoff');
    if (navDirect) navDirect.onclick = ()=>{ setView('historial'); setRecoHistTab('direct'); };
    if (navHandoff) navHandoff.onclick = ()=>{ setView('historial'); setRecoHistTab('handoff'); };
    const solNavPend = document.getElementById('sol-nav-pend');
    const solNavAnt = document.getElementById('sol-nav-ant');
    if (solNavPend) solNavPend.onclick = ()=>{ solTab='pendientes'; setView('solicitudes'); };
    if (solNavAnt) solNavAnt.onclick = ()=>{ solTab='anteriores'; setView('solicitudes'); };

    function setView(v){
      for (const id of ['empresas','solicitudes','historial','perfil','resenas','rewards','mapa','notificaciones','progreso']){
        document.getElementById('view-'+id).hidden = (id!==v);
        document.getElementById('m-'+id).classList.toggle('active', id===v);
      }
      const sub = document.getElementById('hist-submenu');
      if (sub) sub.hidden = !(role==='recolector' && v==='historial');
      const solSub = document.getElementById('sol-submenu');
      if (solSub) solSub.hidden = (v!=='solicitudes');
      const solNavPend2 = document.getElementById('sol-nav-pend');
      const solNavAnt2 = document.getElementById('sol-nav-ant');
      if (solNavPend2 && solNavAnt2){
        solNavPend2.classList.toggle('active', solTab==='pendientes' && v==='solicitudes');
        solNavAnt2.classList.toggle('active', solTab==='anteriores' && v==='solicitudes');
      }
      const solCardPend = document.getElementById('sol-card-pend');
      const solCardAnt = document.getElementById('sol-card-ant');
      if (solCardPend && solCardAnt){
        solCardPend.hidden = !(v==='solicitudes' && solTab==='pendientes');
        solCardAnt.hidden = !(v==='solicitudes' && solTab==='anteriores');
      }
      // Limpieza: submenu de historial solo para recolector; sin opciones de usuario
      document.getElementById('view-empresa').hidden = (v!=='empresa');
      document.getElementById('view-empresa-solicitudes').hidden = (v!=='empresa_solicitudes');
      document.getElementById('view-pesaje').hidden = (v!=='pesaje');
      const mProg = document.getElementById('m-progreso');
      if (mProg) mProg.style.display = (role==='recolector') ? '' : 'none';
      if (role === 'recolector' && v === 'solicitudes') {
        document.getElementById('view-solicitudes').hidden = true;
        const rview = document.getElementById('view-recolector');
        if (rview) rview.hidden = false;
        const solSub2 = document.getElementById('sol-submenu');
        if (solSub2) solSub2.hidden = true;
        try { loadVehiculosRecolector(); } catch {}
        try { iniciarUbicacionRecolector(); setTimeout(()=> { try{ loadRecolectorFeed(); }catch{} try{ loadHandoffFeed(); }catch{} }, 400); } catch { loadRecolectorFeed(); try{ loadHandoffFeed(); }catch{} }
        try { const last = localStorage.getItem('last_reco_sid'); if (last && !isNaN(Number(last))) { setTimeout(()=>{ try{ recoVerUbicacion(Number(last)); }catch{} }, 500); } } catch {}
        return;
      } else {
        const rview = document.getElementById('view-recolector');
        if (rview) rview.hidden = true;
      }
      if (role==='recolector' && v==='progreso') { loadProgreso(); }
      if (v==='empresas') loadEmpresas();
      if (v==='solicitudes') { solPendVisibleCount = 10; solAntVisibleCount = 10; solPendPage = 1; solAntPage = 1; loadSolicitudes(); }
      if (v==='notificaciones') { initNotificaciones(); }
      if (v==='solicitudes'){
        const sp = document.getElementById('sol-pend-search');
        const sa = document.getElementById('sol-ant-search');
        if (sp){ sp.value = solPendSearch; sp.oninput = ()=>{ solPendSearch = sp.value; renderSolicitudesPendientes(); }; }
        if (sa){ sa.value = solAntSearch; sa.oninput = ()=>{ solAntSearch = sa.value; renderSolicitudesAnteriores(); }; }
        const spe = document.getElementById('sol-pend-estado');
        const spt = document.getElementById('sol-pend-tipo');
        const sae = document.getElementById('sol-ant-estado');
        const sat = document.getElementById('sol-ant-tipo');
        if (spe){ spe.value = solPendEstado; spe.onchange = ()=>{ solPendEstado = spe.value; renderSolicitudesPendientes(); }; }
        if (spt){ spt.value = solPendTipo; spt.onchange = ()=>{ solPendTipo = spt.value; renderSolicitudesPendientes(); }; }
        if (sae){ sae.value = solAntEstado; sae.onchange = ()=>{ solAntEstado = sae.value; renderSolicitudesAnteriores(); }; }
        if (sat){ sat.value = solAntTipo; sat.onchange = ()=>{ solAntTipo = sat.value; renderSolicitudesAnteriores(); }; }
      }
      if (v==='historial') {
        histVisibleCount = 10; histPage = 1;
        if (role==='empresa') {
          loadHistorialEmpresa();
          const he = document.getElementById('hist-earnings');
          if (he) he.style.display = 'none';
        } else if (role==='recolector') {
          const title = document.getElementById('hist-title');
          if (title) title.textContent = 'Historial de trabajos';
          const tabs = document.getElementById('hist-tabs');
          if (tabs) tabs.style.display = 'none';
          const refreshBtn = document.getElementById('hist-refresh');
          if (refreshBtn) refreshBtn.onclick = ()=> loadHistorialRecolector();
          const he = document.getElementById('hist-earnings');
          if (he) he.style.display = 'inline-block';
          loadHistorialRecolector();
        } else {
          initHistorialUI();
          if (histGastosMode) loadHistorialGastos(); else loadHistorial();
          const he = document.getElementById('hist-earnings');
          if (he) he.style.display = 'none';
        }
      }
      if (v==='perfil') loadPerfil();
      if (v==='empresa_solicitudes') loadSolicitudesEmpresa();
      if (v==='resenas' && role==='empresa') loadResenasEmpresa();
      if (v==='rewards' && role==='usuario') loadRewards();
      if (v==='mapa'){ if (!mapaInit) initMapa(); }
    }
    let notifES = null;
    let notifCache = [];
    let notifPage = 1;
    const NOTIF_PAGE_SIZE = 10;
    function initNotificaciones(){
      console.log('notif_init');
      const ul = document.getElementById('notif-list');
      const btn = document.getElementById('notif-refresh');
      if (btn) btn.onclick = loadNotificaciones;
      loadNotificaciones();
      if (notifES) { try{ notifES.close(); }catch{} notifES = null; }
      const url = `/api/solicitudes/notificaciones/stream?role=${encodeURIComponent(role)}&id=${encodeURIComponent(user.id)}`;
      console.log('notif_stream_subscribe', { url });
      notifES = new EventSource(url);
      notifES.onopen = function(){ try{ console.log('notif_stream_open', { role, id: user.id }); }catch{} };
      notifES.onerror = function(err){ try{ console.log('notif_stream_error', { role, id: user.id, err: String(err) }); }catch{} };
      notifES.addEventListener('notif', (ev)=>{
        try {
          const data = JSON.parse(ev.data);
          console.log('notif_stream_event', { data });
          try {
            if (!Array.isArray(notifCache)) notifCache = [];
            const k = String(data?.solicitud_id||'') + '|' + String(data?.tipo||'');
            const ts = new Date(data?.creado_en||Date.now()).getTime();
            let replaced = false;
            notifCache = notifCache.filter((n)=>{
              const nk = String(n?.solicitud_id||'') + '|' + String(n?.tipo||'');
              if (nk===k){
                replaced = true;
                const nts = new Date(n?.creado_en||Date.now()).getTime();
                return ts >= nts ? false : true;
              }
              return true;
            });
            notifCache.unshift(data);
            updateNotifCount(notifCache);
            renderNotificaciones();
          } catch {
            appendNotif(data);
          }
        } catch {}
      });
    }
    async function loadNotificaciones(){
      console.log('notif_list_in');
      const ul = document.getElementById('notif-list');
      let list = [];
      try {
        const r = await fetch(`/api/solicitudes/notificaciones?role=${encodeURIComponent(role)}&id=${encodeURIComponent(user.id)}`, { headers: authHeaders() });
        list = await r.json();
      } catch {}
      if (!Array.isArray(list)) list = [];
      if (list.length === 0){
        try {
          const r2 = await fetch(`/api/solicitudes/notificaciones?id=${encodeURIComponent(user.id)}`, { headers: authHeaders() });
          const list2 = await r2.json();
          if (Array.isArray(list2)) list = list2;
        } catch {}
      }
      try {
        list = Array.isArray(list) ? list.filter((n)=> !Boolean(n?.leido)) : [];
        const byKey = {};
        for (const n of list){
          const k = String(n?.solicitud_id||'') + '|' + String(n?.tipo||'');
          const ts = new Date(n?.creado_en||Date.now()).getTime();
          const prev = byKey[k];
          if (!prev || ts > new Date(prev?.creado_en||Date.now()).getTime()) byKey[k] = n;
        }
        list = Object.values(byKey);
      } catch {}
      if (!Array.isArray(list)) list = [];
      notifCache = list;
      notifPage = 1;
      renderNotificaciones();
      updateNotifCount(notifCache);
      console.log('notif_list_out', { count: notifCache.length });
    }
    function notifPriority(n){
      const t = String(n?.tipo||'');
      const leido = Boolean(n?.leido);
      let p = 0;
      if (role==='recolector'){
        if (t==='solicitar_confirmaciones' || t==='cerca_empresa') p = 100;
        else if (t==='pedido_asignado' || t==='cerca_usuario') p = 50;
      } else if (role==='usuario'){
        if (t==='solicitar_confirmaciones') p = 100;
        else if (t==='cerca_recolector' || t==='entregado') p = 50;
      } else if (role==='empresa'){
        if (t==='entregado') p = 100;
        else if (t==='cerca_empresa') p = 50;
      }
      if (leido) p -= 1000;
      return p;
    }
    function notifIsAction(n){
      const t = String(n?.tipo||'');
      if (role==='recolector') return (t==='solicitar_confirmaciones');
      if (role==='usuario') return (t==='solicitar_confirmaciones');
      if (role==='empresa') return (t==='entregado');
      return false;
    }
    function renderNotificaciones(){
      const ul = document.getElementById('notif-list');
      const pager = document.getElementById('notif-pager');
      if (!ul || !pager) return;
      ul.innerHTML = '';
      const total = Array.isArray(notifCache) ? notifCache.length : 0;
      const pages = Math.max(1, Math.ceil(total / NOTIF_PAGE_SIZE));
      notifPage = Math.min(Math.max(1, notifPage), pages);
      const bySid = {};
      for (const n of (Array.isArray(notifCache)? notifCache : [])){
        const sid = Number(n?.solicitud_id||0);
        if (!bySid[sid]) bySid[sid] = [];
        bySid[sid].push(n);
      }
      const sidsDesc = Object.keys(bySid).map(Number).sort((a,b)=> b-a);
      const sorted = [];
      for (const sid of sidsDesc){
        const arr = bySid[sid].slice().sort((a,b)=>{
          const isAct = (x)=>{
            const t = String(x?.tipo||'');
            if (role==='recolector') return (t==='solicitar_confirmaciones' || t==='cerca_usuario' || t==='cerca_empresa') && !Boolean(x?.leido);
            if (role==='usuario') return (t==='solicitar_confirmaciones') && !Boolean(x?.leido);
            if (role==='empresa') return (t==='entregado') && !Boolean(x?.leido);
            return false;
          };
          const aAct = isAct(a);
          const bAct = isAct(b);
          if (aAct !== bAct) return aAct ? -1 : 1;
          const rank = (x)=>{
            const t = String(x?.tipo||'');
            if (role==='recolector'){
              if (t==='solicitar_confirmaciones') return 3;
              if (t==='cerca_usuario') return 1;
              if (t==='cerca_empresa') return 1;
              return 0;
            }
            if (role==='usuario'){
              if (t==='solicitar_confirmaciones') return 2;
              if (t==='cerca_recolector') return 1;
              return 0;
            }
            if (role==='empresa'){
              if (t==='entregado') return 1;
              return 0;
            }
            return 0;
          };
          const ra = rank(a);
          const rb = rank(b);
          if (ra !== rb) return rb - ra;
          const tb = new Date(b?.creado_en||0).getTime();
          const ta = new Date(a?.creado_en||0).getTime();
          return tb - ta;
        });
        for (const n of arr) sorted.push(n);
      }
      const start = (notifPage-1)*NOTIF_PAGE_SIZE;
      const slice = sorted.slice(start, start+NOTIF_PAGE_SIZE);
      slice.forEach(n=> appendNotif(n));
      const prevDis = notifPage<=1 ? 'disabled' : '';
      const nextDis = notifPage>=pages ? 'disabled' : '';
      pager.innerHTML = `<button class=\"btn secondary\" ${prevDis} onclick=\"notifPrev()\">Anterior</button><span class=\"muted\">Página ${notifPage} / ${pages}</span><button class=\"btn secondary\" ${nextDis} onclick=\"notifNext()\">Siguiente</button>`;
    }
    function notifPrev(){ notifPage = Math.max(1, notifPage-1); renderNotificaciones(); }
    function notifNext(){ const pages = Math.max(1, Math.ceil((notifCache?.length||0)/NOTIF_PAGE_SIZE)); notifPage = Math.min(pages, notifPage+1); renderNotificaciones(); }
    async function appendNotif(n){
      console.log('notif_append', { tipo: n.tipo, solicitud_id: Number(n.solicitud_id||0) });
      const ul = document.getElementById('notif-list');
      const li = document.createElement('li');
      const ts = new Date(n.creado_en||Date.now()).toLocaleString();
      const liId = 'notif-'+Math.random().toString(36).slice(2);
      li.id = liId;
      const sid2 = Number(n.solicitud_id||0);
      let actionHtml = '';
      try {
        const sid = Number(n.solicitud_id||0);
        const nid = (n && n.id!=null && !Number.isNaN(Number(n.id))) ? Number(n.id) : null;
        if (sid){
          if ((n.tipo === 'solicitar_confirmaciones') && role === 'usuario'){
            let show = true;
            try {
              const sj = await (await fetch(`/api/solicitudes/${sid}`, { headers: authHeaders() })).json();
              if (Boolean(sj?.usuario_llegada_ok)) show = false;
            } catch {}
            if (show) actionHtml = `<button class=\"btn\" onclick=\"notifAction(${sid}, 'usuario_confirmo_llegada', '${liId}', ${nid!=null?nid:'null'})\">Confirmar llegada</button>`;
          } else if ((n.tipo === 'solicitar_confirmaciones') && role === 'recolector'){
            let show = !Boolean(n?.leido);
            try {
              const sj = await (await fetch(`/api/solicitudes/${sid}`, { headers: authHeaders() })).json();
              if (Boolean(sj?.recolector_recojo_ok)) show = false;
              const est2 = String(sj?.estado||'');
              if (['rumbo_a_empresa','cerca_empresa','completada','rechazada','cancelada','expirada'].includes(est2)) show = false;
            } catch {}
            if (show) actionHtml = `<button class=\"btn\" onclick=\"notifAction(${sid}, 'recolector_confirmo_recojo', '${liId}', ${nid!=null?nid:'null'})\">Confirmar recojo</button>`;
          } else if (n.tipo === 'llego_empresa' && role === 'recolector'){
          } else if (n.tipo === 'entregado' && role === 'empresa'){
            let show = true;
            if (Boolean(n?.leido)) show = false;
            try {
              const sj = await (await fetch(`/api/solicitudes/${sid}`, { headers: authHeaders() })).json();
              const est = String(sj?.estado||'');
              if (['empresa_confirmo_recepcion','completada','rechazada','cancelada'].includes(est)) show = false;
            } catch {}
            if (show) actionHtml = `<button class=\"btn\" onclick=\"notifAction(${sid}, 'empresa_confirmo_recepcion', '${liId}', ${nid!=null?nid:'null'})\">Confirmar recepción</button>`;
          }
        }
      } catch {}
      li.innerHTML = `<div class="row jc-between"><div><div><strong>${n.tipo}</strong> ${sid2>0?`<span class=\"badge\">Solicitud #${sid2}</span>`:''}</div><div class="muted">${n.mensaje}</div></div><div class="right"><span class="muted">${ts}</span> ${actionHtml}</div></div>`;
      ul.appendChild(li);
    }
    async function notifAction(sid, etapa, liId, nid){
      try {
        console.log('notif_action_in', { sid, etapa, role, actor_id: user.id });
        try { if (role==='recolector') await fetch(`/api/viajes/${sid}/pausar`, { method:'POST', headers: authHeaders() }); } catch {}
        let actor = role;
        let actor_id = user.id;
        const r = await fetch(`/api/solicitudes/${sid}/etapas`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ etapa, actor, actor_id }) });
        const j = await r.json();
        if (j?.error){ alert('No se pudo confirmar: '+j.error); return; }
        const li = document.getElementById(liId);
        if (li) li.querySelectorAll('button').forEach(b=> b.disabled = true);
        console.log('notif_action_ok', { sid, etapa });
        try { if (nid!=null) await fetch(`/api/solicitudes/notificaciones/${nid}/leido`, { method:'POST', headers: authHeaders() }); } catch {}
        try { const li2 = document.getElementById(liId); if (li2) li2.remove(); } catch {}
        try { updateNotifCount(document.querySelectorAll('#notif-list li')); } catch {}
        try {
          const sj = await (await fetch(`/api/solicitudes/${sid}`, { headers: authHeaders() })).json();
          const ok1 = Boolean(sj?.usuario_llegada_ok);
          const ok2 = Boolean(sj?.recolector_recojo_ok);
          const est = String(sj?.estado||'');
          if ((ok1 && ok2) || est==='rumbo_a_empresa'){
            await fetch(`/api/viajes/${sid}/reanudar`, { method:'POST', headers: authHeaders() });
          }
        } catch {}
      } catch {}
    }
    function updateNotifCount(list){
      const badge = document.getElementById('notif-count');
      if (badge) badge.textContent = String(list?.length||0);
    }
    function logout(){ localStorage.clear(); window.location.href='/login.html'; }
    function authHeaders(){ return { 'Content-Type':'application/json', 'Authorization': 'Bearer '+token }; }
    function displayEstadoSolicitud(estado){ return estado; }

    let empresaSeleccionada = null;
    let materialesSeleccionados = [];
    let solicitudSeleccionada = null;
    let perfilMateriales = [];
  let perfilCatalogo = [];
  let histDetalleId = null;
  let recoPrevMap = null;
  let recoPrevLayer = null;
  let recoPrevRouteCtrl = null;
  let recoPrevSid = null;
  let recoPrevCoords = null;
  let recoSimMarker = null;
  let recoStartMarker = null;
  let recoSimTimer = null;
  let recoEventSource = null;
  let recoSimSid = null;

    function iniciarUbicacionRecolector(){
      try {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (p)=>{
              const lat = p.coords.latitude;
              const lon = p.coords.longitude;
              fetch(`/api/recolector/${user.id}/ubicacion_actual`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ lat, lon }) }).catch(()=>{});
            },
            async ()=>{
              try {
                const r = await fetch('https://ipapi.co/json');
                const j = await r.json();
                const lat = Number(j?.latitude);
                const lon = Number(j?.longitude);
                if (!isNaN(lat) && !isNaN(lon)) {
                  fetch(`/api/recolector/${user.id}/ubicacion_actual`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ lat, lon }) }).catch(()=>{});
                }
              } catch {}
            },
            { enableHighAccuracy:true, timeout:3000 }
          );
        }
      } catch {}
    }

    async function loadEmpresas(){
      const r = await fetch('/api/empresas', { headers: authHeaders() });
      const list = await r.json();
      const container = document.getElementById('empresas');
      container.innerHTML = '';
      list.forEach(e=>{
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>${e.nombre}</strong> <span class="badge">RUC ${e.ruc}</span></div>
            <div class="muted">Reputación: ${Number(e.reputacion_promedio).toFixed(2)} (${e.resenas_recibidas_count} reseñas)</div>
          </div>
          <div class="right">
            <button class="btn secondary" onclick="verEmpresa(${e.id}, '${e.nombre}', '${e.ruc}', ${Number(e.reputacion_promedio)})">Ver materiales</button>
          </div>
        </div>
        <div class="muted">Materiales: ${(e.materiales||[]).map(m=>`#${m.material_id} S/${m.precio_por_kg}`).join(', ') || '—'}</div>`;
        container.appendChild(div);
      });
    }
    async function verEmpresa(id, nombre, ruc, reputacion){
      empresaSeleccionada = { id, nombre, ruc, reputacion };
      document.getElementById('empresa-titulo').textContent = nombre;
      document.getElementById('empresa-meta').textContent = `RUC ${ruc} · Reputación ${reputacion.toFixed ? reputacion.toFixed(2) : reputacion}`;
      const r = await fetch(`/api/empresas/${id}/materiales`, { headers: authHeaders() });
      const mats = await r.json();
      materialesSeleccionados = mats.map(m=>({ material_id: m.material_id, nombre: m.nombre, precio: Number(m.precio_por_kg), kg: 0, condiciones: m.condiciones || '' }));
      renderMateriales();
      setView('empresa');
      await loadEmpresaResenas(id);
    }
    function renderMateriales(){
      const tbody = document.getElementById('materiales-body');
      tbody.innerHTML = '';
      materialesSeleccionados.forEach((m, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:8px;">${m.nombre}</td>
          <td style="padding:8px; text-align:right;">${m.precio.toFixed(2)}</td>
          <td style="padding:8px; text-align:right;"><input type="number" min="0" step="0.1" value="${m.kg}" style="width:120px;" data-idx="${idx}" /></td>
          <td style="padding:8px; text-align:right;" id="sub-${idx}">0.00</td>
        `;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('input[type="number"]').forEach(inp=>{
        inp.addEventListener('input', (ev)=>{
          const i = Number(ev.target.getAttribute('data-idx'));
          const val = Number(ev.target.value);
          materialesSeleccionados[i].kg = isNaN(val) ? 0 : val;
          actualizarEstimado();
        });
      });
      actualizarEstimado();
      const condText = materialesSeleccionados.map(m=> m.condiciones ? `${m.nombre}: ${m.condiciones}` : '').filter(Boolean).join(' · ');
      document.getElementById('empresa-cond').textContent = condText ? `Condiciones: ${condText}` : '';
    }
    function actualizarEstimado(){
      let total = 0;
      materialesSeleccionados.forEach((m, idx)=>{
        const sub = m.kg * m.precio;
        total += sub;
        const el = document.getElementById('sub-'+idx);
        if (el) el.textContent = sub.toFixed(2);
      });
      document.getElementById('estimado-total').textContent = 'S/ ' + total.toFixed(2);
      const dchk = document.getElementById('delivery-check');
      const dhint = document.getElementById('delivery-hint');
      const dact = document.getElementById('delivery-actual-check');
      const dactHint = document.getElementById('delivery-actual-hint');
      const hasCur = user && user.current_lat!=null && user.current_lon!=null && !isNaN(Number(user.current_lat)) && !isNaN(Number(user.current_lon));
      if (total < 35){
        if (dchk) { dchk.disabled = true; dchk.checked = false; }
        if (dact) { dact.disabled = true; dact.checked = false; }
        if (dhint) dhint.textContent = 'Delivery no disponible (mínimo S/ 35)';
        if (dactHint) dactHint.style.display = 'none';
      } else {
        if (dchk) dchk.disabled = false;
        if (dhint) dhint.textContent = 'Delivery habilitado';
        if (dact) { dact.disabled = !hasCur; if (!hasCur) dact.checked = false; }
        if (dactHint) dactHint.style.display = hasCur ? 'none' : '';
      }
    }
    async function loadEmpresaResenas(empresaId){
      const ul = document.getElementById('empresa-resenas-list');
      if (ul) ul.innerHTML = '';
      const r = await fetch(`/api/resenas/empresa/${empresaId}`, { headers: authHeaders() });
      const list = await r.json();
      const target = document.getElementById('empresa-resenas-list');
      if (!target) return;
      list.forEach(re=>{
        const li = document.createElement('li');
        li.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>Puntaje ${Number(re.puntaje)}</strong> · Tx #${re.transaccion_id}</div>
            <div class="muted">${re.mensaje || '—'}</div>
          </div>
          <div class="right"><span class="badge">${new Date(re.creado_en).toLocaleString()}</span></div>
        </div>`;
        target.appendChild(li);
      });
    }
    function empresaResenasRefresh(){ if (empresaSeleccionada) loadEmpresaResenas(empresaSeleccionada.id); }
    async function confirmarSolicitud(){
      if (!empresaSeleccionada) return;
      const totalKg = materialesSeleccionados.reduce((a,m)=>a+(m.kg||0),0);
      if (totalKg <= 0) { alert('Indica los kg a entregar para al menos un material.'); return; }
      if (!confirm('Crear solicitud con empresa '+empresaSeleccionada.nombre+' y estimado '+document.getElementById('estimado-total').textContent+'?')) return;
      const items = materialesSeleccionados.filter(m=>Number(m.kg)>0).map(m=>({ material_id: Number(m.material_id), kg: Number(m.kg) }));
      const delivery = Boolean(document.getElementById('delivery-check')?.checked);
      const delivery_use_current = Boolean(document.getElementById('delivery-actual-check')?.checked);
      const delivery_consent = delivery ? true : false;
      const totalText = document.getElementById('estimado-total').textContent||'S/ 0';
      const totalNum = Number(totalText.replace('S/','').trim());
      if (delivery && totalNum < 35) { alert('Para solicitar delivery el total mínimo es S/ 35'); return; }
      const r = await fetch('/api/solicitudes', { method:'POST', headers: authHeaders(), body: JSON.stringify({ usuario_id: user.id, empresa_id: empresaSeleccionada.id, items, delivery, delivery_consent, delivery_terms_version: 'v1', delivery_use_current }) });
      let j;
      try { j = await r.json(); } catch { j = {}; }
      if (j?.error === 'delivery_min_total') { alert('Para solicitar delivery el total mínimo es S/ 35'); return; }
      if (j?.error === 'delivery_cooldown') {
        const secs = Number(j?.retry_after_sec||60);
        showErrorBox('Penalidad activa', `No puedes solicitar delivery por ${secs} segundos`);
        return;
      }
      alert('Solicitud creada: #'+j.id);
      setView('solicitudes');
    }

    async function loadVehiculosRecolector(){
      try {
        const sel = document.getElementById('reco-vehiculo');
        if (!sel) return;
        sel.innerHTML = '';
        const r = await fetch(`/api/recolector/${user.id}/vehiculos`, { headers: authHeaders() });
        const list = await r.json();
        const actives = Array.isArray(list) ? list.filter(v=> Boolean(v?.activo)) : [];
        const saved = Number(localStorage.getItem('reco_vehiculo_id')||'');
        actives.forEach(v=>{
          const opt = document.createElement('option');
          opt.value = String(v.id);
          opt.textContent = `${v.placa||('Vehículo '+v.id)} · ${Number(v.capacidad_kg||0)} kg`;
          sel.appendChild(opt);
        });
        if (actives.length===0){
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'Sin vehículos activos';
          sel.appendChild(opt);
        }
        if (!Number.isNaN(saved)) {
          const ok = actives.some(v=> Number(v.id)===saved);
          if (ok) sel.value = String(saved);
        }
        sel.onchange = ()=>{ const v = Number(sel.value||''); if (!Number.isNaN(v)) localStorage.setItem('reco_vehiculo_id', String(v)); };
      } catch {}
    }


    async function loadRecolectorFeed(){
      const r = await fetch('/api/recolector/feed', { headers: authHeaders() });
      const list = await r.json();
      const ul = document.getElementById('reco-feed');
      if (!ul) return;
      ul.innerHTML = '';
      if (!Array.isArray(list) || list.length===0){
        const li = document.createElement('li');
        li.innerHTML = `<div class="row jc-between ai-center"><div><strong>No hay solicitudes publicadas</strong><div class="muted">Espera a que un usuario cree una solicitud delivery.</div></div><div class="right"><button class="btn" onclick="loadRecolectorFeed()">Actualizar</button></div></div>`;
        ul.appendChild(li);
        return;
      }
      list.forEach(s=>{
        const li = document.createElement('li');
        li.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>Solicitud #${s.id}</strong> → Empresa ${s.empresa_id}</div>
            <div class="muted" data-sid="${s.id}">Clasificación: ${s.clasificacion_distancia||'—'} · Fee: S/ ${Number(s.delivery_fee||0).toFixed(2)}</div>
          </div>
          <div class="right">
            <button class="btn" onclick="recolectorAceptar(${s.id})">Aceptar</button>
            <button class="btn" onclick="verPrevisualizacion(${s.id})">Previsualización</button>
            <button class="btn" onclick="verDetalleSolicitud(${s.id})">Detalles</button>
            
          </div>
        </div>`;
        ul.appendChild(li);
        (async function(){
          try {
            const pr = await fetch(`/api/recolector/previsualizacion/${s.id}?viewer_id=${user.id}`, { headers: authHeaders() });
            const pj = await pr.json();
            const rLat = pj?.recolector?.lat; const rLon = pj?.recolector?.lon;
            const uLat = pj?.usuario?.lat; const uLon = pj?.usuario?.lon;
            const eLat = pj?.empresa?.lat; const eLon = pj?.empresa?.lon;
            let kmRU = Number(pj?.dist_recolector_usuario_km || 0);
            let kmUE = Number(pj?.dist_usuario_empresa_km || 0);
            let kmRUroute = NaN, kmUEroute = NaN;
            if (rLat!=null && rLon!=null && uLat!=null && uLon!=null) {
              const qRU = `${Number(rLon)},${Number(rLat)};${Number(uLon)},${Number(uLat)}`;
              try {
                const ruResp = await fetch(`https://router.project-osrm.org/route/v1/driving/${qRU}?overview=false`);
                const ruJson = await ruResp.json();
                kmRUroute = Number(ruJson?.routes?.[0]?.distance||NaN)/1000;
              } catch {}
            }
            if (uLat!=null && uLon!=null && eLat!=null && eLon!=null) {
              const qUE = `${Number(uLon)},${Number(uLat)};${Number(eLon)},${Number(eLat)}`;
              try {
                const ueResp = await fetch(`https://router.project-osrm.org/route/v1/driving/${qUE}?overview=false`);
                const ueJson = await ueResp.json();
                kmUEroute = Number(ueJson?.routes?.[0]?.distance||NaN)/1000;
              } catch {}
            }
            const kmRUfinal = !isNaN(kmRUroute) ? kmRUroute : kmRU;
            const kmUEfinal = !isNaN(kmUEroute) ? kmUEroute : kmUE;
            const kmTotal = (isNaN(kmRUfinal)?0:kmRUfinal) + (isNaN(kmUEfinal)?0:kmUEfinal);
            function clasificarDistanciaPorKm(km){ if (km <= 2) return 'ideal'; if (km <= 6) return 'normal'; return 'larga'; }
            function calcularFeePorBanda(banda, km){ let min=0,max=0,span=0; if (banda==='ideal'){min=3.5;max=4.0;span=2;} else if (banda==='normal'){min=4.5;max=6.0;span=4;} else {min=6.0;max=8.0;span=12;} let f=0; if (banda==='ideal') f=Math.min(km/2,1); else if (banda==='normal') f=Math.min((km-2)/(6-2),1); else f=Math.min((km-6)/span,1); const bruto=min+(max-min)*Math.max(0,Math.min(1,f)); const rounded=Math.round(bruto*10)/10; return Math.min(rounded,max); }
            const banda = clasificarDistanciaPorKm(kmTotal);
            const fee = calcularFeePorBanda(banda, kmTotal);
            const el = li.querySelector('.muted[data-sid="'+s.id+'"]');
            if (el) el.textContent = `Clasificación: ${banda} · Fee: S/ ${fee.toFixed(2)} · Recolector→Usuario: ${(!isNaN(kmRUfinal)?kmRUfinal:0).toFixed(2)} km · Usuario→Empresa: ${(!isNaN(kmUEfinal)?kmUEfinal:0).toFixed(2)} km · Total: ${kmTotal.toFixed(2)} km`;
          } catch {}
        })();
      });
      try{
        const rc = await fetch(`/api/recolector/${user.id}/en_curso`, { headers: authHeaders() });
        const cur = await rc.json();
        const curWrap = document.getElementById('reco-current');
        const curSid = document.getElementById('reco-current-sid');
        if (Array.isArray(cur) && cur.length>0){
          if (curWrap) curWrap.style.display='';
          if (curSid) curSid.textContent = String(cur[0].id);
          const ubBtn = document.getElementById('reco-ubic-btn');
          if (ubBtn) ubBtn.disabled = false;
          recoSimSid = Number(cur[0].id);
          const s0 = cur[0];
          const hstate = String(s0?.handoff_state||'');
          const isHandoffMine = Number(s0?.handoff_recolector_id||0) === Number(user.id);
          const metaTxt = hstate==='en_intercambio' ? 'Handoff en intercambio' : 'En curso';
          const rightBtns = hstate==='en_intercambio' && isHandoffMine
            ? `<button class=\"btn\" onclick=\"usuarioVerViaje(${s0.id})\">Ver viaje</button>`
            : `<button class=\"btn\" onclick=\"usuarioVerViaje(${s0.id})\">Ver viaje</button> <button class=\"btn\" onclick=\"solicitarHandoff(${s0.id})\">Solicitar handoff</button> <button class=\"btn secondary\" onclick=\"recolectorFinalizarRuta(${s0.id})\">Finalizar ruta</button>`;
          const li = document.createElement('li');
          li.innerHTML = `<div class=\"row\" style=\"justify-content:space-between;\"><div><div><strong>Solicitud #${s0.id}</strong></div><div class=\"muted\">${metaTxt}</div></div><div class=\"right\">${rightBtns}</div></div>`;
          ul.insertBefore(li, ul.firstChild);
        } else {
          if (curWrap) curWrap.style.display='none';
        }
      }catch{}
    }

    async function loadHandoffFeed(){
      const ul = document.getElementById('handoff-feed');
      if (!ul) return;
      ul.innerHTML = '';
      try {
        const r = await fetch(`/api/recolector/handoff/publicados?viewer_id=${user.id}`, { headers: authHeaders() });
        if (!r.ok) return;
        const list = await r.json();
        if (!Array.isArray(list) || list.length===0){
          const li = document.createElement('li');
          li.className = 'muted';
          li.textContent = 'Sin handoffs publicados';
          ul.appendChild(li);
          return;
        }
        list.forEach(s=>{
          const li = document.createElement('li');
          const pick = (s.handoff_pick_lat!=null && s.handoff_pick_lon!=null) ? `${Number(s.handoff_pick_lat).toFixed(5)}, ${Number(s.handoff_pick_lon).toFixed(5)}` : '—';
          li.innerHTML = `<div class="row jc-between ai-center"><div><strong>Solicitud #${s.id}</strong><div class="muted">Punto de encuentro: ${pick}</div></div><div><button class="btn" onclick="usuarioVerViaje(${s.id})">Ver mapa</button> <button class="btn primary" onclick="aceptarHandoff(${s.id})">Aceptar handoff</button></div></div>`;
          ul.appendChild(li);
        });
      } catch {}
    }

    async function solicitarHandoff(sid){
      try {
        const r = await fetch(`/api/recolector/${sid}/handoff/request`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ recolector_id: user.id }) });
        if (!r.ok) { alert('No se pudo solicitar handoff'); return; }
        alert('Handoff publicado');
        loadHandoffFeed();
      } catch { alert('Error solicitando handoff'); }
    }

    function startHandoffPublish(sid){
      try { if (viaHandoffPublishTimer) { clearInterval(viaHandoffPublishTimer); } } catch {}
      viaHandoffPublishTimer = setInterval(()=>{
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(async (pos)=>{
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            try { await fetch(`/api/viajes/${sid}/handoff/posicion`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ lat, lon }) }); } catch {}
          });
        }
      }, 1500);
    }

    async function aceptarHandoff(sid){
      try {
        const r = await fetch(`/api/recolector/${sid}/handoff/accept`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ recolector_id: user.id }) });
        if (!r.ok) { alert('No se pudo aceptar handoff'); return; }
        alert('Handoff aceptado, dirígete al punto y mantén el mapa abierto');
        try{ await loadRecolectorFeed(); }catch{}
        try{ await loadHandoffFeed(); }catch{}
        viaHandoffServerDriven = true;
        usuarioVerViaje(sid);
        setTimeout(()=>{ try { ensureHandoffRouteAndSim(sid); } catch {} }, 800);
      } catch { alert('Error al aceptar handoff'); }
    }

    async function confirmarHandoffOld(sid){
      try {
        const r = await fetch(`/api/recolector/${sid}/handoff/confirm_old`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ recolector_id: user.id }) });
        const btn = document.getElementById('btn-handoff-old');
        if (!r.ok) { if (btn) btn.disabled = true; const tx = await r.text(); alert(tx||'No se pudo confirmar entrega'); return; }
        if (btn) { btn.disabled = true; try{ btn.remove(); }catch{} }
        try {
          const data = await r.json();
          if (String(data?.handoff_state||'') === 'completado'){
            alert('Handoff completado, ahora el nuevo recolector continúa');
            try { if (viaHandoffPublishTimer) { clearInterval(viaHandoffPublishTimer); } } catch {}
            try { viaHandoffPublished = false; viaHandoffInExchange = false; viaPausedAtUser = false; } catch {}
            try { if (viaHandoffMarker) { viaHandoffMarker.remove(); viaHandoffMarker = null; } } catch {}
            try { const meta = document.getElementById('usr-route-meta-viaje'); if (meta) meta.innerHTML = 'En camino a empresa: <strong>Handoff completado</strong>'; } catch {}
            loadRecolectorCur();
            return;
          }
        } catch {}
        alert('Confirmaste la entrega al nuevo recolector');
      } catch { alert('Error al confirmar entrega'); }
    }

    async function confirmarHandoffNew(sid){
      try {
        const r = await fetch(`/api/recolector/${sid}/handoff/confirm_new`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ recolector_id: user.id }) });
        const btn = document.getElementById('btn-handoff-new');
        if (!r.ok) { if (btn) btn.disabled = true; const tx = await r.text(); alert(tx||'No se pudo confirmar recepción'); return; }
        const data = await r.json();
        if (String(data?.handoff_state||'') === 'completado'){
          if (btn) { btn.disabled = true; try{ btn.remove(); }catch{} }
          alert('Handoff completado, ahora eres responsable del pedido');
          try { if (viaHandoffPublishTimer) { clearInterval(viaHandoffPublishTimer); } } catch {}
          try { viaHandoffPublished = false; viaHandoffInExchange = false; viaPausedAtUser = false; } catch {}
          try { if (viaHandoffMarker) { viaHandoffMarker.remove(); viaHandoffMarker = null; } } catch {}
          try { const meta = document.getElementById('usr-route-meta-viaje'); if (meta) meta.innerHTML = 'En camino a empresa: <strong>Handoff completado</strong>'; } catch {}
          loadRecolectorCur();
        } else {
          if (btn) { btn.disabled = true; try{ btn.remove(); }catch{} }
          alert('Confirmaste la recepción, esperando confirmación del otro recolector');
        }
      } catch { alert('Error al confirmar recepción'); }
    }

    function ensureHandoffRouteAndSim(sid){
      try {
        if (!viaHandoffInExchange) return;
        if (viaHandoffSimTimer) { clearInterval(viaHandoffSimTimer); viaHandoffSimTimer = null; }
        let rLat = null, rLon = null;
        const getRecoPos = async ()=>{
          try {
            await new Promise((resolve)=>{
              if (!navigator.geolocation) return resolve(null);
              navigator.geolocation.getCurrentPosition(p=>{ rLat = p.coords.latitude; rLon = p.coords.longitude; resolve(null); }, ()=>resolve(null), { enableHighAccuracy:true, timeout:2000 });
            });
          } catch {}
          if (rLat==null || rLon==null){
            try { const rp = await fetch(`/api/recolector/${user.id}/perfil`, { headers: authHeaders() }); if (rp.ok) { const pj = await rp.json(); rLat = pj?.lat!=null?Number(pj.lat):null; rLon = pj?.lon!=null?Number(pj.lon):null; } } catch {}
          }
        };
        const go = async ()=>{
          await getRecoPos();
          if (rLat==null || rLon==null || viaHandoffPickLat==null || viaHandoffPickLon==null) return;
          if (viaHandoffRouteCtrl) { try { viaHandoffRouteCtrl.remove(); } catch {} viaHandoffRouteCtrl=null; }
          viaHandoffRouteCtrl = L.Routing.control({
            language: 'es',
            waypoints: [ L.latLng(rLat, rLon), L.latLng(Number(viaHandoffPickLat), Number(viaHandoffPickLon)) ],
            router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', language: 'es' }),
            routeWhileDragging: false,
            showAlternatives: false,
            addWaypoints: false,
            draggableWaypoints: false,
            createMarker: function() { return null; },
            fitSelectedRoutes: false,
            lineOptions: { styles: [{ color: '#06b6d4', weight: 4 }] }
          }).addTo(viaMap);
          viaHandoffRouteCtrl.on('routesfound', (e)=>{
            const coords = e?.routes?.[0]?.coordinates || [];
            viaHandoffCoords = Array.isArray(coords) ? coords.map(c=> L.latLng(c.lat, c.lng)) : null;
            if (!viaHandoffCoords || viaHandoffCoords.length<2) return;
            // Place marker at last known handoff position if available, else at route start
            try {
              if (!viaHandoffMarker) {
                let initLatLng = viaHandoffCoords[0];
                if (viaHandoffHasPos && viaHandoffLastLat!=null && viaHandoffLastLon!=null) {
                  // Snap last pos to nearest route point for smoother resume
                  let best = 0, bd = Infinity;
                  for (let k=0; k<viaHandoffCoords.length; k++){
                    const p = viaHandoffCoords[k];
                    const dd = (p.lat-Number(viaHandoffLastLat))*(p.lat-Number(viaHandoffLastLat)) + (p.lng-Number(viaHandoffLastLon))*(p.lng-Number(viaHandoffLastLon));
                    if (dd<bd){ bd=dd; best=k; }
                  }
                  initLatLng = viaHandoffCoords[Math.max(0, Math.min(best, viaHandoffCoords.length-1))];
                }
                viaHandoffMarker = L.marker(initLatLng, { icon: recolectorHandIcon, zIndexOffset: 900 }).addTo(viaMap);
              }
            } catch {}
            const pts = viaHandoffCoords;
            const n = pts.length;
            function distMeters(lat1, lon1, lat2, lon2){
              const toRad = (x)=> x*Math.PI/180;
              const R = 6371000;
              const dLat = toRad(lat2-lat1);
              const dLon = toRad(lon2-lon1);
              const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
              const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
              return R*c;
            }
            const lens = [];
            let total = 0;
            for (let k=1; k<n; k++){
              const a = pts[k-1];
              const b = pts[k];
              const d = distMeters(a.lat, a.lng, b.lat, b.lng);
              lens.push(d);
              total += d;
            }
            const cum = [0];
            for (let k=0; k<lens.length; k++) cum.push(cum[cum.length-1] + lens[k]);
            const speed = 7 * (typeof viaSpeedMult === 'number' ? viaSpeedMult : 1);
            let lastPub = 0;
            // Compute resume offset distance if we have a last known handoff position
            let offsetDist = 0;
            if (viaHandoffHasPos && viaHandoffLastLat!=null && viaHandoffLastLon!=null) {
              let best = 0, bd = Infinity;
              for (let k=0; k<pts.length; k++){
                const p = pts[k];
                const dd = (p.lat-Number(viaHandoffLastLat))*(p.lat-Number(viaHandoffLastLat)) + (p.lng-Number(viaHandoffLastLon))*(p.lng-Number(viaHandoffLastLon));
                if (dd<bd){ bd=dd; best=k; }
              }
              offsetDist = cum[Math.max(0, Math.min(best, cum.length-1))] || 0;
            }
            const t0 = performance.now() - (offsetDist / speed) * 1000;
            function step(){
              const now = performance.now();
              const dist = Math.min(((now - t0)/1000) * speed, total);
              let idx = 0;
              while (idx < lens.length && cum[idx+1] < dist) idx++;
              const segStart = cum[idx];
              const segLen = lens[idx] || 0;
              const u = segLen>0 ? (dist - segStart)/segLen : 0;
              const a = pts[idx];
              const b = pts[Math.min(idx+1, n-1)];
              const lat = a.lat + (b.lat - a.lat) * u;
              const lon = a.lng + (b.lng - a.lng) * u;
              try { if (viaHandoffMarker) viaHandoffMarker.setLatLng([lat, lon]); } catch {}
              // Track last known handoff position
              viaHandoffHasPos = true; viaHandoffLastLat = lat; viaHandoffLastLon = lon;
              try { localStorage.setItem('handoff_last_pos_'+sid, JSON.stringify({ lat, lon })); } catch {}
              if (!viaHandoffServerDriven && (now - lastPub >= 300)){
                lastPub = now;
                try { fetch(`/api/viajes/${sid}/handoff/posicion`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ lat, lon }) }); } catch {}
              }
              const dM = distanciaMetros(lat, lon, Number(viaHandoffPickLat), Number(viaHandoffPickLon));
              if (dM <= 20) { clearInterval(viaHandoffSimTimer); viaHandoffSimTimer=null; return; }
            }
            if (!viaHandoffServerDriven) viaHandoffSimTimer = setInterval(step, 33);
          });
        };
        go();
      } catch {}
    }

  function clearRecoPreview(){
    const panel = document.getElementById('reco-preview');
    const meta = document.getElementById('reco-route-meta');
    if (panel) panel.style.display = 'none';
    if (meta) meta.textContent = '';
    if (recoPrevLayer && recoPrevMap) { recoPrevLayer.remove(); recoPrevLayer = null; }
    if (recoPrevRouteCtrl) { recoPrevRouteCtrl.remove(); recoPrevRouteCtrl = null; }
    if (recoPrevMap) { try { recoPrevMap.remove(); } catch {} recoPrevMap = null; }
    recoPrevSid = null;
    recoPrevCoords = null;
    if (recoStartMarker) { try { recoStartMarker.remove(); } catch {} recoStartMarker = null; }
    if (recoSimMarker) { recoSimMarker.remove(); recoSimMarker = null; }
    if (recoSimTimer) { clearInterval(recoSimTimer); recoSimTimer = null; }
    if (recoEventSource) { try { recoEventSource.close(); } catch {} recoEventSource = null; }
    try { localStorage.removeItem('last_reco_sid'); } catch {}
  }

    async function waitRecoRouteReady(maxMs){
      const deadline = Date.now() + (typeof maxMs === 'number' ? maxMs : 8000);
      return new Promise((resolve)=>{
        const t = setInterval(()=>{
          if (Array.isArray(recoPrevCoords) && recoPrevCoords.length >= 2){ clearInterval(t); resolve(true); }
          if (Date.now() >= deadline){ clearInterval(t); resolve(false); }
        }, 150);
      });
    }
  async function verPrevisualizacion(sid){
      const panel = document.getElementById('reco-preview');
      if (panel && panel.style.display !== 'none' && recoPrevSid === sid) { clearRecoPreview(); return; }
      panel.style.display = 'block';
      const r = await fetch(`/api/recolector/previsualizacion/${sid}?viewer_id=${user.id}`, { headers: authHeaders() });
      const j = await r.json();
      let rLat = null, rLon = null;
      try {
        await new Promise((resolve)=>{
          if (!navigator.geolocation) return resolve(null);
          navigator.geolocation.getCurrentPosition(p=>{ rLat = p.coords.latitude; rLon = p.coords.longitude; resolve(null); }, ()=>resolve(null), { enableHighAccuracy:true, timeout:3000 });
        });
      } catch {}
      if (rLat==null || rLon==null){ rLat = j?.recolector?.lat ?? null; rLon = j?.recolector?.lon ?? null; }
      const uLat = j?.usuario?.lat ?? null;
      const uLon = j?.usuario?.lon ?? null;
      const eLat = j?.empresa?.lat ?? null;
      const eLon = j?.empresa?.lon ?? null;
      const ru = j?.dist_recolector_usuario_km!=null ? `${Number(j.dist_recolector_usuario_km).toFixed(2)} km` : '—';
      const ue = j?.dist_usuario_empresa_km!=null ? `${Number(j.dist_usuario_empresa_km).toFixed(2)} km` : '—';
      const meta = document.getElementById('reco-route-meta');
      meta.innerHTML = `Recolector → Usuario: <strong>${ru}</strong> · Usuario → Empresa: <strong>${ue}</strong>`;
      const mapDiv = document.getElementById('reco-map');
      if (!recoPrevMap){ recoPrevMap = L.map(mapDiv).setView([uLat||-12.05, uLon||-77.03], 13); L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(recoPrevMap); }
      const toFit = [];
      if (rLat!=null && rLon!=null) toFit.push([rLat, rLon]);
      if (uLat!=null && uLon!=null) toFit.push([uLat, uLon]);
      if (eLat!=null && eLon!=null) toFit.push([eLat, eLon]);
      if (toFit.length>0) recoPrevMap.fitBounds(toFit);
      if (recoPrevLayer) { recoPrevLayer.remove(); recoPrevLayer=null; }
      const mkIcon = (t,b)=> L.divIcon({ className: 'marker-div', html: `<div style="background:${b};color:#081012;border-radius:999px;padding:4px 8px;border:1px solid #0b1c14;box-shadow:0 3px 10px rgba(0,0,0,.25);font-weight:700;font-size:12px;">${t}</div>`, iconSize: [1,1], iconAnchor: [14,28], popupAnchor: [0,-28] });
      const recoIcon = L.icon({ iconUrl: '/img/recolector.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
      const hogarIcon = L.icon({ iconUrl: '/img/hogar.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
      const empresaIcon = L.icon({ iconUrl: '/img/empresa.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
      const layers = [];
      if (rLat!=null && rLon!=null) layers.push(L.marker([rLat, rLon], { icon: mkIcon('Tú','#a7f3d0') }).bindPopup(`Tú: ${user?.nombre||('Recolector #'+user?.id)}`));
      if (uLat!=null && uLon!=null) layers.push(L.marker([uLat, uLon], { icon: hogarIcon }).bindPopup(`Usuario: ${j?.usuario_nombre||('Usuario')}`));
      if (eLat!=null && eLon!=null) layers.push(L.marker([eLat, eLon], { icon: empresaIcon }).bindPopup(`Empresa: ${j?.empresa_nombre||('Empresa')}`));
      recoPrevLayer = L.layerGroup(layers).addTo(recoPrevMap);
      if (recoPrevRouteCtrl) { recoPrevRouteCtrl.remove(); recoPrevRouteCtrl = null; }
      if (rLat!=null && rLon!=null && uLat!=null && uLon!=null && eLat!=null && eLon!=null) {
        recoPrevRouteCtrl = L.Routing.control({
          language: 'es',
          waypoints: [ L.latLng(rLat, rLon), L.latLng(uLat, uLon), L.latLng(eLat, eLon) ],
          router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', language: 'es' }),
          routeWhileDragging: false,
          showAlternatives: false,
          addWaypoints: false,
          draggableWaypoints: false,
          createMarker: function() { return null; },
          fitSelectedRoutes: true,
          lineOptions: { styles: [{ color: '#22c55e', weight: 4 }] }
        }).addTo(recoPrevMap);
        recoPrevRouteCtrl.on('routesfound', (e)=>{
          const sum = e?.routes?.[0]?.summary;
          if (sum) {
            const km = (sum.totalDistance/1000).toFixed(2);
            const min = Math.round(sum.totalTime/60);
            meta.innerHTML = `Objetivo: <strong>Recolector → Usuario → Empresa</strong> · Distancia: <strong>${km} km</strong> · Tiempo: <strong>${min} min</strong>`;
          }
          const coords = e?.routes?.[0]?.coordinates || [];
          recoPrevCoords = Array.isArray(coords) ? coords.map(c=> L.latLng(c.lat, c.lng)) : null;
        });
      }
      recoPrevSid = sid;
      try { localStorage.setItem('last_reco_sid', String(sid)); } catch {}
    }

    function simularRecoViaje(){
      if (!recoPrevMap || !recoPrevCoords || recoPrevCoords.length < 2) return;
      if (recoSimMarker) { recoSimMarker.remove(); recoSimMarker = null; }
      if (recoSimTimer) { clearInterval(recoSimTimer); recoSimTimer = null; }
      const partidaIconSim = L.icon({ iconUrl: '/img/partida.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
      recoSimMarker = L.marker(recoPrevCoords[0], { icon: partidaIconSim }).addTo(recoPrevMap);
      let i = 0;
      recoSimTimer = setInterval(()=>{
        i++;
        if (i >= recoPrevCoords.length) { clearInterval(recoSimTimer); recoSimTimer = null; return; }
        recoSimMarker.setLatLng(recoPrevCoords[i]);
      }, 400);
    }

  function runRecoSim(publish){
    if (!recoPrevMap || !recoPrevCoords || recoPrevCoords.length < 2) return;
    if (recoSimMarker) { recoSimMarker.remove(); recoSimMarker = null; }
    if (recoSimTimer) { clearInterval(recoSimTimer); recoSimTimer = null; }
    const partidaIconSim = L.icon({ iconUrl: '/img/partida.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
    const recolectorIconSim = L.icon({ iconUrl: '/img/recolector.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
    try { if (!recoStartMarker && recoPrevCoords[0]) { recoStartMarker = L.marker(recoPrevCoords[0], { icon: partidaIconSim }).addTo(recoPrevMap); } } catch {}
    recoSimMarker = L.marker(recoPrevCoords[0], { icon: recolectorIconSim }).addTo(recoPrevMap);
      const pts = recoPrevCoords;
      const n = pts.length;
      function distMeters(lat1, lon1, lat2, lon2){
        const toRad = (x)=> x*Math.PI/180;
        const R = 6371000;
        const dLat = toRad(lat2-lat1);
        const dLon = toRad(lon2-lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
        const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R*c;
      }
      const lens = [];
      let total = 0;
      for (let k=1; k<n; k++){
        const a = pts[k-1];
        const b = pts[k];
        const d = distMeters(a.lat, a.lng, b.lat, b.lng);
        lens.push(d);
        total += d;
      }
      const cum = [0];
      for (let k=0; k<lens.length; k++) cum.push(cum[cum.length-1] + lens[k]);
      const speed = 7;
      let lastPub = 0;
      const t0 = performance.now();
      function step(){
        const now = performance.now();
        const dist = Math.min(((now - t0)/1000) * speed, total);
        let idx = 0;
        while (idx < lens.length && cum[idx+1] < dist) idx++;
        const segStart = cum[idx];
        const segLen = lens[idx] || 0;
        const u = segLen>0 ? (dist - segStart)/segLen : 0;
        const a = pts[idx];
        const b = pts[Math.min(idx+1, n-1)];
        const lat = a.lat + (b.lat - a.lat) * u;
        const lon = a.lng + (b.lng - a.lng) * u;
        recoSimMarker.setLatLng([lat, lon]);
        if (publish && recoPrevSid && now - lastPub >= 300){
          lastPub = now;
          try { fetch(`/api/viajes/${recoPrevSid}/posicion`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ lat, lon, i: idx }) }); } catch {}
        }
        if (dist >= total){ clearInterval(recoSimTimer); recoSimTimer = null; return; }
      }
      recoSimTimer = setInterval(step, 33);
    }

    function iniciarRecoPreview(){ if (recoEventSource) return; runRecoSim(false); }
    function iniciarSimulacionOficial(){ runRecoSim(true); }

    async function recoVerUbicacion(sid){
      const panel = document.getElementById('reco-preview');
      const sec = document.getElementById('view-recolector');
      const meta = document.getElementById('reco-route-meta');
      if (sec) sec.hidden = false;
      if (panel) panel.style.display = 'block';
      if (!sid || isNaN(Number(sid))){
        try {
          const rc = await fetch(`/api/recolector/${user.id}/en_curso`, { headers: authHeaders() });
          const cur = await rc.json();
          const found = Array.isArray(cur) && cur.length>0 ? Number(cur[0].id) : null;
          if (found){ sid = found; recoSimSid = found; const cs = document.getElementById('reco-current-sid'); if (cs) cs.textContent = String(found); const ub = document.getElementById('reco-ubic-btn'); if (ub) ub.disabled = false; }
        } catch {}
      }
      if (!sid || isNaN(Number(sid))) { return; }
      if (recoSimTimer) { try { clearInterval(recoSimTimer); } catch {} recoSimTimer = null; }
      if (recoSimMarker) { try { recoSimMarker.remove(); } catch {} recoSimMarker = null; }
      try {
        const rr = await fetch(`/api/viajes/${sid}/coords`, { headers: authHeaders() });
        const jj = await rr.json();
        const pts = Array.isArray(jj?.points) ? jj.points.map(p=> L.latLng(Number(p.lat), Number(p.lon))) : [];
        const pr = await fetch(`/api/recolector/previsualizacion/${sid}?viewer_id=${user.id}`, { headers: authHeaders() });
        const pj = await pr.json();
        const rLat = pj?.recolector?.lat ?? null;
        const rLon = pj?.recolector?.lon ?? null;
        const uLat = pj?.usuario?.lat ?? null;
        const uLon = pj?.usuario?.lon ?? null;
        const eLat = pj?.empresa?.lat ?? null;
        const eLon = pj?.empresa?.lon ?? null;
        const mapDiv = document.getElementById('reco-map');
        if (recoPrevMap) { try { recoPrevMap.remove(); } catch {} recoPrevMap = null; }
        if (mapDiv) { try { mapDiv.innerHTML = ''; mapDiv.style.minHeight = '300px'; } catch {} }
        async function waitVisible(el, maxMs){
          const deadline = Date.now() + (typeof maxMs==='number'?maxMs:1200);
          return new Promise((resolve)=>{
            const t = setInterval(()=>{
              const ok = el && el.offsetWidth>0 && el.offsetHeight>0;
              if (ok){ clearInterval(t); resolve(true); }
              else if (Date.now()>=deadline){ clearInterval(t); resolve(false); }
            }, 50);
          });
        }
        await waitVisible(mapDiv, 1500);
        const baseLat = (pts[0]?.lat ?? uLat ?? -12.05);
        const baseLon = (pts[0]?.lng ?? uLon ?? -77.03);
        recoPrevMap = L.map(mapDiv).setView([baseLat, baseLon], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(recoPrevMap);
        if (recoPrevLayer) { try { recoPrevLayer.remove(); } catch {} recoPrevLayer = null; }
        if (recoPrevRouteCtrl) { try { recoPrevRouteCtrl.remove(); } catch {} recoPrevRouteCtrl = null; }
        if (Array.isArray(pts) && pts.length>=2){
          recoPrevCoords = pts;
          const poly = L.polyline(pts, { color:'#22c55e', weight:4 }).addTo(recoPrevMap);
          try { recoPrevMap.fitBounds(poly.getBounds()); } catch {}
          if (meta) meta.textContent = 'Simulación en curso';
          try { const partidaIconSim = L.icon({ iconUrl: '/img/partida.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] }); if (!recoStartMarker) { recoStartMarker = L.marker(recoPrevCoords[0], { icon: partidaIconSim }).addTo(recoPrevMap); } } catch {}
        } else if (rLat!=null && rLon!=null && uLat!=null && uLon!=null && eLat!=null && eLon!=null) {
          recoPrevRouteCtrl = L.Routing.control({
            language: 'es',
            waypoints: [ L.latLng(rLat, rLon), L.latLng(uLat, uLon), L.latLng(eLat, eLon) ],
            router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', language: 'es' }),
            routeWhileDragging: false,
            showAlternatives: false,
            addWaypoints: false,
            draggableWaypoints: false,
            createMarker: function() { return null; },
            fitSelectedRoutes: true,
            lineOptions: { styles: [{ color: '#22c55e', weight: 4 }] }
          }).addTo(recoPrevMap);
          recoPrevRouteCtrl.on('routesfound', (e)=>{
            const coords = e?.routes?.[0]?.coordinates || [];
            recoPrevCoords = Array.isArray(coords) ? coords.map(c=> L.latLng(c.lat, c.lng)) : null;
            try { const partidaIconSim = L.icon({ iconUrl: '/img/partida.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] }); if (!recoStartMarker && Array.isArray(recoPrevCoords) && recoPrevCoords[0]) { recoStartMarker = L.marker(recoPrevCoords[0], { icon: partidaIconSim }).addTo(recoPrevMap); } } catch {}
          });
        }
        setTimeout(()=>{ try { recoPrevMap.invalidateSize(); } catch {} }, 50);
      } catch {}
      if (recoEventSource) { try { recoEventSource.close(); } catch {} recoEventSource = null; }
      recoEventSource = new EventSource(`/api/viajes/${sid}/stream`);
      function snapToRouteReco(lat, lon){
        if (!Array.isArray(recoPrevCoords) || recoPrevCoords.length<2) return [lat, lon];
        let best = 0, bd = Infinity;
        for (let k=0; k<recoPrevCoords.length; k++){
          const p = recoPrevCoords[k];
          const d = (p.lat-lat)*(p.lat-lat)+(p.lng-lon)*(p.lng-lon);
          if (d<bd){ bd=d; best=k; }
        }
        const bp = recoPrevCoords[best];
        return [bp.lat, bp.lng];
      }
      recoEventSource.onmessage = (ev)=>{
        try{
          const d = JSON.parse(ev.data||'{}');
          const lat = Number(d.lat), lon = Number(d.lon);
          const idx = Number(d.i);
          if (!isNaN(lat) && !isNaN(lon)){
            const recolectorIconSim = L.icon({ iconUrl: '/img/recolector.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
            let pt = [lat, lon];
            if (!isNaN(idx) && Array.isArray(recoPrevCoords) && recoPrevCoords[idx]){
              const p = recoPrevCoords[idx];
              pt = [p.lat, p.lng];
            } else {
              pt = snapToRouteReco(lat, lon);
            }
            if (!recoSimMarker) { recoSimMarker = L.marker(pt, { icon: recolectorIconSim }).addTo(recoPrevMap); }
            else { recoSimMarker.setLatLng(pt); }
          }
        }catch{}
      };
    }

    async function recolectorAceptar(sid){
      const selVeh = document.getElementById('reco-vehiculo');
      const vehId = selVeh && selVeh.value ? Number(selVeh.value) : NaN;
      if (Number.isNaN(vehId)) { showErrorBox('Vehículo obligatorio', 'Debes seleccionar un vehículo activo para aceptar el delivery.'); return; }
      const body = { recolector_id: user.id, vehiculo_id: vehId };
      try {
        await new Promise((resolve)=>{
          if (!navigator.geolocation) return resolve(null);
          navigator.geolocation.getCurrentPosition(p=>{ body.lat = p.coords.latitude; body.lon = p.coords.longitude; resolve(null); }, ()=>resolve(null), { enableHighAccuracy:true, timeout:3000 });
        });
      } catch {}
      const r = await fetch(`/api/recolector/${sid}/aceptar`, { method:'POST', headers: authHeaders(), body: JSON.stringify(body) });
      if (!r.ok) {
        if (r.status === 409) {
          try {
            const ul = document.getElementById('reco-feed');
            if (ul) {
              Array.from(ul.children).forEach((eli)=>{ const m = eli.querySelector(`.muted[data-sid="${sid}"]`); if (m) eli.remove(); });
            }
          } catch {}
          showErrorBox('No disponible', 'La solicitud ya no está disponible');
          return;
        }
        try {
          const j2 = await r.json();
          const code = String(j2?.error||'');
          const msgMap = {
            vehiculo_obligatorio: 'Debes seleccionar un vehículo activo para aceptar el delivery.',
            capacidad_insuficiente: 'La capacidad de carga de tu vehiculo actual no es la optima para aceptar este pedido',
            vehiculo_invalido: 'El vehículo seleccionado no es válido o no está activo.',
            recolector_ocupado: 'Ya tienes un viaje en curso. Finaliza antes de aceptar otro.'
          };
          const titleMap = {
            vehiculo_obligatorio: 'Vehículo obligatorio',
            capacidad_insuficiente: 'Capacidad insuficiente',
            vehiculo_invalido: 'Vehículo inválido',
            recolector_ocupado: 'Recolector ocupado'
          };
          const title = titleMap[code] || 'No se pudo aceptar';
          const message = msgMap[code] || 'Intenta de nuevo más tarde.';
          showErrorBox(title, message);
        } catch {
          showErrorBox('No se pudo aceptar', 'Ocurrió un error al aceptar la solicitud');
        }
        return;
      }
      const j = await r.json();
      clearRecoPreview();
      alert('Solicitud aceptada: #'+j.id);
      try {
        const ul = document.getElementById('reco-feed');
        if (ul){
          Array.from(ul.children).forEach((li)=>{
            const txt = String(li.textContent||'');
            if (txt.includes('Solicitud #'+sid)){
              li.innerHTML = `<div class="row" style="justify-content:space-between;"><div><div><strong>Solicitud #${sid}</strong></div><div class="muted">En curso</div></div><div class="right"><button class="btn" onclick="usuarioVerViaje(${sid})">Ver viaje</button> <button class="btn secondary" onclick="recolectorFinalizarRuta(${sid})">Finalizar ruta</button></div></div>`;
            }
          });
        }
      } catch {}
      try {
        let coords = [];
        try {
          const pr = await fetch(`/api/recolector/previsualizacion/${sid}?viewer_id=${user.id}`, { headers: authHeaders() });
          const pj = await pr.json();
          const rLat = pj?.recolector?.lat ?? null;
          const rLon = pj?.recolector?.lon ?? null;
          const uLat = pj?.usuario?.lat ?? null;
          const uLon = pj?.usuario?.lon ?? null;
          const eLat = pj?.empresa?.lat ?? null;
          const eLon = pj?.empresa?.lon ?? null;
          const wps = [];
          if (rLat!=null && rLon!=null) wps.push({ lat:Number(rLat), lon:Number(rLon) });
          if (uLat!=null && uLon!=null) wps.push({ lat:Number(uLat), lon:Number(uLon) });
          if (eLat!=null && eLon!=null) wps.push({ lat:Number(eLat), lon:Number(eLon) });
          if (wps.length>=2){
            const q = wps.map(w=> `${w.lon},${w.lat}`).join(';');
            const url = `https://router.project-osrm.org/route/v1/driving/${q}?overview=full&geometries=geojson`;
            const rr = await fetch(url);
            const jj = await rr.json();
            const coordsGeo = jj?.routes?.[0]?.geometry?.coordinates || [];
            coords = Array.isArray(coordsGeo) ? coordsGeo.map(([lon,lat])=> ({ lat:Number(lat), lon:Number(lon) })) : [];
          }
        } catch {}
        if (Array.isArray(coords) && coords.length >= 2) {
          await fetch(`/api/viajes/${sid}/coords`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ coords }) });
          try {
            for (let i=0; i<6; i++){
              try {
                const gr = await fetch(`/api/viajes/${sid}/coords`, { headers: authHeaders() });
                const gj = await gr.json();
                const ok = Array.isArray(gj?.points) && gj.points.length>=2;
                if (ok) break;
              } catch {}
              await new Promise(res=> setTimeout(res, 100));
            }
          } catch {}
        }
        recoPrevSid = sid;
        await fetch(`/api/viajes/${sid}/iniciar`, { method:'POST', headers: authHeaders() });
        recoSimSid = sid;
        const ub = document.getElementById('reco-ubic-btn');
        if (ub) ub.disabled = false;
        const cur = document.getElementById('reco-current');
        const curSid = document.getElementById('reco-current-sid');
        if (cur) cur.style.display = '';
        if (curSid) curSid.textContent = String(sid);
        await usuarioVerViaje(sid);
        try {
          const ul = document.getElementById('reco-feed');
          const mark = ul ? ul.querySelector('.muted[data-sid="'+sid+'"]') : null;
          const li = mark ? mark.closest('li') : null;
          if (li){
            li.innerHTML = `<div class="row" style="justify-content:space-between;"><div><div><strong>Solicitud #${sid}</strong></div><div class="muted">En curso</div></div><div class="right"><button class="btn" onclick="usuarioVerViaje(${sid})">Ver viaje</button> <button class="btn" onclick="solicitarHandoff(${sid})">Solicitar handoff</button> <button class="btn secondary" onclick="recolectorFinalizarRuta(${sid})">Finalizar ruta</button></div></div>`;
          }
        } catch {}
      } catch {}
    }

    function showErrorBox(title, message){
      try {
        const wrap = document.createElement('div');
        wrap.style.position = 'fixed';
        wrap.style.top = '0';
        wrap.style.left = '0';
        wrap.style.right = '0';
        wrap.style.bottom = '0';
        wrap.style.background = 'rgba(0,0,0,0.4)';
        wrap.style.zIndex = '9999';
        wrap.style.display = 'flex';
        wrap.style.alignItems = 'center';
        wrap.style.justifyContent = 'center';
        const box = document.createElement('div');
        box.style.background = '#1f2937';
        box.style.color = '#fff';
        box.style.minWidth = '280px';
        box.style.maxWidth = '420px';
        box.style.padding = '16px';
        box.style.borderRadius = '8px';
        box.style.boxShadow = '0 10px 25px rgba(0,0,0,0.35)';
        const h = document.createElement('div');
        h.style.fontWeight = '600';
        h.style.marginBottom = '8px';
        h.textContent = title;
        const p = document.createElement('div');
        p.textContent = message;
        p.style.marginBottom = '12px';
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = 'Entendido';
        btn.onclick = ()=>{ try{ document.body.removeChild(wrap); }catch{} };
        box.appendChild(h);
        box.appendChild(p);
        box.appendChild(btn);
        wrap.appendChild(box);
        document.body.appendChild(wrap);
      } catch {}
    }

    async function loadProgreso(){
      const ul = document.getElementById('progreso-list');
      if (!ul) return;
      ul.innerHTML = '';
      try {
        const rc = await fetch(`/api/recolector/${user.id}/en_curso`, { headers: authHeaders() });
        const cur = await rc.json();
        if (!Array.isArray(cur) || cur.length===0){
          const li = document.createElement('li');
          li.innerHTML = `<div class=\"row jc-between ai-center\"><div><strong>No tienes trabajo en progreso</strong><div class=\"muted\">Acepta una solicitud para comenzar.</div></div><div class=\"right\"><button class=\"btn\" onclick=\"loadProgreso()\">Actualizar</button></div></div>`;
          ul.appendChild(li);
          return;
        }
        cur.forEach(s=>{
          const li = document.createElement('li');
          const estado = String(s?.estado||'');
          const canHandoff = (estado==='rumbo_a_empresa' || estado==='cerca_empresa');
          const handBtn = `<button class=\"btn\" ${canHandoff? '' : 'disabled'} onclick=\"solicitarHandoff(${s.id})\">Solicitar handoff</button>`;
          li.innerHTML = `<div class=\"row\" style=\"justify-content:space-between;\"><div><div><strong>Solicitud #${s.id}</strong></div><div class=\"muted\">En curso</div></div><div class=\"right\"><button class=\"btn\" onclick=\"usuarioVerViaje(${s.id})\">Ver viaje</button> ${handBtn} <button class=\"btn secondary\" onclick=\"recolectorFinalizarRuta(${s.id})\">Finalizar ruta</button></div></div>`;
          ul.appendChild(li);
        });
      } catch {}
    }

    async function verDetalleSolicitud(sid){
      try {
        const body = document.getElementById('reco-detalle-body');
        const wrap = document.getElementById('reco-detalle');
        if (!body || !wrap) return;
        let kgTotal = 0;
        try {
          const s = await (await fetch(`/api/solicitudes/${sid}`, { headers: authHeaders() })).json();
          const items = Array.isArray(s?.items_json) ? s.items_json : (s?.items_json ? JSON.parse(s.items_json) : []);
          kgTotal = items.reduce((a, it)=> a + Number(it?.kg||0), 0);
        } catch {}
        let usuarioNombre = '', empresaNombre = '';
        try {
          const prev = await (await fetch(`/api/recolector/previsualizacion/${sid}?viewer_id=${user.id}`, { headers: authHeaders() })).json();
          usuarioNombre = String(prev?.usuario_nombre||'Usuario');
          empresaNombre = String(prev?.empresa_nombre||'Empresa');
        } catch {}
        body.innerHTML = `Peso total estimado: <strong>${kgTotal.toFixed(2)} kg</strong><br/>Usuario: <strong>${usuarioNombre}</strong><br/>Empresa: <strong>${empresaNombre}</strong>`;
        wrap.style.display = '';
      } catch {}
    }

    async function recolectorFinalizarRuta(sid){
      try {
        await fetch(`/api/viajes/${sid}/cancelar`, { method:'POST', headers: authHeaders() });
        closeViaje();
        clearRecoPreview();
        try {
          const ul = document.getElementById('reco-feed');
          if (ul){
            Array.from(ul.children).forEach((li)=>{
              const txt = String(li.textContent||'');
              if (txt.includes('Solicitud #'+sid)){
                li.innerHTML = `<div class="row" style="justify-content:space-between;"><div><div><strong>Solicitud #${sid}</strong></div><div class="muted">Cancelada</div></div><div class="right"></div></div>`;
              }
            });
          }
        } catch {}
        alert('Ruta cancelada');
      } catch {}
    }
    async function loadSolicitudes(){
      try {
        const r = await fetch(`/api/usuarios/${user.id}/dashboard`, { headers: authHeaders() });
        const j = await r.json();
        const empResp = await fetch('/api/empresas', { headers: authHeaders() });
        const empList = await empResp.json();
        empNombreById = new Map(Array.isArray(empList) ? empList.map((e)=> [Number(e.id), String(e.nombre||('Empresa '+e.id))]) : []);
        solPendData = Array.isArray(j?.solicitudes_pendientes) ? j.solicitudes_pendientes : [];
        solAntData = Array.isArray(j?.solicitudes_anteriores) ? j.solicitudes_anteriores : [];
      } catch (e) {
        solPendData = [];
        solAntData = [];
      }
      renderSolicitudesPendientes();
      renderSolicitudesAnteriores();
    }
    function renderSolicitudesPendientes(){
      const pend = document.getElementById('sol-pend');
      pend.innerHTML = '';
      const q = (solPendSearch||'').toLowerCase();
      const list = solPendData.filter((s)=>{
        const id = String(s.id||'');
        const en = (empNombreById.get(Number(s.empresa_id)) || String(s.empresa_id||'')).toLowerCase();
        const estado = String(s.estado||'').toLowerCase();
        const tipo = String(s.tipo_entrega||'').toLowerCase();
        const searchOk = !q || id.includes(q) || en.includes(q) || estado.includes(q);
        const selEstado = solPendEstado.toLowerCase();
        const estadoOk = (selEstado==='todos') || (estado === selEstado) || (selEstado==='completada' && estado==='aceptada');
        const tipoOk = (solPendTipo==='todos') || (solPendTipo==='delivery' ? tipo==='delivery' : tipo!=='delivery');
        return searchOk && estadoOk && tipoOk;
      });
      const sorted = list.slice().sort((a,b)=>{
        const da = new Date(a.creado_en||a.fecha||0).getTime();
        const db = new Date(b.creado_en||b.fecha||0).getTime();
        if (db!==da) return db-da;
        return Number(b.id||0) - Number(a.id||0);
      });
      const totalPages = Math.max(1, Math.ceil(sorted.length / PAGE_SIZE));
      if (solPendPage < 1) solPendPage = 1; if (solPendPage > totalPages) solPendPage = totalPages;
      const start = (solPendPage-1) * PAGE_SIZE;
      const toShow = sorted.slice(start, start + PAGE_SIZE);
      toShow.forEach(s=>{
        const li = document.createElement('li');
        const en = empNombreById.get(Number(s.empresa_id)) || String(s.empresa_id);
        const isExp = String(s.estado)==='expirada' && String(s.tipo_entrega)==='delivery';
        const isDelivery = String(s.tipo_entrega)==='delivery';
        const canTrack = String(s.tipo_entrega)==='delivery' && s.recolector_id!=null && String(s.estado_publicacion||'')==='aceptada_recolector';
        const viajeBtn = canTrack ? `<button class=\"btn\" onclick=\"usuarioVerViaje(${s.id})\">Ver viaje</button>` : (!isDelivery ? `<button class=\"btn\" onclick=\"usuarioRutaEmpresa(${s.id}, ${s.empresa_id})\">Ruta a la empresa</button>` : '');
        const finalBtn = isExp ? `<button class=\"btn\" onclick=\"usuarioRepublicarSolicitud(${s.id})\">Re-publicar</button>` : `<button class=\"btn\" onclick=\"usuarioCancelarSolicitud(${s.id})\">Cancelar</button>`;
        li.innerHTML = `<div class=\"row jc-between\"><div>Solicitud #${s.id} → ${en} <span class=\"badge\">${displayEstadoSolicitud(s.estado)}</span></div><div class=\"right\"><button class=\"btn secondary\" onclick=\"openSolicitudDetalle(${s.id}, ${s.empresa_id})\">Ver detalle</button> ${viajeBtn} ${finalBtn}</div></div>`;
        pend.appendChild(li);
      });
      const totalPages2 = Math.max(1, Math.ceil(sorted.length / PAGE_SIZE));
      if (sorted.length > PAGE_SIZE){
        const li = document.createElement('li');
        const prev = `<button ${solPendPage<=1?'disabled':''} onclick='(function(){ if (solPendPage>1){ solPendPage--; renderSolicitudesPendientes(); } })()'>Anterior</button>`;
        const next = `<button ${solPendPage>=totalPages2?'disabled':''} onclick='(function(){ if (solPendPage<${totalPages2}){ solPendPage++; renderSolicitudesPendientes(); } })()'>Siguiente</button>`;
        const pages = Array.from({length: totalPages2}, (_,i)=> i+1).map(i=> `<button class='${i===solPendPage? 'active':''}' onclick='(function(){ solPendPage=${i}; renderSolicitudesPendientes(); })()'>${i}</button>`).join('');
        li.innerHTML = `<div class=\"pager\">${prev}<span class=\"badge\">Página ${solPendPage}/${totalPages2}</span>${pages}${next}</div>`;
        pend.appendChild(li);
      }
      if (pend.children.length === 0) {
        const li = document.createElement('li');
        li.className = 'muted';
        li.textContent = 'No tienes solicitudes pendientes.';
        pend.appendChild(li);
      }
    }
    function renderSolicitudesAnteriores(){
      const ant = document.getElementById('sol-ant');
      ant.innerHTML = '';
      const q = (solAntSearch||'').toLowerCase();
      const list = solAntData.filter((s)=>{
        const id = String(s.id||'');
        const en = (empNombreById.get(Number(s.empresa_id)) || String(s.empresa_id||'')).toLowerCase();
        const estado = String(s.estado||'').toLowerCase();
        const tipo = String(s.tipo_entrega||'').toLowerCase();
        const searchOk = !q || id.includes(q) || en.includes(q) || estado.includes(q);
        const selEstado = solAntEstado.toLowerCase();
        const estadoOk = (selEstado==='todos') || (estado === selEstado) || (selEstado==='completada' && estado==='aceptada');
        const tipoOk = (solAntTipo==='todos') || (solAntTipo==='delivery' ? tipo==='delivery' : tipo!=='delivery');
        return searchOk && estadoOk && tipoOk;
      });
      const sortedAnt = list.slice().sort((a,b)=>{
        const da = new Date(a.creado_en||a.fecha||0).getTime();
        const db = new Date(b.creado_en||b.fecha||0).getTime();
        if (db!==da) return db-da;
        return Number(b.id||0) - Number(a.id||0);
      });
      const totalPagesAnt = Math.max(1, Math.ceil(sortedAnt.length / PAGE_SIZE));
      if (solAntPage < 1) solAntPage = 1; if (solAntPage > totalPagesAnt) solAntPage = totalPagesAnt;
      const startAnt = (solAntPage-1) * PAGE_SIZE;
      const toShowAnt = sortedAnt.slice(startAnt, startAnt + PAGE_SIZE);
      toShowAnt.forEach(s=>{
        const li = document.createElement('li');
        const en = empNombreById.get(Number(s.empresa_id)) || String(s.empresa_id);
        const isExp = String(s.estado)==='expirada' && String(s.tipo_entrega)==='delivery';
        const isDelivery = String(s.tipo_entrega)==='delivery';
        const canTrack = String(s.tipo_entrega)==='delivery' && s.recolector_id!=null && String(s.estado_publicacion||'')==='aceptada_recolector';
        const viajeBtn = canTrack ? `<button class=\"btn\" onclick=\"usuarioVerViaje(${s.id})\">Ver viaje</button>` : (!isDelivery ? `<button class=\"btn\" onclick=\"usuarioRutaEmpresa(${s.id}, ${s.empresa_id})\">Ruta a la empresa</button>` : '');
        const finalBtn = isExp ? `<button class=\"btn\" onclick=\"usuarioRepublicarSolicitud(${s.id})\">Re-publicar</button>` : '';
        li.innerHTML = `<div class=\"row jc-between\"><div>Solicitud #${s.id} → ${en} <span class=\"badge\">${displayEstadoSolicitud(s.estado)}</span></div><div class=\"right\"><button class=\"btn secondary\" onclick=\"openSolicitudDetalle(${s.id}, ${s.empresa_id})\">Ver detalle</button> ${viajeBtn} ${finalBtn}</div></div>`;
        ant.appendChild(li);
      });
      if (sortedAnt.length > PAGE_SIZE){
        const li = document.createElement('li');
        const prev = `<button ${solAntPage<=1?'disabled':''} onclick='(function(){ if (solAntPage>1){ solAntPage--; renderSolicitudesAnteriores(); } })()'>Anterior</button>`;
        const next = `<button ${solAntPage>=totalPagesAnt?'disabled':''} onclick='(function(){ if (solAntPage<${totalPagesAnt}){ solAntPage++; renderSolicitudesAnteriores(); } })()'>Siguiente</button>`;
        const pages = Array.from({length: totalPagesAnt}, (_,i)=> i+1).map(i=> `<button class='${i===solAntPage? 'active':''}' onclick='(function(){ solAntPage=${i}; renderSolicitudesAnteriores(); })()'>${i}</button>`).join('');
        li.innerHTML = `<div class=\"pager\">${prev}<span class=\"badge\">Página ${solAntPage}/${totalPagesAnt}</span>${pages}${next}</div>`;
        ant.appendChild(li);
      }
      if (ant.children.length === 0) {
        const li = document.createElement('li');
        li.className = 'muted';
        li.textContent = 'No hay solicitudes anteriores.';
        ant.appendChild(li);
      }
    }
    async function usuarioCancelarSolicitud(sid){
      const r = await fetch(`/api/solicitudes/${sid}/cancelar`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ usuario_id: user.id }) });
      const j = await r.json();
      alert('Solicitud cancelada: #'+j.id);
      try { showErrorBox('Penalidad aplicada', 'No podrás solicitar delivery durante 1 minuto'); } catch {}
      loadSolicitudes();
    }
    async function usuarioRepublicarSolicitud(sid){
      const r = await fetch(`/api/solicitudes/${sid}/republish`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ usuario_id: user.id }) });
      const j = await r.json();
      if (j?.error) { alert('No se pudo re-publicar'); return; }
      alert('Solicitud re-publicada: #'+j.id);
      loadSolicitudes();
    }

    let solicitudDetalleCtx = { sid: null, empresa_id: null };
    function closeSolicitudDetalle(){ document.getElementById('solicitud-modal').hidden = true; solicitudDetalleCtx = { sid:null, empresa_id:null }; }
    async function openSolicitudDetalle(sid, empresaId){
      solicitudDetalleCtx = { sid, empresa_id: empresaId };
      const sol = await (await fetch(`/api/solicitudes/${sid}`, { headers: authHeaders() })).json();
      const cat = await (await fetch('/api/materiales', { headers: authHeaders() })).json();
      const nombresCat = new Map(cat.map(m=> [Number(m.id), String(m.nombre)]));
      const empresas = await (await fetch('/api/empresas', { headers: authHeaders() })).json();
      const emp = Array.isArray(empresas) ? empresas.find((e)=> Number(e.id) === Number(empresaId)) : null;
      const matsEmp = await (await fetch(`/api/empresas/${empresaId}/materiales`, { headers: authHeaders() })).json();
      const precios = new Map(matsEmp.map(m=> [Number(m.material_id), Number(m.precio_por_kg)]));
      const nombresEmp = new Map(matsEmp.map(m=> [Number(m.material_id), String(m.nombre)]));
      const items = Array.isArray(sol?.items_json) ? sol.items_json : [];
      let total = 0;
      const rows = items.map(it=>{
        const mid = Number(it.material_id);
        const nombre = nombresEmp.get(mid) || nombresCat.get(mid) || ('Material '+mid);
        const kg = Number(it.kg)||0;
        const precio = precios.get(mid) || 0;
        const sub = precio * kg;
        total += sub;
        return { nombre, precio, kg, sub };
      });
      const fee = (String(sol?.tipo_entrega||'')==='delivery') ? Number(sol?.delivery_fee||0) : 0;
      const banda = String(sol?.clasificacion_distancia||'');
      const usuarioNeto = (fee>0) ? (total - fee) : total;
      const html = [
        `<div class=\"row jc-between my-8\">`,
          `<div><span class=\"muted\">Empresa</span> <strong>${emp?.nombre || ('Empresa '+empresaId)}</strong>${banda? ` · <span class=\"badge\">${banda}</span>`:''}</div>`,
          `<div class=\"right\"><span class=\"muted\">Total estimado</span> <strong>S/ ${total.toFixed(2)}</strong></div>`,
        `</div>`,
        `<table class=\"table\">`,
        `<thead><tr><th class=\"ta-left\">Material</th><th class=\"ta-right\">Precio/kg (S/)</th><th class=\"ta-right\">Kg</th><th class=\"ta-right\">Subtotal (S/)\</th></tr></thead>`,
        `<tbody>`,
        ...rows.map(r=>`<tr><td>${r.nombre}</td><td class=\"ta-right\">${r.precio.toFixed(2)}</td><td class=\"ta-right\">${r.kg.toFixed(2)}</td><td class=\"ta-right\">${r.sub.toFixed(2)}</td></tr>`),
        `</tbody>`,
        `</table>`,
        (fee>0 ? `<div class=\"right mt-8\">Delivery: <strong>S/ ${fee.toFixed(2)}</strong></div>` : ``),
        (fee>0 ? `<div class=\"right mt-8\">Neto para ti: <strong>S/ ${usuarioNeto.toFixed(2)}</strong></div>` : ``)
      ].join('');
      document.getElementById('solicitud-detalle').innerHTML = html;
      document.getElementById('solicitud-modal').hidden = false;
    }
  let histGastosMode = false;
  let viaMap = null;
  let viaRouteCtrl = null;
  let viaLayer = null;
  let viaSimMarker = null;
  let viaSimTimer = null;
  let viaPrevCoords = null;
  let viaEventSource = null;
  let viaPoly = null;
  let viaStartMarker = null;
  let viaPausedAtUser = false;
  let viaHandoffMarker = null;
  let viaHandoffPickLat = null;
  let viaHandoffPickLon = null;
  let viaHandoffPublished = false;
  let viaHandoffInExchange = false;
  let viaHandoffRouteCtrl = null;
  let viaHandoffCoords = null;
  let viaHandoffSimTimer = null;
  let viaHandoffHasPos = false;
  let viaHandoffLastLat = null;
  let viaHandoffServerDriven = false;
  let viaHandoffLastLon = null;
  let viaUserLat = null;
  let viaUserLon = null;
  let viaEmpLat = null;
  let viaEmpLon = null;
  let viaResumePoll = null;
  let viaSpeedMult = 1;
  let viaProgIdx = 0;
  let viaLastSentIdx = -1;
  let viaLastPt = null;
  let viaHoldTimer = null;
  let viaPlaceTick = null;
  let rutaMap = null;
  let rutaRouteCtrl = null;
  let rutaLayer = null;
  let usrSid = null;
  let instrHidden = false;
  let solTab = 'pendientes';
  let histSearch = '';
  let histTransData = [];
  let histGastosData = [];
  let histEmpresaData = [];
  let histRecoData = [];
  let solPendSearch = '';
  let solAntSearch = '';
  let solPendData = [];
  let solAntData = [];
  let empNombreById = new Map();
  let solPendEstado = 'todos';
  let solPendTipo = 'todos';
  let solAntEstado = 'todos';
  let solAntTipo = 'todos';
  let solPendVisibleCount = 10;
  let solAntVisibleCount = 10;
  let histVisibleCount = 10;
  let PAGE_SIZE = 10;
  let solPendPage = 1;
  let solAntPage = 1;
  let histPage = 1;
    async function loadHistorial(){
      const r = await fetch(`/api/usuarios/${user.id}/historial`, { headers: authHeaders() });
      histTransData = await r.json();
      renderHistTransacciones();
    }
    function renderHistTransacciones(){
      const ul = document.getElementById('hist-list');
      ul.innerHTML = '';
      const q = (histSearch||'').toLowerCase();
      const list = histTransData.filter((t)=>{
        if (!q) return true;
        const id = String(t.id||'');
        const emp = String(t.empresa_nombre||t.empresa_id||'');
        const estado = String(t.estado||'');
        return id.includes(q) || emp.toLowerCase().includes(q) || estado.toLowerCase().includes(q);
      });
      const sorted = list.slice().sort((a,b)=> new Date(b.fecha||0).getTime() - new Date(a.fecha||0).getTime());
      const totalPages = Math.max(1, Math.ceil(sorted.length / PAGE_SIZE));
      if (histPage < 1) histPage = 1; if (histPage > totalPages) histPage = totalPages;
      const start = (histPage-1) * PAGE_SIZE;
      const toShow = sorted.slice(start, start + PAGE_SIZE);
      toShow.forEach(t=>{
        const li = document.createElement('li');
        const userBtns = (String(role)==='usuario')
          ? ('<button class="btn secondary" id="rate-emp-'+t.id+'" onclick="openRating(\'empresa\','+t.id+','+t.empresa_id+', null)">Calificar empresa</button>')
          : '';
        li.innerHTML = `<div class="row jc-between"><div><div><strong>Transacción #${t.id}</strong> con ${t.empresa_nombre||t.empresa_id}</div><div class="muted">Monto: S/${Number(t.monto_pagado).toFixed(2)} · Puntos: ${t.puntos_obtenidos} · Estado: ${t.estado}</div></div><div class="right"><span class="badge">${new Date(t.fecha).toLocaleString()}</span> <button class="btn" onclick="verDetalleTx(${t.id})">Ver detalle</button> ${userBtns}</div></div>`;
        ul.appendChild(li);
        setTimeout(()=>updateRatingButtonsForTx(t.id),0);
      });
      const totalPages2 = Math.max(1, Math.ceil(sorted.length / PAGE_SIZE));
      if (sorted.length > PAGE_SIZE){
        const li = document.createElement('li');
        const prev = `<button ${histPage<=1?'disabled':''} onclick='(function(){ if (histPage>1){ histPage--; renderHistTransacciones(); } })()'>Anterior</button>`;
        const next = `<button ${histPage>=totalPages2?'disabled':''} onclick='(function(){ if (histPage<${totalPages2}){ histPage++; renderHistTransacciones(); } })()'>Siguiente</button>`;
        const pages = Array.from({length: totalPages2}, (_,i)=> i+1).map(i=> `<button class='${i===histPage? 'active':''}' onclick='(function(){ histPage=${i}; renderHistTransacciones(); })()'>${i}</button>`).join('');
        li.innerHTML = `<div class=\"pager\">${prev}<span class=\"badge\">Página ${histPage}/${totalPages2}</span>${pages}${next}</div>`;
        ul.appendChild(li);
      }
      if (role==='usuario'){
        try {
          const rights = ul.querySelectorAll('.right');
          rights.forEach((right, idx)=>{
            const cur = toShow[idx];
            if (!cur) return;
            if (!right.querySelector(`#rate-reco-${cur.id}`)){
              const b = document.createElement('button');
              b.className = 'btn secondary';
              b.id = 'rate-reco-' + String(cur.id);
              b.textContent = 'Calificar recolector';
              b.onclick = ()=> openRating('recolector', Number(cur.id), null, null);
              right.appendChild(b);
              setTimeout(()=>updateRatingButtonsForTx(Number(cur.id)),0);
            }
          });
        } catch {}
      }
      document.getElementById('hist-detalle').style.display = 'none';
    }
    async function loadHistorialGastos(){
      const gastos = await (await fetch(`/api/usuarios/${user.id}/puntos/gastos`, { headers: authHeaders() })).json();
      const rewards = await (await fetch('/api/usuarios/recompensas', { headers: authHeaders() })).json();
      const names = new Map(rewards.map((r)=> [String(r.key), String(r.nombre)]));
      histGastosData = gastos.map((g)=>({ ...g, nombre: names.get(String(g.reward_key)) || String(g.reward_key) }));
      renderHistGastos();
    }
    function renderHistGastos(){
      const ul = document.getElementById('hist-list');
      ul.innerHTML = '';
      const q = (histSearch||'').toLowerCase();
      const list = histGastosData.filter((g)=>{
        if (!q) return true;
        return String(g.nombre||'').toLowerCase().includes(q) || String(g.puntos||'').includes(q) || new Date(g.creado_en).toLocaleString().toLowerCase().includes(q);
      });
      const sortedG = list.slice().sort((a,b)=> new Date(b.creado_en||0).getTime() - new Date(a.creado_en||0).getTime());
      const totalPages = Math.max(1, Math.ceil(sortedG.length / PAGE_SIZE));
      if (histPage < 1) histPage = 1; if (histPage > totalPages) histPage = totalPages;
      const start = (histPage-1) * PAGE_SIZE;
      const toShowG = sortedG.slice(start, start + PAGE_SIZE);
      toShowG.forEach(g=>{
        const li = document.createElement('li');
        li.innerHTML = `<div class=\"row jc-between\"><div><div><strong>${g.nombre}</strong></div><div class=\"muted\">Gasto de puntos: ${Number(g.puntos)} · ${new Date(g.creado_en).toLocaleString()}</div></div></div>`;
        ul.appendChild(li);
      });
      if (sortedG.length > PAGE_SIZE){
        const li = document.createElement('li');
        const prev = `<button ${histPage<=1?'disabled':''} onclick='(function(){ if (histPage>1){ histPage--; renderHistGastos(); } })()'>Anterior</button>`;
        const next = `<button ${histPage>=totalPages?'disabled':''} onclick='(function(){ if (histPage<${totalPages}){ histPage++; renderHistGastos(); } })()'>Siguiente</button>`;
        const pages = Array.from({length: totalPages}, (_,i)=> i+1).map(i=> `<button class='${i===histPage? 'active':''}' onclick='(function(){ histPage=${i}; renderHistGastos(); })()'>${i}</button>`).join('');
        li.innerHTML = `<div class=\"pager\">${prev}<span class=\"badge\">Página ${histPage}/${totalPages}</span>${pages}${next}</div>`;
        ul.appendChild(li);
      }
      document.getElementById('hist-detalle').style.display = 'none';
    }
  function initHistorialUI(){
      const refresh = document.getElementById('hist-refresh');
      document.getElementById('hist-title').textContent = histGastosMode ? 'Historial de Puntos' : 'Historial de Transacciones';
      if (refresh) refresh.onclick = ()=>{ if (role==='recolector') loadHistorialRecolector(); else if (histGastosMode) loadHistorialGastos(); else loadHistorial(); };
      const search = document.getElementById('hist-search');
      if (search){
        search.value = histSearch;
        search.oninput = ()=>{
          histSearch = search.value.toLowerCase();
          if (histGastosMode) renderHistGastos(); else renderHistTransacciones();
        };
      }
    }
    async function loadHistorialEmpresa(){
      const r = await fetch(`/api/empresas/${user.id}/historial`, { headers: authHeaders() });
      histEmpresaData = await r.json();
      const ul = document.getElementById('hist-list');
      ul.innerHTML = '';
      const sorted = histEmpresaData.slice().sort((a,b)=> new Date(b.fecha||0).getTime() - new Date(a.fecha||0).getTime());
      const totalPages = Math.max(1, Math.ceil(sorted.length / PAGE_SIZE));
      if (histPage < 1) histPage = 1; if (histPage > totalPages) histPage = totalPages;
      const start = (histPage-1) * PAGE_SIZE;
      const toShow = sorted.slice(start, start + PAGE_SIZE);
      toShow.forEach(t=>{
        const li = document.createElement('li');
        li.innerHTML = `<div class=\"row jc-between\"><div><div><strong>Transacción #${t.id}</strong></div><div class=\"muted\">Monto: S/${Number(t.monto_pagado).toFixed(2)} · Puntos: ${t.puntos_obtenidos} · Estado: ${t.estado}</div></div><div class=\"right\"><span class=\"badge\">${new Date(t.fecha).toLocaleString()}</span> <button class=\"btn\" onclick=\"verDetalleTx(${t.id})\">Ver detalle</button> <button class=\"btn secondary\" id=\"rate-usr-${t.id}\" onclick=\"openRating('usuario', ${t.id}, null, ${t.usuario_id})\">Calificar usuario</button></div></div>`;
        ul.appendChild(li);
        setTimeout(()=>updateRatingButtonsForTx(t.id),0);
      });
      if (sorted.length > PAGE_SIZE){
        const li = document.createElement('li');
        const prev = `<button ${histPage<=1?'disabled':''} onclick='(function(){ if (histPage>1){ histPage--; loadHistorialEmpresa(); } })()'>Anterior</button>`;
        const next = `<button ${histPage>=totalPages?'disabled':''} onclick='(function(){ if (histPage<${totalPages}){ histPage++; loadHistorialEmpresa(); } })()'>Siguiente</button>`;
        const pages = Array.from({length: totalPages}, (_,i)=> i+1).map(i=> `<button class='${i===histPage? 'active':''}' onclick='(function(){ histPage=${i}; loadHistorialEmpresa(); })()'>${i}</button>`).join('');
        li.innerHTML = `<div class=\"pager\">${prev}<span class=\"badge\">Página ${histPage}/${totalPages}</span>${pages}${next}</div>`;
        ul.appendChild(li);
      }
    }
    async function verDetalleTx(id){
      if (document.getElementById('view-historial').hidden) setView('historial');
      const modal = document.getElementById('historial-modal');
      if (modal && !modal.hidden && histDetalleId === id){ modal.hidden = true; histDetalleId = null; return; }
      const r = await fetch(`/api/transacciones/${id}`, { headers: authHeaders() });
      const j = await r.json();
      const filas = j.detalle.map(d=> `<tr><td>${d.nombre}</td><td class=\"ta-right\">${Number(d.precio_por_kg).toFixed(2)}</td><td class=\"ta-right\">${Number(d.kg_finales).toFixed(2)}</td><td class=\"ta-right\">${Number(d.subtotal).toFixed(2)}</td></tr>`).join('');
      const footer = role === 'usuario'
        ? `<div class=\"right\" style=\"margin-top:10px\">Total: <strong>S/ ${Number(j.total).toFixed(2)}</strong>${Number(j.delivery_fee||0)>0 ? ` · Delivery: <strong>S/ ${Number(j.delivery_fee||0).toFixed(2)}</strong> · Neto: <strong>S/ ${Number(j.usuario_neto||j.total).toFixed(2)}</strong>` : ''}</div>`
        : `<div class=\"right\" style=\"margin-top:10px\">Total: <strong>S/ ${Number(j.total).toFixed(2)}</strong> · Comisión 10%: <strong>S/ ${Number(j.comision_10).toFixed(2)}</strong> · Total con comisión: <strong>S/ ${Number(j.total_con_comision).toFixed(2)}</strong></div>`;
      const titleEl = document.getElementById('historial-modal-title');
      const contentEl = document.getElementById('historial-modal-content');
      if (titleEl) titleEl.textContent = `Detalle Transacción #${j.transaccion.id} · ${j.transaccion.empresa_nombre}`;
      let acciones = '';
      if (String(role)==='empresa' && Boolean(j?.es_delivery) && j?.recolector_final_id!=null && !Boolean(j?.ya_resena_recolector_empresa)) {
        acciones = `<div class=\"right mt-10\"><button class=\"btn secondary\" id=\"rate-reco-det-${id}\" onclick=\"openRating('recolector', ${id}, null, null)\">Calificar recolector</button></div>`;
      }
      if (contentEl) contentEl.innerHTML = `<table class=\"table\"><thead><tr><th>Material</th><th class=\"ta-right\">Precio/kg</th><th class=\"ta-right\">Kg</th><th class=\"ta-right\">Subtotal</th></tr></thead><tbody>${filas}</tbody></table>${footer}${acciones}<div class=\"muted\">Puntos obtenidos: ${j.transaccion.puntos_obtenidos}</div>`;
      if (modal) modal.hidden = false;
      histDetalleId = id;
    }
    async function loadHistorialRecolector(){
      const r = await fetch(`/api/recolector/${user.id}/historial`, { headers: authHeaders() });
      histRecoData = await r.json();
      const ul = document.getElementById('hist-list');
      const dirUl = document.getElementById('hist-list-direct');
      const handUl = document.getElementById('hist-list-handoff');
      const tabs = document.getElementById('hist-reco-tabs');
      if (ul) ul.innerHTML = '';
      if (dirUl) dirUl.innerHTML = '';
      if (handUl) handUl.innerHTML = '';
      const groups = document.getElementById('hist-reco-groups');
      if (groups) groups.style.display = '';
      if (tabs) tabs.style.display = '';
      if (ul) ul.style.display = 'none';
      const total = histRecoData.reduce((a, s)=> a + (Number(s.recolector_id)===Number(user.id) ? Number(s.delivery_fee||0) : 0), 0);
      const he = document.getElementById('hist-earnings');
      if (he) he.textContent = 'Ganancia total: S/ ' + total.toFixed(2);
      const sorted = histRecoData.slice().sort((a,b)=> new Date(b.creado_en||0).getTime() - new Date(a.creado_en||0).getTime());
      const direct = sorted.filter(s=> !(s.handoff_recolector_id!=null && Number(s.handoff_recolector_id)>0) && !(s.pickup_recolector_id!=null && Number(s.pickup_recolector_id)>0 && Number(s.pickup_recolector_id)!==Number(s.recolector_id)) );
      const hand = sorted.filter(s=> (s.handoff_recolector_id!=null && Number(s.handoff_recolector_id)>0) || (s.pickup_recolector_id!=null && Number(s.pickup_recolector_id)>0 && Number(s.pickup_recolector_id)!==Number(s.recolector_id)) );
      const renderList = (arr, targetUl)=>{
        const totalPages = Math.max(1, Math.ceil(arr.length / PAGE_SIZE));
        if (histPage < 1) histPage = 1; if (histPage > totalPages) histPage = totalPages;
        const start = (histPage-1) * PAGE_SIZE;
        const toShow = arr.slice(start, start + PAGE_SIZE);
        toShow.forEach(s=>{
          const li = document.createElement('li');
          const banda = String(s.clasificacion_distancia||'').toLowerCase();
          const win = (Number(s.recolector_id)===Number(user.id)) ? Number(s.delivery_fee||0) : 0;
          li.innerHTML = `<div class=\"row jc-between\"><div><div><strong>Trabajo #${s.id}</strong> · Gana: <strong>S/ ${win.toFixed(2)}</strong></div><div class=\"muted\">Usuario #${s.usuario_id} · Empresa ${s.empresa_nombre||s.empresa_id} · Viaje: ${banda||'—'}</div></div><div class=\"right\"><span class=\"badge\">${new Date(s.creado_en).toLocaleString()}</span> <button class=\"btn\" onclick=\"verDetalleTrabajo(${s.id})\">Detalles</button></div></div>`;
          targetUl.appendChild(li);
          (async ()=>{
            try {
              const r2 = await fetch(`/api/recolector/trabajos/${s.id}/detalle?viewer_id=${user.id}`, { headers: authHeaders() });
              const j2 = await r2.json();
              const right = li.querySelector('.right');
              if (!right) return;
              if (Boolean(j2?.puede_calificar_usuario) && !Boolean(j2?.ya_resena_usuario_por_recolector)){
                const bU = document.createElement('button');
                bU.className = 'btn secondary';
                bU.id = 'rate-usr-reco-' + String(s.id);
                bU.textContent = 'Calificar usuario';
                bU.onclick = ()=> openRating('usuario_reco', Number(j2.transaccion_id), null, Number(j2.usuario_id), Number(s.id));
                right.appendChild(bU);
              }
              if (Boolean(j2?.puede_calificar_empresa) && !Boolean(j2?.ya_resena_empresa_por_recolector)){
                const bE = document.createElement('button');
                bE.className = 'btn secondary';
                bE.id = 'rate-emp-reco-' + String(s.id);
                bE.textContent = 'Calificar empresa';
                bE.onclick = ()=> openRating('empresa_reco', Number(j2.transaccion_id), Number(j2.empresa_id), null, Number(s.id));
                right.appendChild(bE);
              }
            } catch {}
          })();
        });
        if (arr.length > PAGE_SIZE){
          const li = document.createElement('li');
          const prev = `<button ${histPage<=1?'disabled':''} onclick='(function(){ if (histPage>1){ histPage--; loadHistorialRecolector(); } })()'>Anterior</button>`;
          const next = `<button ${histPage>=totalPages?'disabled':''} onclick='(function(){ if (histPage<${totalPages}){ histPage++; loadHistorialRecolector(); } })()'>Siguiente</button>`;
          const pages = Array.from({length: totalPages}, (_,i)=> i+1).map(i=> `<button class='${i===histPage? 'active':''}' onclick='(function(){ histPage=${i}; loadHistorialRecolector(); })()'>${i}</button>`).join('');
          li.innerHTML = `<div class=\"pager\">${prev}<span class=\"badge\">Página ${histPage}/${totalPages}</span>${pages}${next}</div>`;
          targetUl.appendChild(li);
        }
      };
      if (dirUl) renderList(direct, dirUl);
      if (handUl) renderList(hand, handUl);
      const bDir = document.getElementById('hist-reco-tab-direct');
      const bHand = document.getElementById('hist-reco-tab-handoff');
      if (bDir) bDir.onclick = ()=>{ setRecoHistTab('direct'); };
      if (bHand) bHand.onclick = ()=>{ setRecoHistTab('handoff'); };
      setRecoHistTab(histRecoTab || 'direct');
      const panel = document.getElementById('hist-detalle');
      if (panel) panel.style.display = 'none';
    }

    let histRecoTab = 'direct';
    function setRecoHistTab(tab){
      histRecoTab = tab;
      const dirUl = document.getElementById('hist-list-direct');
      const handUl = document.getElementById('hist-list-handoff');
      const bDir = document.getElementById('hist-reco-tab-direct');
      const bHand = document.getElementById('hist-reco-tab-handoff');
      if (dirUl) dirUl.style.display = (tab==='direct') ? '' : 'none';
      if (handUl) handUl.style.display = (tab==='handoff') ? '' : 'none';
      if (bDir) bDir.className = (tab==='direct') ? 'btn' : 'btn secondary';
      if (bHand) bHand.className = (tab==='handoff') ? 'btn' : 'btn secondary';
    }
    async function verDetalleTrabajo(sid){
      if (document.getElementById('view-historial').hidden) setView('historial');
      const modal = document.getElementById('historial-modal');
      if (modal && !modal.hidden && histDetalleId === sid){ modal.hidden = true; histDetalleId = null; return; }
      const r = await fetch(`/api/recolector/trabajos/${sid}/detalle?viewer_id=${user.id}`, { headers: authHeaders() });
      const j = await r.json();
      const filas = (j.materiales||[]).map(d=> `<tr><td>${d.nombre}</td><td class=\"ta-right\">${Number(d.kg_finales).toFixed(2)}</td></tr>`).join('');
      const distRU = (j.dist_recolector_usuario_km!=null) ? `${Number(j.dist_recolector_usuario_km).toFixed(2)} km` : '—';
      const distUE = (j.dist_usuario_empresa_km!=null) ? `${Number(j.dist_usuario_empresa_km).toFixed(2)} km` : '—';
      const titleEl = document.getElementById('historial-modal-title');
      const contentEl = document.getElementById('historial-modal-content');
      if (titleEl) titleEl.textContent = `Detalle Trabajo #${sid}`;
      let acciones = '';
      const puedeU = Boolean(j?.puede_calificar_usuario) && !Boolean(j?.ya_resena_usuario_por_recolector);
      const puedeE = Boolean(j?.puede_calificar_empresa) && !Boolean(j?.ya_resena_empresa_por_recolector);
      if (puedeU) acciones += `<button class=\"btn secondary\" id=\"rate-usr-reco-${sid}\" onclick=\"openRating('usuario_reco', ${Number(j.transaccion_id)}, null, ${Number(j.usuario_id)})\">Calificar usuario</button>`;
      if (puedeE) acciones += ` <button class=\"btn secondary\" id=\"rate-emp-reco-${sid}\" onclick=\"openRating('empresa_reco', ${Number(j.transaccion_id)}, ${Number(j.empresa_id)}, null)\">Calificar empresa</button>`;
      if (contentEl) contentEl.innerHTML = `<table class=\"table\"><thead><tr><th>Material</th><th class=\"ta-right\">Kg finales</th></tr></thead><tbody>${filas}</tbody></table><div class=\"right mt-10\">Total kg: <strong>${Number(j.total_kg||0).toFixed(2)}</strong> · Viaje: <span class=\"badge\">${j.clasificacion||'—'}</span></div><div class=\"right mt-8\">Recolector → Usuario: <strong>${distRU}</strong> · Usuario → Empresa: <strong>${distUE}</strong></div>${(acciones? `<div class=\\\"right mt-10\\\">${acciones}</div>` : '')}`;
      if (modal) modal.hidden = false;
      histDetalleId = sid;
    }

    function closeHistorialModal(){
      const modal = document.getElementById('historial-modal');
      if (modal) modal.hidden = true;
      histDetalleId = null;
    }
    let ratingCtx = { tipo:null, txId:null, empresaId:null, usuarioId:null, sid:null };
    function openRating(tipo, txId, empresaId, usuarioId, sid){
      ratingCtx = { tipo, txId, empresaId, usuarioId, sid };
      document.getElementById('rating-title').textContent = (tipo==='empresa' ? 'Calificar empresa' : (tipo==='usuario' ? 'Calificar usuario' : (tipo==='recolector' ? 'Calificar recolector' : (tipo==='usuario_reco' ? 'Calificar usuario' : 'Calificar empresa'))));
      document.getElementById('rating-score').value = '5';
      document.getElementById('rating-msg').value = '';
      document.getElementById('rating-modal').hidden = false;
    }
    function closeRating(){ document.getElementById('rating-modal').hidden = true; }
    async function updateRatingButtonsForTx(txId){
      const det = await (await fetch(`/api/transacciones/${txId}`, { headers: authHeaders() })).json();
      const yaEmp = det?.ya_resena_empresa;
      const yaUsr = det?.ya_resena_usuario;
      const yaRecoE = det?.ya_resena_recolector_empresa;
      const yaRecoU = det?.ya_resena_recolector_usuario;
      const esDelivery = Boolean(det?.es_delivery);
      const hasRecoFinal = det?.recolector_final_id != null;
      const b1 = document.getElementById('rate-emp-'+txId);
      const b2 = document.getElementById('rate-usr-'+txId);
      const b3 = document.getElementById('rate-reco-'+txId);
      if (b1 && yaEmp) b1.style.display = 'none';
      if (b2 && yaUsr) b2.style.display = 'none';
      if (b3 && yaRecoE) b3.style.display = 'none';
      if (b3 && String(role)!=='empresa' && yaRecoU) b3.style.display = 'none';
      if (b3 && (!hasRecoFinal || !esDelivery)) b3.style.display = 'none';
    }
    async function submitRating(){
      const puntaje = Number(document.getElementById('rating-score').value);
      const mensaje = document.getElementById('rating-msg').value;
      if (!puntaje || puntaje < 1 || puntaje > 5) { alert('Puntaje inválido'); return; }
      if (ratingCtx.tipo === 'empresa'){
        const r = await fetch('/api/resenas/empresa', { method:'POST', headers: authHeaders(), body: JSON.stringify({ empresa_id: ratingCtx.empresaId, usuario_id: user.id, transaccion_id: ratingCtx.txId, puntaje, mensaje }) });
        await r.json();
        alert('Reseña enviada');
        const btn = document.getElementById('rate-emp-'+ratingCtx.txId);
        if (btn) btn.style.display = 'none';
      } else if (ratingCtx.tipo === 'usuario'){
        let usuarioId = ratingCtx.usuarioId;
        if (!usuarioId){
          const det = await (await fetch(`/api/transacciones/${ratingCtx.txId}`, { headers: authHeaders() })).json();
          usuarioId = det?.transaccion?.usuario_id;
        }
        if (!usuarioId) { alert('No se pudo identificar al usuario'); return; }
        const r = await fetch('/api/resenas/usuario', { method:'POST', headers: authHeaders(), body: JSON.stringify({ usuario_id: usuarioId, empresa_id: user.id, transaccion_id: ratingCtx.txId, puntaje, mensaje }) });
        await r.json();
        alert('Reseña enviada');
        const btn = document.getElementById('rate-usr-'+ratingCtx.txId);
        if (btn) btn.style.display = 'none';
      } else if (ratingCtx.tipo === 'recolector'){
        const r = await fetch('/api/resenas/recolector', { method:'POST', headers: authHeaders(), body: JSON.stringify({ evaluador_rol: (String(role)==='empresa' ? 'empresa' : 'usuario'), evaluador_id: user.id, transaccion_id: ratingCtx.txId, puntaje, mensaje }) });
        await r.json();
        alert('Reseña enviada');
        const btn = document.getElementById('rate-reco-'+ratingCtx.txId);
        if (btn) btn.style.display = 'none';
      } else if (ratingCtx.tipo === 'usuario_reco'){
        const r = await fetch('/api/resenas/recolector/usuario', { method:'POST', headers: authHeaders(), body: JSON.stringify({ usuario_id: ratingCtx.usuarioId, recolector_id: user.id, transaccion_id: ratingCtx.txId, puntaje, mensaje }) });
        await r.json();
        alert('Reseña enviada');
        const btn = document.getElementById('rate-usr-reco-'+String((ratingCtx.sid!=null? ratingCtx.sid : (histDetalleId||''))));
        if (btn) btn.style.display = 'none';
      } else if (ratingCtx.tipo === 'empresa_reco'){
        const r = await fetch('/api/resenas/recolector/empresa', { method:'POST', headers: authHeaders(), body: JSON.stringify({ empresa_id: ratingCtx.empresaId, recolector_id: user.id, transaccion_id: ratingCtx.txId, puntaje, mensaje }) });
        await r.json();
        alert('Reseña enviada');
        const btn = document.getElementById('rate-emp-reco-'+String((ratingCtx.sid!=null? ratingCtx.sid : (histDetalleId||''))));
        if (btn) btn.style.display = 'none';
      }
      closeRating();
    }
    async function loadHistorialEmpresa(){
      const r = await fetch(`/api/empresas/${user.id}/historial`, { headers: authHeaders() });
      histEmpresaData = await r.json();
      const ul = document.getElementById('hist-list');
      ul.innerHTML = '';
      const sorted = histEmpresaData.slice().sort((a,b)=> new Date(b.fecha||0).getTime() - new Date(a.fecha||0).getTime());
      const totalPages = Math.max(1, Math.ceil(sorted.length / PAGE_SIZE));
      if (histPage < 1) histPage = 1; if (histPage > totalPages) histPage = totalPages;
      const start = (histPage-1) * PAGE_SIZE;
      const toShow = sorted.slice(start, start + PAGE_SIZE);
      toShow.forEach(t=>{
        const li = document.createElement('li');
        li.innerHTML = `<div class=\"row jc-between\"><div><div><strong>Transacción #${t.id}</strong></div><div class=\"muted\">Monto: S/${Number(t.monto_pagado).toFixed(2)} · Puntos: ${t.puntos_obtenidos} · Estado: ${t.estado}</div></div><div class=\"right\"><span class=\"badge\">${new Date(t.fecha).toLocaleString()}</span> <button class=\"btn\" onclick=\"verDetalleTx(${t.id})\">Ver detalle</button> <button class=\"btn secondary\" id=\"rate-usr-${t.id}\" onclick=\"openRating('usuario', ${t.id}, null, ${t.usuario_id})\">Calificar usuario</button> <button class=\"btn secondary\" id=\"rate-reco-${t.id}\" onclick=\"openRating('recolector', ${t.id}, null, null)\">Calificar recolector</button></div></div>`;
        ul.appendChild(li);
        setTimeout(()=>updateRatingButtonsForTx(t.id),0);
      });
      if (sorted.length > PAGE_SIZE){
        const li = document.createElement('li');
        const pages = Array.from({length: totalPages}, (_,i)=> i+1).map(i=> `<button class='${i===histPage? 'active':''}' onclick='(function(){ histPage=${i}; loadHistorialEmpresa(); })()'>${i}</button>`).join('');
        li.innerHTML = `<div class=\"pager\"><span class=\"badge\">Página ${histPage}/${totalPages}</span>${pages}</div>`;
        ul.appendChild(li);
      }
    }
    async function loadSolicitudesEmpresa(){
      const r = await fetch(`/api/empresas/${user.id}/solicitudes`, { headers: authHeaders() });
      let list = await r.json();
      if (!Array.isArray(list)) list = [];
      const ul = document.getElementById('emp-sol-list');
      ul.innerHTML = '';
      list.forEach(s=>{
        const li = document.createElement('li');
        li.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>Solicitud #${s.id}</strong> del usuario ${s.usuario_id}</div>
            <div class="muted">Estado: ${displayEstadoSolicitud(s.estado)} · ${new Date(s.creado_en).toLocaleString()}</div>
          </div>
          <div class="right">
            <button class="btn secondary" onclick="openAceptar(${s.id}, ${s.usuario_id})">Aceptar</button>
            <button class="btn" onclick="empresaRechazar(${s.id})">Rechazar</button>
            <button class="btn" onclick="empresaPesaje(${s.id}, ${s.usuario_id})">Pesaje</button>
          </div>
        </div>`;
        ul.appendChild(li);
      });
    }
    async function loadRewards(){
      document.getElementById('rewards-puntos').textContent = 'Puntos: ' + Number(user.puntos_acumulados||0);
      const ul = document.getElementById('rewards-list');
      ul.innerHTML = '';
      const r = await fetch('/api/usuarios/recompensas', { headers: authHeaders() });
      const list = await r.json();
      list.forEach(it=>{
        const li = document.createElement('li');
        const puede = Number(user.puntos_acumulados||0) >= Number(it.costo);
        li.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>${it.nombre}</strong></div>
            <div class="muted">Costo: ${it.costo} puntos</div>
          </div>
          <div class="right"><button class="btn" ${puede? '' : 'disabled'} onclick="redeemReward('${it.key}', ${it.costo})">Canjear</button></div>
        </div>`;
        ul.appendChild(li);
      });
    }
    async function redeemReward(key, costo){
      const r = await fetch(`/api/usuarios/${user.id}/recompensas/redimir`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ reward_key: key }) });
      const j = await r.json();
      if (j?.error==='insufficient_points') { alert('No tienes puntos suficientes'); return; }
      alert('Canje realizado');
      user.puntos_acumulados = Number(j.nuevo_puntos||user.puntos_acumulados);
      loadRewards();
      if (document.getElementById('view-perfil') && document.getElementById('view-perfil').hidden===false) loadPerfil();
    }
    async function loadResenasEmpresa(){
      const ul = document.getElementById('resenas-list');
      ul.innerHTML = '';
      const r = await fetch(`/api/resenas/empresa/${user.id}`, { headers: authHeaders() });
      const list = await r.json();
      list.forEach(re=>{
        const li = document.createElement('li');
        li.innerHTML = `<div class="row" style="justify-content:space-between;">
          <div>
            <div><strong>Puntaje ${Number(re.puntaje)}</strong> · Tx #${re.transaccion_id} · ${re.usuario_email||('Usuario '+re.usuario_id)}</div>
            <div class="muted">${re.mensaje || '—'}</div>
          </div>
          <div class="right"><span class="badge">${new Date(re.creado_en).toLocaleString()}</span> <button class="btn" onclick="verDetalleTx(${re.transaccion_id})">Ver transacción</button></div>
        </div>`;
        ul.appendChild(li);
      });
    }
    async function empresaAceptar(sid){
      await fetch(`/api/empresas/${user.id}/solicitudes/${sid}/aceptar`, { method:'POST', headers: authHeaders() });
      loadSolicitudesEmpresa();
    }
    async function empresaRechazar(sid){
      await fetch(`/api/empresas/${user.id}/solicitudes/${sid}/rechazar`, { method:'POST', headers: authHeaders() });
      loadSolicitudesEmpresa();
    }

    let aceptarCtx = { sid: null, usuario_id: null };
    function closeAceptar(){ document.getElementById('aceptar-modal').hidden = true; aceptarCtx = { sid:null, usuario_id:null }; }
  async function openAceptar(sid, usuarioId){
    aceptarCtx = { sid, usuario_id: usuarioId };
    const sol = await (await fetch(`/api/solicitudes/${sid}`, { headers: authHeaders() })).json();
    const mats = await (await fetch(`/api/empresas/${user.id}/materiales`, { headers: authHeaders() })).json();
    const precios = new Map(mats.map(m=> [Number(m.material_id), Number(m.precio_por_kg)]));
    const nombres = new Map(mats.map(m=> [Number(m.material_id), String(m.nombre)]));
    const items = Array.isArray(sol?.items_json) ? sol.items_json : [];
    let total = 0;
    const rows = items.map(it=>{
      const precio = precios.get(Number(it.material_id)) || 0;
      const kg = Number(it.kg)||0;
      const sub = precio * kg;
      total += sub;
      return { material_id: Number(it.material_id), nombre: (nombres.get(Number(it.material_id)) || ('#'+Number(it.material_id))), kg, precio, sub };
    });
    const detalle = document.getElementById('aceptar-detalle');
    const html = [`<table style=\"width:100%; border-collapse:collapse;\">`,
      `<thead><tr><th style='text-align:left'>Material</th><th style='text-align:right'>Precio/kg</th><th style='text-align:right'>Kg</th><th style='text-align:right'>Subtotal</th></tr></thead>`,
      `<tbody>`,
      ...rows.map(r=>`<tr><td style='padding:6px'>${r.nombre}</td><td style='padding:6px; text-align:right'>${r.precio.toFixed(2)}</td><td style='padding:6px; text-align:right'>${r.kg.toFixed(2)}</td><td style='padding:6px; text-align:right'>${r.sub.toFixed(2)}</td></tr>`),
      `</tbody>`,
      `</table>`,
      `<div class='right' style='margin-top:10px;'>Total estimado: <strong>S/ ${total.toFixed(2)}</strong></div>`
    ].join('');
    detalle.innerHTML = html;
    const btnGo = document.getElementById('btn-aceptar-go');
    const btnPes = document.getElementById('btn-aceptar-pesaje');
    const chk = document.getElementById('aceptar-agree');
    const feeBox = document.getElementById('aceptar-fee-box');
    const feeEl = document.getElementById('aceptar-fee');
    const netEl = document.getElementById('aceptar-net');
    btnGo.disabled = true;
    if (chk) chk.checked = false;
    if (feeBox) feeBox.hidden = true;
    if (feeEl) feeEl.textContent = 'S/ 0.00';
    if (netEl) netEl.textContent = 'S/ 0.00';
    btnGo.onclick = async ()=>{ await empresaAceptar(sid); closeAceptar(); };
    btnPes.onclick = ()=>{ closeAceptar(); empresaPesaje(sid, usuarioId); };
    chk.onchange = ()=>{
      const ok = chk.checked;
      btnGo.disabled = !ok;
      feeBox.hidden = !ok;
      if (ok){
        const fee = total * 0.10;
        const net = total + fee;
        if (feeEl) feeEl.textContent = 'S/ ' + fee.toFixed(2);
        if (netEl) netEl.textContent = 'S/ ' + net.toFixed(2);
      }
    };
    document.getElementById('aceptar-modal').hidden = false;
  }

  function closeViaje(){
    const modal = document.getElementById('viaje-modal');
    if (modal) modal.hidden = true;
    const metaV = document.getElementById('usr-route-meta-viaje');
    if (metaV) metaV.textContent = '';
    if (viaLayer && viaMap) { viaLayer.remove(); viaLayer = null; }
    if (viaRouteCtrl) { viaRouteCtrl.remove(); viaRouteCtrl = null; }
    if (viaStartMarker) { try { viaStartMarker.remove(); } catch {} viaStartMarker = null; }
    if (viaSimMarker) { viaSimMarker.remove(); viaSimMarker = null; }
    if (viaSimTimer) { clearInterval(viaSimTimer); viaSimTimer = null; }
    if (viaHoldTimer) { try { clearInterval(viaHoldTimer); } catch {} viaHoldTimer = null; }
    if (viaPlaceTick) { try { clearTimeout(viaPlaceTick); } catch {} viaPlaceTick = null; }
    try { if (viaHandoffRouteCtrl) { viaHandoffRouteCtrl.remove(); viaHandoffRouteCtrl = null; } } catch {}
    try { if (viaHandoffMarker) { viaHandoffMarker.remove(); viaHandoffMarker = null; } } catch {}
    try { if (viaHandoffSimTimer) { clearInterval(viaHandoffSimTimer); viaHandoffSimTimer = null; } } catch {}
    if (viaEventSource) { try { viaEventSource.close(); } catch {} viaEventSource = null; }
    if (viaMap) { viaMap.remove(); viaMap = null; }
    usrSid = null;
  }

  async function usuarioVerViaje(sid){
    console.log('usr_ver_viaje_in', { sid });
    const modal = document.getElementById('viaje-modal');
    if (modal && !modal.hidden && usrSid === sid) { closeViaje(); return; }
    if (modal) modal.hidden = false;
    try { const mapDiv = document.getElementById('usr-map-viaje'); if (mapDiv) mapDiv.style.minHeight = '300px'; } catch {}
    const r = await fetch(`/api/recolector/previsualizacion/${sid}?viewer_id=${user.id}`, { headers: authHeaders() });
    const j = await r.json();
    console.log('usr_ver_viaje_previsualizacion', { sid, recolector: j?.recolector, usuario: j?.usuario, empresa: j?.empresa, distRU: j?.dist_recolector_usuario_km, distUE: j?.dist_usuario_empresa_km });
    const rLat = j?.recolector?.lat ?? null;
    const rLon = j?.recolector?.lon ?? null;
    const uLat = j?.usuario?.lat ?? null;
    const uLon = j?.usuario?.lon ?? null;
    const eLat = j?.empresa?.lat ?? null;
    const eLon = j?.empresa?.lon ?? null;
    viaEmpLat = eLat!=null?Number(eLat):null;
    viaEmpLon = eLon!=null?Number(eLon):null;
    let recoId = 0;
    let sjCache = null;
    try { sjCache = await (await fetch(`/api/solicitudes/${sid}`, { headers: authHeaders() })).json(); recoId = Number(sjCache?.recolector_id||0); } catch {}
    try {
      const st = String(sjCache?.handoff_state||'');
      viaHandoffPublished = (st==='publicado');
      viaHandoffInExchange = (st==='en_intercambio');
      viaHandoffPickLat = sjCache?.handoff_pick_lat!=null ? Number(sjCache.handoff_pick_lat) : null;
      viaHandoffPickLon = sjCache?.handoff_pick_lon!=null ? Number(sjCache.handoff_pick_lon) : null;
      try { const cl = sjCache?.handoff_cur_lat!=null ? Number(sjCache.handoff_cur_lat) : null; const co = sjCache?.handoff_cur_lon!=null ? Number(sjCache.handoff_cur_lon) : null; if (cl!=null && co!=null && !Number.isNaN(cl) && !Number.isNaN(co)) { viaHandoffHasPos = true; viaHandoffLastLat = cl; viaHandoffLastLon = co; } } catch {}
    try { const hp = localStorage.getItem('handoff_last_pos_'+sid); if (hp) { const o = JSON.parse(hp); if (o && typeof o.lat === 'number' && typeof o.lon === 'number') { viaHandoffHasPos = true; viaHandoffLastLat = Number(o.lat); viaHandoffLastLon = Number(o.lon); } } } catch {}
    } catch { viaHandoffPublished = false; viaHandoffInExchange = false; viaHandoffPickLat = null; viaHandoffPickLon = null; }
    try {
      const actions = document.querySelector('#viaje-modal .modal-actions');
      if (actions) {
        const oldBtn = document.getElementById('btn-handoff-old'); if (oldBtn) oldBtn.remove();
        const newBtn = document.getElementById('btn-handoff-new'); if (newBtn) newBtn.remove();
        const st = String(sjCache?.handoff_state||'');
        const oldOk = Boolean(sjCache?.handoff_old_ok);
        const newOk = Boolean(sjCache?.handoff_new_ok);
        if (st==='en_intercambio' && String(role)==='recolector'){
          if (!oldOk && Number(sjCache?.recolector_id) === Number(user.id)){
            const b = document.createElement('button'); b.className='btn'; b.id='btn-handoff-old'; b.textContent='Confirmar entrega'; b.onclick=()=>confirmarHandoffOld(sid); actions.insertBefore(b, actions.firstChild);
          }
          if (!newOk && Number(sjCache?.handoff_recolector_id) === Number(user.id)){
            const b2 = document.createElement('button'); b2.className='btn'; b2.id='btn-handoff-new'; b2.textContent='Confirmar recepción'; b2.disabled = true; b2.onclick=()=>confirmarHandoffNew(sid); actions.insertBefore(b2, actions.firstChild);
            try { startHandoffPublish(sid); } catch {}
          }
        }
      }
    } catch {}
    viaUserLat = uLat;
    viaUserLon = uLon;
    try {
      const needConfirm = String(sjCache?.estado||'')==='cerca_usuario' && !(Boolean(sjCache?.usuario_llegada_ok) && Boolean(sjCache?.recolector_recojo_ok));
      viaPausedAtUser = Boolean(needConfirm) || Boolean(viaHandoffPublished) || Boolean(viaHandoffInExchange);
    } catch { viaPausedAtUser = false; }
    if (viaResumePoll) { try{ clearInterval(viaResumePoll); }catch{} viaResumePoll = null; }
    const meta = document.getElementById('usr-route-meta-viaje');
    const mapDiv = document.getElementById('usr-map-viaje');
    let viaCum = null;
    let viaTotalKm = 0;
    function distMeters(lat1, lon1, lat2, lon2){
      const toRad = (x)=> x*Math.PI/180;
      const R = 6371000;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c;
    }
    function buildMetrics(arr){
      try {
        if (!Array.isArray(arr) || arr.length<2) return;
        const lens = [];
        let total = 0;
        for (let k=1; k<arr.length; k++){
          const a = arr[k-1];
          const b = arr[k];
          const d = distMeters(a.lat, a.lng, b.lat, b.lng);
          lens.push(d);
          total += d;
        }
        const cum = [0];
        for (let k=0; k<lens.length; k++) cum.push(cum[cum.length-1] + lens[k]);
        viaCum = cum;
        viaTotalKm = total/1000;
        const done = 0;
        const left = Math.max(viaTotalKm - done, 0);
        if (meta) meta.innerHTML = `En camino: <strong>Recolector → Usuario → Empresa</strong> · Recorrido: <strong>${done.toFixed(2)} km</strong> · Total: <strong>${viaTotalKm.toFixed(2)} km</strong> · Faltan: <strong>${left.toFixed(2)} km</strong>`;
      } catch {}
    }
    if (!viaMap){
      const mapDiv = document.getElementById('usr-map-viaje');
      async function waitVisible(el, maxMs){
        const deadline = Date.now() + (typeof maxMs==='number'?maxMs:1200);
        return new Promise((resolve)=>{
          const t = setInterval(()=>{
            const ok = el && el.offsetWidth>0 && el.offsetHeight>0;
            if (ok){ clearInterval(t); resolve(true); }
            else if (Date.now()>=deadline){ clearInterval(t); resolve(false); }
          }, 50);
        });
      }
      await waitVisible(mapDiv, 1500);
      viaMap = L.map(mapDiv).setView([uLat||-12.05, uLon||-77.03], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(viaMap);
    }
    setTimeout(()=>{ try { viaMap.invalidateSize(); } catch {} }, 100);
    const toFit = [];
    if (rLat!=null && rLon!=null) toFit.push([rLat, rLon]);
    if (uLat!=null && uLon!=null) toFit.push([uLat, uLon]);
    if (eLat!=null && eLon!=null) toFit.push([eLat, eLon]);
    if (toFit.length>0) viaMap.fitBounds(toFit);
    if (viaLayer) { viaLayer.remove(); viaLayer = null; }
    if (viaPoly) { viaPoly.remove(); viaPoly = null; }
    const partidaIcon = L.icon({ iconUrl: '/img/partida.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
    const recolectorIcon = L.icon({ iconUrl: '/img/recolector.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
    const recolectorHandIcon = L.icon({ iconUrl: '/img/recohand.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
    const hogarIcon = L.icon({ iconUrl: '/img/hogar.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
    const empresaIcon = L.icon({ iconUrl: '/img/empresa.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
    const layers = [];
    if (uLat!=null && uLon!=null) layers.push(L.marker([uLat, uLon], { icon: hogarIcon }).bindPopup('Tu ubicación'));
    if (eLat!=null && eLon!=null) layers.push(L.marker([eLat, eLon], { icon: empresaIcon }).bindPopup('Empresa'));
    if (viaHandoffPickLat!=null && viaHandoffPickLon!=null) {
      const crossIcon = L.divIcon({ className: 'marker-div', html: `<div style="background:#fecaca;color:#7f1d1d;border-radius:8px;padding:2px 6px;border:1px solid #991b1b;box-shadow:0 2px 6px rgba(0,0,0,.25);font-weight:700;font-size:12px;">Handoff</div>`, iconSize: [1,1], iconAnchor: [14,28], popupAnchor: [0,-28] });
      layers.push(L.marker([viaHandoffPickLat, viaHandoffPickLon], { icon: crossIcon }).bindPopup('Punto de handoff'));
    }
    viaLayer = L.layerGroup(layers).addTo(viaMap);
    try {
      if (viaHandoffInExchange) {
        if (viaHandoffMarker) { try { viaHandoffMarker.remove(); } catch {} viaHandoffMarker = null; }
        const initLat = (viaHandoffHasPos && viaHandoffLastLat!=null) ? Number(viaHandoffLastLat) : Number(viaHandoffPickLat);
        const initLon = (viaHandoffHasPos && viaHandoffLastLon!=null) ? Number(viaHandoffLastLon) : Number(viaHandoffPickLon);
        if (!isNaN(initLat) && !isNaN(initLon)) {
          viaHandoffMarker = L.marker([initLat, initLon], { icon: recolectorHandIcon, zIndexOffset: 900 }).addTo(viaMap);
        }
      }
    } catch {}
    try { if (viaHandoffInExchange) { ensureHandoffRouteAndSim(sid); } } catch {}
    if (viaRouteCtrl) { viaRouteCtrl.remove(); viaRouteCtrl = null; }
    try {
      const rr = await fetch(`/api/viajes/${sid}/coords`, { headers: authHeaders() });
      const jj = await rr.json();
      console.log('viajes_coords_get', { sid, points: Array.isArray(jj?.points)?jj.points.length:0 });
      const pts = Array.isArray(jj?.points) ? jj.points.map(p=> L.latLng(Number(p.lat), Number(p.lon))) : [];
      if (pts.length >= 2) {
        viaPrevCoords = pts;
        viaPoly = L.polyline(pts, { color: '#22c55e', weight: 4 }).addTo(viaMap);
        try { if (!viaStartMarker && viaPrevCoords[0]) { viaStartMarker = L.marker(viaPrevCoords[0], { icon: partidaIcon }).addTo(viaMap); } } catch {}
        try { viaMap.fitBounds(viaPoly.getBounds()); } catch {}
        buildMetrics(viaPrevCoords);
        try {
          if (viaPausedAtUser){
            let hold = null;
            if (rLat!=null && rLon!=null) {
              hold = snapToRoute(Number(rLat), Number(rLon));
            } else if (Array.isArray(viaPrevCoords) && viaPrevCoords.length>0 && uLat!=null && uLon!=null) {
              let best = 0, bd = Infinity;
              for (let k=0; k<viaPrevCoords.length; k++){
                const p = viaPrevCoords[k];
                const dd = (p.lat-Number(uLat))*(p.lat-Number(uLat))+(p.lng-Number(uLon))*(p.lng-Number(uLon));
                if (dd<bd){ bd=dd; best=k; }
              }
              const bp = viaPrevCoords[best];
              hold = [bp.lat, bp.lng];
            }
            if (hold){
              ensureHoldMarker(hold);
              viaLastPt = hold;
              const doneKm2 = computeDoneKmFromPt(hold);
              const leftKm2 = Math.max(viaTotalKm - doneKm2, 0);
              if (meta) meta.innerHTML = `Detenido en usuario: <strong>Esperando confirmaciones</strong> · Recorrido: <strong>${doneKm2.toFixed(2)} km</strong> · Total: <strong>${viaTotalKm.toFixed(2)} km</strong> · Faltan: <strong>${leftKm2.toFixed(2)} km</strong>`;
              try { viaMap.invalidateSize(); } catch {}
            }
          }
        } catch {}
        if (rLat!=null && rLon!=null && uLat!=null && uLon!=null && eLat!=null && eLon!=null) {
          if (viaRouteCtrl) { try { viaRouteCtrl.remove(); } catch {} viaRouteCtrl = null; }
          viaRouteCtrl = L.Routing.control({
            language: 'es',
            waypoints: [ L.latLng(rLat, rLon), L.latLng(uLat, uLon), L.latLng(eLat, eLon) ],
            router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', language: 'es' }),
            routeWhileDragging: false,
            showAlternatives: false,
            addWaypoints: false,
            draggableWaypoints: false,
            createMarker: function() { return null; },
            fitSelectedRoutes: true,
            lineOptions: { styles: [{ color: '#22c55e', weight: 4 }] }
          }).addTo(viaMap);
          const contV2 = (viaRouteCtrl && typeof viaRouteCtrl.getContainer === 'function') ? viaRouteCtrl.getContainer() : null;
          if (contV2) contV2.style.display = 'none';
        }
      } else {
        if (rLat!=null && rLon!=null && uLat!=null && uLon!=null && eLat!=null && eLon!=null) {
          viaRouteCtrl = L.Routing.control({
            language: 'es',
            waypoints: [ L.latLng(rLat, rLon), L.latLng(uLat, uLon), L.latLng(eLat, eLon) ],
            router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', language: 'es' }),
            routeWhileDragging: false,
            showAlternatives: false,
            addWaypoints: false,
            draggableWaypoints: false,
            createMarker: function() { return null; },
            fitSelectedRoutes: true,
            lineOptions: { styles: [{ color: '#22c55e', weight: 4 }] }
          }).addTo(viaMap);
          viaRouteCtrl.on('routesfound', (e)=>{
          const sum = e?.routes?.[0]?.summary;
          if (sum) {
            const km = (sum.totalDistance/1000).toFixed(2);
            const min = Math.round(sum.totalTime/60);
            meta.innerHTML = `En camino: <strong>Recolector → Usuario → Empresa</strong> · Distancia: <strong>${km} km</strong> · Tiempo: <strong>${min} min</strong>`;
            console.log('viaje_route_summary', { sid, km: Number(km), min });
          }
          const coords = e?.routes?.[0]?.coordinates || [];
            const pts2 = Array.isArray(coords) ? coords.map(c=> L.latLng(c.lat, c.lng)) : [];
            viaPrevCoords = pts2;
            try {
              if (viaPoly) { viaPoly.remove(); viaPoly = null; }
            if (pts2.length >= 2) {
              viaPoly = L.polyline(pts2, { color: '#22c55e', weight: 4 }).addTo(viaMap);
              try { if (!viaStartMarker && viaPrevCoords[0]) { viaStartMarker = L.marker(viaPrevCoords[0], { icon: partidaIcon }).addTo(viaMap); } } catch {}
              buildMetrics(viaPrevCoords);
            }
            } catch {}
          });
          setTimeout(()=>{
            try {
              if (!viaPoly && Array.isArray(viaPrevCoords) && viaPrevCoords.length>=2){
                viaPoly = L.polyline(viaPrevCoords, { color:'#22c55e', weight:4 }).addTo(viaMap);
              }
            } catch {}
          }, 300);
        }
        (async()=>{
          try {
            const wps = [];
            if (rLat!=null && rLon!=null) wps.push([Number(rLat), Number(rLon)]);
            if (uLat!=null && uLon!=null) wps.push([Number(uLat), Number(uLon)]);
            if (eLat!=null && eLon!=null) wps.push([Number(eLat), Number(eLon)]);
            if (wps.length>=2){
              const q = wps.map(([lat,lon])=> `${lon},${lat}`).join(';');
              const url = `https://router.project-osrm.org/route/v1/driving/${q}?overview=full&geometries=geojson`;
              const rr2 = await fetch(url);
              const jj2 = await rr2.json();
              const coordsGeo = jj2?.routes?.[0]?.geometry?.coordinates || [];
              const pts3 = Array.isArray(coordsGeo) ? coordsGeo.map(([lon,lat])=> L.latLng(Number(lat), Number(lon))) : [];
              if (!viaPoly && pts3.length>=2){
                viaPrevCoords = pts3;
                viaPoly = L.polyline(pts3, { color:'#22c55e', weight:4 }).addTo(viaMap);
                try { if (!viaStartMarker && viaPrevCoords[0]) { viaStartMarker = L.marker(viaPrevCoords[0], { icon: partidaIcon }).addTo(viaMap); } } catch {}
                try { viaMap.fitBounds(viaPoly.getBounds()); } catch {}
                try { viaMap.invalidateSize(); } catch {}
                buildMetrics(viaPrevCoords);
                try {
                  const coordsToSave = pts3.map(p=> ({ lat: Number(p.lat), lon: Number(p.lng) }));
                  await fetch(`/api/viajes/${sid}/coords`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ coords: coordsToSave }) });
                } catch {}
              }
            }
          } catch {}
        })();
        try {
          if (!viaPoly){
            const raw = [];
            if (rLat!=null && rLon!=null) raw.push(L.latLng(Number(rLat), Number(rLon)));
            if (uLat!=null && uLon!=null) raw.push(L.latLng(Number(uLat), Number(uLon)));
            if (eLat!=null && eLon!=null) raw.push(L.latLng(Number(eLat), Number(eLon)));
            if (raw.length>=2){
              viaPoly = L.polyline(raw, { color:'#22c55e', weight:4 }).addTo(viaMap);
              try { if (!viaStartMarker) { viaStartMarker = L.marker(raw[0], { icon: partidaIcon }).addTo(viaMap); } } catch {}
              try { viaMap.fitBounds(viaPoly.getBounds()); } catch {}
              try { viaMap.invalidateSize(); } catch {}
              viaPrevCoords = raw;
              buildMetrics(viaPrevCoords);
            }
          }
        } catch {}
      }
    } catch {}
    if (viaEventSource) { try { viaEventSource.close(); } catch {} viaEventSource = null; }
    function snapToRoute(lat, lon){
      if (!Array.isArray(viaPrevCoords) || viaPrevCoords.length<2) return [lat, lon];
      let best = 0, bd = Infinity;
      for (let k=0; k<viaPrevCoords.length; k++){
        const p = viaPrevCoords[k];
        const d = (p.lat-lat)*(p.lat-lat)+(p.lng-lon)*(p.lng-lon);
        if (d<bd){ bd=d; best=k; }
      }
      const bp = viaPrevCoords[best];
      return [bp.lat, bp.lng];
    }
  function placeSimMarker(pt){
    try {
      if (!pt) return;
      if (!viaSimMarker) { viaSimMarker = L.marker(pt, { icon: recolectorIcon, zIndexOffset: 1000 }).addTo(viaMap); }
      else { viaSimMarker.setLatLng(pt); }
    } catch {}
  }
  function placeSimMarkerDebounced(pt){
    try {
      if (!pt) return;
      if (viaPlaceTick) { try{ clearTimeout(viaPlaceTick); }catch{} }
      viaPlaceTick = setTimeout(()=>{ try { placeSimMarker(pt); } catch {} }, 33);
    } catch {}
  }
  function ensureHoldMarker(pt){
    try {
      if (!pt) return;
      placeSimMarker(pt);
      if (viaHoldTimer) { try{ clearInterval(viaHoldTimer); }catch{} viaHoldTimer = null; }
      viaHoldTimer = setInterval(()=>{ try { if (viaSimMarker) { viaSimMarker.setLatLng(pt); } else { placeSimMarker(pt); } } catch {} }, 1000);
    } catch {}
  }
    function computeDoneKmFromPt(pt){
      try {
        if (!pt || !Array.isArray(viaPrevCoords) || !Array.isArray(viaCum)) return 0;
        let best = 0, bd = Infinity;
        for (let k=0; k<viaPrevCoords.length; k++){
          const p2 = viaPrevCoords[k];
          const dd = (p2.lat-pt[0])*(p2.lat-pt[0])+(p2.lng-pt[1])*(p2.lng-pt[1]);
          if (dd<bd){ bd=dd; best=k; }
        }
        const idx = Math.min(best, viaCum.length-1);
        return (viaCum[idx]||0)/1000;
      } catch { return 0; }
    }
    function onViaMessage(ev){
      try {
        const d = JSON.parse(ev.data||'{}');
        console.log('viajes_stream_msg', { sid, d });
        const lat = Number(d.lat);
        const lon = Number(d.lon);
        const hLat = d.hand_lat!=null ? Number(d.hand_lat) : NaN;
        const hLon = d.hand_lon!=null ? Number(d.hand_lon) : NaN;
        const pickLat = d.hand_pick_lat!=null ? Number(d.hand_pick_lat) : (viaHandoffPickLat!=null ? Number(viaHandoffPickLat) : NaN);
        const pickLon = d.hand_pick_lon!=null ? Number(d.hand_pick_lon) : (viaHandoffPickLon!=null ? Number(viaHandoffPickLon) : NaN);
        if (!isNaN(pickLat) && !isNaN(pickLon)) { viaHandoffPickLat = pickLat; viaHandoffPickLon = pickLon; }
        if (!isNaN(hLat) && !isNaN(hLon)){
          const handPt = [hLat, hLon];
          try {
            if (!viaHandoffMarker) viaHandoffMarker = L.marker(handPt, { icon: recolectorHandIcon, zIndexOffset: 900 }).addTo(viaMap);
            else viaHandoffMarker.setLatLng(handPt);
          } catch {}
          // Track last known handoff position for resume on reopen
          viaHandoffHasPos = true; viaHandoffLastLat = hLat; viaHandoffLastLon = hLon;
          try { localStorage.setItem('handoff_last_pos_'+sid, JSON.stringify({ lat: hLat, lon: hLon })); } catch {}
          try {
            if (!isNaN(pickLat) && !isNaN(pickLon)){
              const dRecoPickKm = distanciaMetros(hLat, hLon, pickLat, pickLon) / 1000;
              let dPickEmpKm = null;
              if (viaEmpLat!=null && viaEmpLon!=null) dPickEmpKm = distanciaMetros(pickLat, pickLon, Number(viaEmpLat), Number(viaEmpLon)) / 1000;
              if (meta) {
                const dp = `Handoff: Recolector2→Punto ${dRecoPickKm.toFixed(2)} km` + (dPickEmpKm!=null ? ` · Punto→Empresa ${dPickEmpKm.toFixed(2)} km` : '');
                if (viaHandoffInExchange) {
                  meta.innerHTML = `<span class="muted">${dp}</span>`;
                } else {
                  const base = meta.innerHTML||'';
                  meta.innerHTML = base ? `${base}<br/><span class="muted">${dp}</span>` : `<span class="muted">${dp}</span>`;
                }
              }
              const btnNew = document.getElementById('btn-handoff-new');
              if (btnNew) btnNew.disabled = !(dRecoPickKm <= 0.05);
            }
          } catch {}
          if (viaHandoffInExchange) {
            viaHandoffServerDriven = true;
            if (viaHandoffSimTimer) { try { clearInterval(viaHandoffSimTimer); } catch {} viaHandoffSimTimer = null; }
          }
        }
        const idx = Number(d.i);
        if (!isNaN(lat) && !isNaN(lon)){
          if (viaPausedAtUser) return;
          let pt = [lat, lon];
          let progressIdx = null;
          if (!isNaN(idx) && Array.isArray(viaPrevCoords) && viaPrevCoords[idx]){
            const baseIdx = idx;
            viaProgIdx = Math.max(viaProgIdx, baseIdx);
            viaProgIdx = Math.min(viaProgIdx + (viaSpeedMult - 1), viaPrevCoords.length - 1);
            const p = viaPrevCoords[viaProgIdx];
            pt = [p.lat, p.lng];
            progressIdx = viaProgIdx;
          } else {
            pt = snapToRoute(lat, lon);
            if (Array.isArray(viaPrevCoords)){
              let best = 0, bd = Infinity;
              for (let k=0; k<viaPrevCoords.length; k++){
                const p2 = viaPrevCoords[k];
                const dd = (p2.lat-pt[0])*(p2.lat-pt[0])+(p2.lng-pt[1])*(p2.lng-pt[1]);
                if (dd<bd){ bd=dd; best=k; }
              }
              viaProgIdx = Math.max(viaProgIdx, best);
              viaProgIdx = Math.min(viaProgIdx + (viaSpeedMult - 1), viaPrevCoords.length - 1);
              const p3 = viaPrevCoords[viaProgIdx];
              pt = [p3.lat, p3.lng];
              progressIdx = viaProgIdx;
            }
          }
          viaLastPt = pt;
          try {
            if (recoId && progressIdx!=null && (progressIdx - viaLastSentIdx >= 1)){
              viaLastSentIdx = progressIdx;
              console.log('reco_ubic_send', { recoId, lat: pt[0], lon: pt[1], progressIdx });
              fetch(`/api/recolector/${recoId}/ubicacion_actual`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ lat: pt[0], lon: pt[1] }) });
            }
          } catch {}
          if (!(viaHandoffPublished || viaHandoffInExchange)) placeSimMarkerDebounced(pt);
          try {
            if (!(viaHandoffPublished || viaHandoffInExchange)) {
              let doneKm = 0;
              if (progressIdx!=null && Array.isArray(viaCum) && viaCum[progressIdx]!=null){
                doneKm = viaCum[progressIdx]/1000;
              } else if (Array.isArray(viaPrevCoords) && Array.isArray(viaCum)){
                let best = 0, bd = Infinity;
                for (let k=0; k<viaPrevCoords.length; k++){
                  const p2 = viaPrevCoords[k];
                  const dd = (p2.lat-pt[0])*(p2.lat-pt[0])+(p2.lng-pt[1])*(p2.lng-pt[1]);
                  if (dd<bd){ bd=dd; best=k; }
                }
                doneKm = viaCum[Math.min(best, viaCum.length-1)]/1000;
              }
              const leftKm = Math.max(viaTotalKm - doneKm, 0);
              if (meta) meta.innerHTML = `En camino: <strong>Recolector → Usuario → Empresa</strong> · Recorrido: <strong>${doneKm.toFixed(2)} km</strong> · Total: <strong>${viaTotalKm.toFixed(2)} km</strong> · Faltan: <strong>${leftKm.toFixed(2)} km</strong>`;
              console.log('viaje_progress', { sid, doneKm, leftKm });
            }
          } catch {}
          try {
            if (!(viaHandoffPublished || viaHandoffInExchange) && viaUserLat!=null && viaUserLon!=null){
              const dUserM = distanciaMetros(pt[0], pt[1], Number(viaUserLat), Number(viaUserLon));
              const dKm = dUserM/1000;
              console.log('viaje_dist_usuario', { sid, dKm });
              if (dKm <= 0.1){
                viaPausedAtUser = true;
                console.log('viaje_paused_at_usuario', { sid });
                if (meta) {
                  const doneKm = computeDoneKmFromPt(viaLastPt || pt);
                  const leftKm = Math.max(viaTotalKm - doneKm, 0);
                  meta.innerHTML = `Detenido en usuario: <strong>Esperando confirmaciones</strong> · Recorrido: <strong>${doneKm.toFixed(2)} km</strong> · Total: <strong>${viaTotalKm.toFixed(2)} km</strong> · Faltan: <strong>${leftKm.toFixed(2)} km</strong>`;
                }
                ensureHoldMarker(viaLastPt || pt);
                try { viaMap.invalidateSize(); } catch {}
                if (viaResumePoll) { try{ clearInterval(viaResumePoll); }catch{} }
                viaResumePoll = setInterval(async ()=>{
                  try {
                    const rs = await fetch(`/api/solicitudes/${sid}`, { headers: authHeaders() });
                    const sj = await rs.json();
                    const ok1 = Boolean(sj?.usuario_llegada_ok);
                    const ok2 = Boolean(sj?.recolector_recojo_ok);
                    const est = String(sj?.estado||'');
                    if ((ok1 && ok2) || est==='rumbo_a_empresa'){
                      clearInterval(viaResumePoll); viaResumePoll = null;
                      viaPausedAtUser = false;
                      if (viaHoldTimer) { try{ clearInterval(viaHoldTimer); }catch{} viaHoldTimer = null; }
                      placeSimMarkerDebounced(viaLastPt || pt);
                      console.log('viaje_resume', { sid });
                      if (meta) meta.innerHTML = `En camino a empresa: <strong>Confirmaciones recibidas</strong>`;
                      try { viaMap.invalidateSize(); } catch {}
                    }
                  } catch {}
                }, 1500);
              }
            }
          } catch {}
          try {
            if (!(viaHandoffPublished || viaHandoffInExchange) && viaEmpLat!=null && viaEmpLon!=null){
              const dEmpM = distanciaMetros(pt[0], pt[1], Number(viaEmpLat), Number(viaEmpLon));
              const dEmpKm = dEmpM/1000;
              if (dEmpKm <= 0.1){
                const doneKmE = computeDoneKmFromPt(viaLastPt || pt);
                const leftKmE = Math.max(viaTotalKm - doneKmE, 0);
                if (meta) meta.innerHTML = `Llegó a empresa: <strong>Esperando confirmaciones</strong> · Recorrido: <strong>${doneKmE.toFixed(2)} km</strong> · Total: <strong>${viaTotalKm.toFixed(2)} km</strong> · Faltan: <strong>${leftKmE.toFixed(2)} km</strong>`;
              }
            }
          } catch {}
        }
        if (viaHandoffInExchange && viaHandoffMarker==null && !isNaN(pickLat) && !isNaN(pickLon)){
          try { viaHandoffMarker = L.marker([pickLat, pickLon], { icon: recolectorHandIcon, zIndexOffset: 900 }).addTo(viaMap); } catch {}
        }
      } catch {}
    }
    viaEventSource = new EventSource(`/api/viajes/${sid}/stream`);
    console.log('viajes_stream_subscribe_front', { sid });
    viaEventSource.onmessage = onViaMessage;
    const speedBtn = document.getElementById('viaje-speed-toggle');
    if (speedBtn) {
      const applyState = ()=>{
        speedBtn.textContent = viaSpeedMult===20 ? 'Velocidad x20' : 'Velocidad 1x';
        speedBtn.setAttribute('aria-pressed', viaSpeedMult!==1 ? 'true' : 'false');
      };
      applyState();
      speedBtn.onclick = async ()=>{
        viaSpeedMult = viaSpeedMult!==1 ? 1 : 20;
        applyState();
        if (viaHandoffInExchange && viaHandoffServerDriven) {
          try { await fetch(`/api/viajes/${sid}/handoff/speed`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ mult: viaSpeedMult }) }); } catch {}
        } else if (viaHandoffInExchange) {
          try { ensureHandoffRouteAndSim(sid); } catch {}
        }
      };
    }
    instrHidden = false;
    const tbtnV = document.getElementById('viaje-instr-toggle');
    if (tbtnV) {
      tbtnV.textContent = 'Ocultar indicaciones';
      tbtnV.onclick = toggleUsrInstructions;
    }
    const contV = (viaRouteCtrl && typeof viaRouteCtrl.getContainer === 'function') ? viaRouteCtrl.getContainer() : null;
    if (contV && instrHidden) contV.style.display = 'none';
    usrSid = sid;
  }

  async function usuarioRutaEmpresa(sid, empresaId){
    const modal = document.getElementById('ruta-modal');
    if (modal && !modal.hidden && usrSid === sid) { closeRuta(); return; }
    if (modal) modal.hidden = false;
    let uLat = null, uLon = null;
    let eLat = null, eLon = null;
    try {
      const r = await fetch(`/api/recolector/previsualizacion/${sid}?viewer_id=${user.id}`, { headers: authHeaders() });
      const j = await r.json();
      uLat = (j?.usuario_actual?.lat ?? null);
      uLon = (j?.usuario_actual?.lon ?? null);
      if (uLat==null || uLon==null) { uLat = j?.usuario?.lat ?? null; uLon = j?.usuario?.lon ?? null; }
      eLat = j?.empresa?.lat ?? null;
      eLon = j?.empresa?.lon ?? null;
    } catch {}
    try {
      await new Promise((resolve)=>{
        if (!navigator.geolocation) return resolve(null);
        navigator.geolocation.getCurrentPosition(p=>{ uLat = p.coords.latitude; uLon = p.coords.longitude; resolve(null); }, ()=>resolve(null), { enableHighAccuracy:true, timeout:3000 });
      });
    } catch {}
    if (uLat==null || uLon==null || eLat==null || eLon==null){
      alert('No se puede trazar la ruta: ubicación o empresa sin coordenadas');
      return;
    }
    const meta = document.getElementById('usr-route-meta-modal');
    const mapDiv = document.getElementById('usr-map-modal');
    if (!rutaMap){ rutaMap = L.map(mapDiv).setView([uLat||-12.05, uLon||-77.03], 13); L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(rutaMap); }
    const toFit = [];
    toFit.push([uLat, uLon]);
    toFit.push([eLat, eLon]);
    rutaMap.fitBounds(toFit);
    if (rutaLayer) { rutaLayer.remove(); rutaLayer = null; }
    const hogarIcon = L.icon({ iconUrl: '/img/hogar.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
    const empresaIcon = L.icon({ iconUrl: '/img/empresa.png', iconSize: [32,32], iconAnchor: [16,32], popupAnchor: [0,-28] });
    const layers = [];
    layers.push(L.marker([uLat, uLon], { icon: hogarIcon }).bindPopup('Mi ubicación'));
    layers.push(L.marker([eLat, eLon], { icon: empresaIcon }).bindPopup('Empresa'));
    rutaLayer = L.layerGroup(layers).addTo(rutaMap);
    if (rutaRouteCtrl) { rutaRouteCtrl.remove(); rutaRouteCtrl = null; }
    rutaRouteCtrl = L.Routing.control({
      language: 'es',
      waypoints: [ L.latLng(uLat, uLon), L.latLng(eLat, eLon) ],
      router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', language: 'es' }),
      routeWhileDragging: false,
      showAlternatives: false,
      addWaypoints: false,
      draggableWaypoints: false,
      createMarker: function() { return null; },
      fitSelectedRoutes: true,
      lineOptions: { styles: [{ color: '#22c55e', weight: 4 }] }
    }).addTo(rutaMap);
    rutaRouteCtrl.on('routesfound', (e)=>{
      const sum = e?.routes?.[0]?.summary;
      if (sum) {
        const km = (sum.totalDistance/1000).toFixed(2);
        const min = Math.round(sum.totalTime/60);
        meta.innerHTML = `Cómo llegar: <strong>Tu ubicación → Empresa</strong> · Distancia: <strong>${km} km</strong> · Tiempo: <strong>${min} min</strong>`;
      }
    });
    instrHidden = false;
    const tbtn = document.getElementById('usr-instr-toggle');
    if (tbtn) {
      tbtn.textContent = 'Ocultar indicaciones';
      tbtn.onclick = toggleUsrInstructions;
    }
    const cont = (rutaRouteCtrl && typeof rutaRouteCtrl.getContainer === 'function') ? rutaRouteCtrl.getContainer() : null;
    if (cont && instrHidden) cont.style.display = 'none';
    usrSid = sid;
  }

  function closeRuta(){
    const modal = document.getElementById('ruta-modal');
    if (modal) modal.hidden = true;
    const meta = document.getElementById('usr-route-meta-modal');
    if (meta) meta.textContent = '';
    if (rutaLayer && rutaMap) { rutaLayer.remove(); rutaLayer = null; }
    if (rutaRouteCtrl) { rutaRouteCtrl.remove(); rutaRouteCtrl = null; }
    if (rutaMap) { rutaMap.remove(); rutaMap = null; }
    usrSid = null;
    instrHidden = false;
  }

  function toggleUsrInstructions(){
    const rutaModal = document.getElementById('ruta-modal');
    const viajeModal = document.getElementById('viaje-modal');
    const ctrl = (rutaModal && !rutaModal.hidden) ? rutaRouteCtrl : ((viajeModal && !viajeModal.hidden) ? viaRouteCtrl : null);
    if (!ctrl || typeof ctrl.getContainer !== 'function') return;
    const cont = ctrl.getContainer();
    instrHidden = !instrHidden;
    cont.style.display = instrHidden ? 'none' : '';
    const tbtn1 = document.getElementById('usr-instr-toggle');
    if (tbtn1) tbtn1.textContent = instrHidden ? 'Mostrar indicaciones' : 'Ocultar indicaciones';
    const tbtn2 = document.getElementById('viaje-instr-toggle');
    if (tbtn2) tbtn2.textContent = instrHidden ? 'Mostrar indicaciones' : 'Ocultar indicaciones';
  }
    async function empresaPesaje(sid, usuarioId){
      solicitudSeleccionada = { id: sid, usuario_id: usuarioId };
      const mats = await (await fetch(`/api/empresas/${user.id}/materiales`, { headers: authHeaders() })).json();
      const sol = await (await fetch(`/api/solicitudes/${sid}`, { headers: authHeaders() })).json();
      const items = Array.isArray(sol?.items_json) ? sol.items_json : [];
      const kgByMat = new Map(items.map((it)=> [Number(it.material_id), Number(it.kg)]));
      materialesSeleccionados = mats.map(m=>({ material_id: m.material_id, nombre: m.nombre, precio: Number(m.precio_por_kg), kg: kgByMat.get(Number(m.material_id)) || 0 }));
      renderPesaje();
      setView('pesaje');
    }
    function renderPesaje(){
      document.getElementById('pesaje-titulo').textContent = 'Pesaje solicitud #' + (solicitudSeleccionada?.id || '');
      document.getElementById('pesaje-meta').textContent = 'Usuario ' + (solicitudSeleccionada?.usuario_id || '');
      const tbody = document.getElementById('pesaje-body');
      tbody.innerHTML = '';
      materialesSeleccionados.forEach((m, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style=\"padding:8px;\">${m.nombre}</td>
          <td style=\"padding:8px; text-align:right;\">${m.precio.toFixed(2)}</td>
          <td style=\"padding:8px; text-align:right;\"><input type=\"number\" min=\"0\" step=\"0.1\" value=\"${m.kg}\" style=\"width:120px;\" data-idx=\"${idx}\" /></td>
          <td style=\"padding:8px; text-align:right;\" id=\"p-sub-${idx}\">0.00</td>
        `;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('input[type=\"number\"]').forEach(inp=>{
        inp.addEventListener('input', (ev)=>{
          const i = Number(ev.target.getAttribute('data-idx'));
          const val = Number(ev.target.value);
          materialesSeleccionados[i].kg = isNaN(val) ? 0 : val;
          actualizarPesajeTotal();
        });
      });
      actualizarPesajeTotal();
      const chk = document.getElementById('pesaje-agree');
      const btn = document.getElementById('btn-pesaje-confirm');
      if (chk) chk.checked = false;
      if (btn) btn.disabled = true;
      if (chk) chk.onchange = ()=>{ if (btn) btn.disabled = !chk.checked; };
    }
    function actualizarPesajeTotal(){
      let total = 0;
      materialesSeleccionados.forEach((m, idx)=>{
        const sub = m.kg * m.precio;
        total += sub;
        const el = document.getElementById('p-sub-'+idx);
        if (el) el.textContent = sub.toFixed(2);
      });
      const totalEl = document.getElementById('pesaje-total');
      const feeEl = document.getElementById('pesaje-fee');
      const netEl = document.getElementById('pesaje-net');
      const fee = total * 0.10;
      const net = total + fee;
      if (totalEl) totalEl.textContent = 'S/ ' + total.toFixed(2);
      if (feeEl) feeEl.textContent = 'S/ ' + fee.toFixed(2);
      if (netEl) netEl.textContent = 'S/ ' + net.toFixed(2);
    }
    function cancelarPesaje(){ setView('empresa_solicitudes'); }
    async function confirmarPesaje(){
      const metodo = document.getElementById('metodo-pago').value;
      const payload = {
        usuario_id: solicitudSeleccionada.usuario_id,
        metodo_pago: metodo,
        lat: null,
        lon: null,
        pesajes: materialesSeleccionados.filter(m=> (m.kg||0) > 0).map(m=> ({ material_id: m.material_id, kg_finales: m.kg }))
      };
      const r = await fetch(`/api/empresas/${user.id}/solicitudes/${solicitudSeleccionada.id}/pesaje_pago`, { method:'POST', headers: authHeaders(), body: JSON.stringify(payload) });
      const j = await r.json();
      alert('Transacción registrada: #'+j.id+' · Monto S/ '+Number(j.monto_pagado).toFixed(2));
      setView('empresa_solicitudes');
      loadSolicitudesEmpresa();
    }
    async function loadPerfil(){
      if (role === 'empresa'){
        const pj = await (await fetch(`/api/empresas/${user.id}/perfil`, { headers: authHeaders() })).json();
        const e = pj?.empresa||{};
        const stats = pj?.stats||{};
        const nombre = String(e.nombre||user.nombre||'Empresa');
        const ruc = String(e.ruc||user.ruc||'');
        const logo = String(e.logo||user.logo||'');
        const fallbackImg = '/img/nodisponible.png';
        const initials = (nombre||'').slice(0,2).toUpperCase();
        const avatar = `<img id="empresa-logo-img" src="${logo||fallbackImg}" alt="logo" onerror="this.src='${fallbackImg}'" style="width:64px; height:64px; border-radius:999px; object-fit:cover; border:1px solid #dbeafe; cursor:pointer;" />`;
        const img1 = String(e.foto_local_1||fallbackImg);
        const img2 = String(e.foto_local_2||fallbackImg);
        const img3 = String(e.foto_local_3||fallbackImg);
        document.getElementById('perfil').innerHTML = `
          <div class="card">
            <div class="row jc-between ai-center">
              <div class="row ai-center gap-12">
                <label id="empresa-logo-wrap" for="empresa-logo-file" style="cursor:pointer;">${avatar}</label>
                <input id="empresa-logo-file" type="file" accept="image/png,image/jpeg" style="position:absolute; left:-10000px; width:1px; height:1px;" />
                <div>
                  <div>
                    <strong id="empresa-main-name-text">${nombre}</strong>
                    <input id="empresa-main-name-input" type="text" value="${nombre}" style="display:none; width:260px;" />
                    <button id="empresa-main-save-btn" class="btn" style="display:none; margin-left:8px;">Guardar</button>
                  </div>
                  <div class="muted">ID ${user.id} • RUC ${ruc}</div>
                </div>
              </div>
              <button id="empresa-main-edit-btn" class="btn secondary">✎</button>
            </div>
            <div class="stats-grid" style="margin-top:12px;">
              <div class="stat-card"><div class="stat-title">Transacciones</div><div class="stat-value">${Number(stats.transacciones||0)}</div></div>
              <div class="stat-card"><div class="stat-title">Materiales activos</div><div class="stat-value">${Number(stats.materiales_activos||0)}</div></div>
              <div class="stat-card"><div class="stat-title">Reputación</div><div class="stat-value">${Number(stats.reputacion||0).toFixed(2)}</div></div>
            </div>
          </div>
          <div class="card" style="margin-top:12px;">
            <div class="row jc-between ai-center">
              <div class="row ai-center" style="gap:8px;">
                <div class="muted">Colección de Empresa</div>
                <button id="empresa-col-edit-btn" class="btn secondary" style="display:none;">✎</button>
              </div>
              <button id="empresa-col-save" class="btn">Guardar</button>
            </div>
            <div class="row" style="gap:16px; margin-top:8px;">
              <div class="thumb-wrap">
                <img id="empresa-col-img1" class="thumb" src="${img1||fallbackImg}" alt="foto1" onerror="this.src='${fallbackImg}'" />
                <button id="empresa-col-edit-1" class="edit-badge">✎</button>
                <input id="empresa-col-file1" type="file" accept="image/png,image/jpeg" />
              </div>
              <div class="thumb-wrap">
                <img id="empresa-col-img2" class="thumb" src="${img2||fallbackImg}" alt="foto2" onerror="this.src='${fallbackImg}'" />
                <button id="empresa-col-edit-2" class="edit-badge">✎</button>
                <input id="empresa-col-file2" type="file" accept="image/png,image/jpeg" />
              </div>
              <div class="thumb-wrap">
                <img id="empresa-col-img3" class="thumb" src="${img3||fallbackImg}" alt="foto3" onerror="this.src='${fallbackImg}'" />
                <button id="empresa-col-edit-3" class="edit-badge">✎</button>
                <input id="empresa-col-file3" type="file" accept="image/png,image/jpeg" />
              </div>
            </div>
          </div>
        `;
        const logoImgEl = document.getElementById('empresa-logo-img');
        const logoFileEl = document.getElementById('empresa-logo-file');
        if (logoImgEl && logoFileEl){
          logoImgEl.onclick = ()=> logoFileEl.click();
          logoFileEl.onchange = async ()=>{
            const f = logoFileEl.files?.[0]||null;
            if (!f) return;
            const b64 = await new Promise((resolve)=>{ const fr=new FileReader(); fr.onload=()=>resolve(String(fr.result)); fr.readAsDataURL(f); });
            logoImgEl.src = String(b64);
            const headers = Object.assign({}, authHeaders(), { 'Content-Type':'application/json' });
            await fetch(`/api/empresas/${user.id}/perfil`, { method:'PATCH', headers, body: JSON.stringify({ logo_base64: b64 }) });
          };
        }
        const mainEdit = document.getElementById('empresa-main-edit-btn');
        const nameText = document.getElementById('empresa-main-name-text');
        const nameInput = document.getElementById('empresa-main-name-input');
        const mainSave = document.getElementById('empresa-main-save-btn');
        if (mainEdit && nameText && nameInput && mainSave){
          mainEdit.onclick = ()=>{
            nameText.style.display = 'none';
            nameInput.style.display = '';
            mainSave.style.display = '';
            nameInput.focus();
          };
          mainSave.onclick = async ()=>{
            const n = nameInput.value || '';
            const f = document.getElementById('empresa-logo-file')?.files?.[0]||null;
            let logoB64 = null;
            if (f){ logoB64 = await new Promise((resolve)=>{ const fr = new FileReader(); fr.onload = ()=> resolve(String(fr.result)); fr.readAsDataURL(f); }); }
            const payload = { nombre: n||null };
            if (logoB64) payload.logo_base64 = logoB64;
            const headers = Object.assign({}, authHeaders(), { 'Content-Type':'application/json' });
            const r = await fetch(`/api/empresas/${user.id}/perfil`, { method:'PATCH', headers, body: JSON.stringify(payload) });
            const j = await r.json();
            const nu = { ...user, nombre: j?.nombre||n||user.nombre, logo: j?.logo||user.logo };
            localStorage.setItem('user', JSON.stringify(nu));
            setTimeout(()=> loadPerfil(), 200);
          };
        }
        const colSave = document.getElementById('empresa-col-save');
        if (colSave) colSave.onclick = async ()=>{
          const f1 = document.getElementById('empresa-col-file1')?.files?.[0]||null;
          const f2 = document.getElementById('empresa-col-file2')?.files?.[0]||null;
          const f3 = document.getElementById('empresa-col-file3')?.files?.[0]||null;
          async function toB64(f){ return f ? await new Promise((resolve)=>{ const fr=new FileReader(); fr.onload=()=>resolve(String(fr.result)); fr.readAsDataURL(f); }) : null; }
          const b1 = await toB64(f1); const b2 = await toB64(f2); const b3 = await toB64(f3);
          const payload = {};
          if (b1) payload.foto_local_1_base64 = b1;
          if (b2) payload.foto_local_2_base64 = b2;
          if (b3) payload.foto_local_3_base64 = b3;
          const headers = Object.assign({}, authHeaders(), { 'Content-Type':'application/json' });
          const r = await fetch(`/api/empresas/${user.id}/perfil`, { method:'PATCH', headers, body: JSON.stringify(payload) });
          await r.json();
          setTimeout(()=> loadPerfil(), 200);
        };
        const e1 = document.getElementById('empresa-col-edit-1');
        const e2 = document.getElementById('empresa-col-edit-2');
        const e3 = document.getElementById('empresa-col-edit-3');
        const f1 = document.getElementById('empresa-col-file1');
        const f2 = document.getElementById('empresa-col-file2');
        const f3 = document.getElementById('empresa-col-file3');
        if (e1 && f1) e1.onclick = ()=> f1.click();
        if (e2 && f2) e2.onclick = ()=> f2.click();
        if (e3 && f3) e3.onclick = ()=> f3.click();
        if (f1) f1.onchange = async ()=>{ const g = f1.files?.[0]||null; if (!g) return; const b64 = await new Promise((resolve)=>{ const fr=new FileReader(); fr.onload=()=>resolve(String(fr.result)); fr.readAsDataURL(g); }); const im = document.getElementById('empresa-col-img1'); if (im) im.src = String(b64); const headers = Object.assign({}, authHeaders(), { 'Content-Type':'application/json' }); await fetch(`/api/empresas/${user.id}/perfil`, { method:'PATCH', headers, body: JSON.stringify({ foto_local_1_base64: b64 }) }); };
        if (f2) f2.onchange = async ()=>{ const g = f2.files?.[0]||null; if (!g) return; const b64 = await new Promise((resolve)=>{ const fr=new FileReader(); fr.onload=()=>resolve(String(fr.result)); fr.readAsDataURL(g); }); const im = document.getElementById('empresa-col-img2'); if (im) im.src = String(b64); const headers = Object.assign({}, authHeaders(), { 'Content-Type':'application/json' }); await fetch(`/api/empresas/${user.id}/perfil`, { method:'PATCH', headers, body: JSON.stringify({ foto_local_2_base64: b64 }) }); };
        if (f3) f3.onchange = async ()=>{ const g = f3.files?.[0]||null; if (!g) return; const b64 = await new Promise((resolve)=>{ const fr=new FileReader(); fr.onload=()=>resolve(String(fr.result)); fr.readAsDataURL(g); }); const im = document.getElementById('empresa-col-img3'); if (im) im.src = String(b64); const headers = Object.assign({}, authHeaders(), { 'Content-Type':'application/json' }); await fetch(`/api/empresas/${user.id}/perfil`, { method:'PATCH', headers, body: JSON.stringify({ foto_local_3_base64: b64 }) }); };
        document.getElementById('perfil-materiales').hidden = false;
        const cat = await (await fetch('/api/materiales', { headers: authHeaders() })).json();
        perfilCatalogo = cat.map((m)=>({ id: Number(m.id||m.material_id||m.id_material||m), nombre: m.nombre||String(m.nombre||m), precio_base_por_kg: Number(m.precio_base_por_kg||0) }));
        const mats = await (await fetch(`/api/empresas/${user.id}/materiales`, { headers: authHeaders() })).json();
        perfilMateriales = mats.map(m=>({ material_id: Number(m.material_id), nombre: m.nombre, precio_por_kg: Number(m.precio_por_kg), condiciones: String(m.condiciones||'') }));
        renderPerfilMateriales();
      } else if (role === 'recolector') {
        const pj = await (await fetch(`/api/recolector/${user.id}/perfil`, { headers: authHeaders() })).json();
        const distritos = await (await fetch('/api/recolector/distritos', { headers: authHeaders() })).json();
        const distName = (Array.isArray(distritos)?distritos:[]).find((d)=> Number(d.id_distrito) === Number(pj?.id_distrito))?.nombre || 'Distrito N/A';
        const vehs = await (await fetch(`/api/recolector/${user.id}/vehiculos`, { headers: authHeaders() })).json();
        const curVeh = (Array.isArray(vehs)?vehs:[]).find((v)=> Boolean(v.activo)) || (Array.isArray(vehs)?vehs[0]:null);
        const placa = curVeh?.placa ? String(curVeh.placa) : 'No asignado';
        const tipoNombre = (curVeh?.tipo || curVeh?.tipo_id!=null ? null : null); // nombre puede venir como 'tipo' si existe
        const tipoText = (curVeh && (curVeh.tipo!=null)) ? String(curVeh.tipo) : 'vehículo';
        const capKg = curVeh?.capacidad_kg!=null ? Number(curVeh.capacidad_kg) : 0;
        const hist = await (await fetch(`/api/recolector/${user.id}/historial`, { headers: authHeaders() })).json();
        const trabajos = Array.isArray(hist) ? hist.length : 0;
        const nombre = String(pj?.nombre||user.nombre||user.email||'Recolector');
        const apellidos = String(pj?.apellidos||'').trim();
        const dni = String(pj?.dni||'').trim();
        const initials = (nombre||apellidos) ? (nombre.slice(0,1).toUpperCase()) : 'R';
        const repProm = pj?.reputacion_promedio!=null ? Number(pj.reputacion_promedio) : 0;
        const repCount = pj?.resenas_recibidas_count!=null ? Number(pj.resenas_recibidas_count) : 0;
        const fallbackImg = '/img/nodisponible.png';
        const perf = String(pj?.foto_perfil||'');
        const doc = String(pj?.foto_documento||'');
        const veh = String(pj?.foto_vehiculo||'');
        const avatar = perf ? `<img id="reco-perfil-img" src="${perf}" alt="perfil" style="width:64px; height:64px; border-radius:999px; object-fit:cover; border:1px solid #dbeafe; cursor:pointer;" onerror="this.src='${fallbackImg}'" />` : `<div id="reco-perfil-fallback" style="width:64px; height:64px; border-radius:999px; background:#e2f7ea; color:#10b981; display:flex; align-items:center; justify-content:center; font-weight:700; cursor:pointer;">${initials}</div>`;
        document.getElementById('perfil').innerHTML = `
          <div class="card">
            <div class="row jc-between ai-center">
              <div class="row ai-center gap-12">
                <label id="reco-perfil-wrap" for="reco-perfil-file" style="cursor:pointer;">${avatar}</label>
                <input id="reco-perfil-file" type="file" accept="image/png,image/jpeg" style="position:absolute; left:-10000px; width:1px; height:1px;" />
                <div>
                  <div><strong>${nombre}${apellidos? (' '+apellidos):''}</strong></div>
                  <div class="muted">${dni? ('DNI '+dni) : ''}</div>
                  <div class="muted">ID ${user.id} • ${distName}</div>
                </div>
              </div>
            </div>
            <div class="stats-grid" style="margin-top:12px;">
              <div class="stat-card"><div class="stat-title">Trabajos</div><div class="stat-value">${trabajos}</div></div>
              <div class="stat-card"><div class="stat-title">Placa actual</div><div class="stat-value">${placa}</div></div>
              <div class="stat-card"><div class="stat-title">Vehículo - Capacidad de Carga</div><div class="stat-value">${tipoText} - ${capKg} Kg</div></div>
              <div class="stat-card"><div class="stat-title">Reputación</div><div class="stat-value">${repProm.toFixed(2)} <span class="muted">(${repCount} reseñas)</span></div></div>
            </div>
          </div>
          <div class="card" style="margin-top:12px;">
            <div class="row jc-between ai-center">
              <div class="row ai-center" style="gap:8px;">
                <div class="muted">Documentos del recolector</div>
              </div>
            </div>
            <div class="row" style="gap:16px; margin-top:8px;">
              <div class="thumb-wrap">
                <img id="reco-doc-img" class="thumb" src="${doc||fallbackImg}" alt="documento" onerror="this.src='${fallbackImg}'" />
                <button id="reco-doc-edit" class="edit-badge">✎</button>
                <input id="reco-doc-file" type="file" accept="image/png,image/jpeg" />
              </div>
              <div class="thumb-wrap">
                <img id="reco-veh-img" class="thumb" src="${veh||fallbackImg}" alt="vehiculo" onerror="this.src='${fallbackImg}'" />
                <button id="reco-veh-edit" class="edit-badge">✎</button>
                <input id="reco-veh-file" type="file" accept="image/png,image/jpeg" />
              </div>
            </div>
          </div>
          <div class="card" style="margin-top:12px;">
            <div class="row jc-between ai-center">
              <h3>Reseñas</h3>
              <button id="perfil-reco-resenas-refresh" class="btn secondary">Actualizar</button>
            </div>
            <ul id="perfil-reco-resenas-list" class="mono list"></ul>
          </div>
        `;
        const extra = document.getElementById('perfil-usuario-extra');
        if (extra) extra.hidden = true;
        document.getElementById('perfil-materiales').hidden = true;
        const perfImgEl = document.getElementById('reco-perfil-img');
        const perfFileEl = document.getElementById('reco-perfil-file');
        const perfFallbackEl = document.getElementById('reco-perfil-fallback');
        if ((perfImgEl || perfFallbackEl) && perfFileEl){
          const trigger = ()=> perfFileEl.click();
          if (perfImgEl) perfImgEl.onclick = trigger;
          if (perfFallbackEl) perfFallbackEl.onclick = trigger;
          perfFileEl.onchange = async ()=>{
            const f = perfFileEl.files?.[0]||null;
            if (!f) return;
            const b64 = await new Promise((resolve)=>{ const fr=new FileReader(); fr.onload=()=>resolve(String(fr.result)); fr.readAsDataURL(f); });
            if (perfImgEl) perfImgEl.src = String(b64);
            const headers = Object.assign({}, authHeaders(), { 'Content-Type':'application/json' });
            await fetch(`/api/recolector/${user.id}/perfil`, { method:'PATCH', headers, body: JSON.stringify({ foto_perfil_base64: b64 }) });
          };
        }
        const dEdit = document.getElementById('reco-doc-edit');
        const dFile = document.getElementById('reco-doc-file');
        const vEdit = document.getElementById('reco-veh-edit');
        const vFile = document.getElementById('reco-veh-file');
        if (dEdit && dFile) dEdit.onclick = ()=> dFile.click();
        if (vEdit && vFile) vEdit.onclick = ()=> vFile.click();
        if (dFile) dFile.onchange = async ()=>{ const g = dFile.files?.[0]||null; if (!g) return; const b64 = await new Promise((resolve)=>{ const fr=new FileReader(); fr.onload=()=>resolve(String(fr.result)); fr.readAsDataURL(g); }); const im = document.getElementById('reco-doc-img'); if (im) im.src = String(b64); const headers = Object.assign({}, authHeaders(), { 'Content-Type':'application/json' }); await fetch(`/api/recolector/${user.id}/perfil`, { method:'PATCH', headers, body: JSON.stringify({ foto_documento_base64: b64 }) }); };
        if (vFile) vFile.onchange = async ()=>{ const g = vFile.files?.[0]||null; if (!g) return; const b64 = await new Promise((resolve)=>{ const fr=new FileReader(); fr.onload=()=>resolve(String(fr.result)); fr.readAsDataURL(g); }); const im = document.getElementById('reco-veh-img'); if (im) im.src = String(b64); const headers = Object.assign({}, authHeaders(), { 'Content-Type':'application/json' }); await fetch(`/api/recolector/${user.id}/perfil`, { method:'PATCH', headers, body: JSON.stringify({ foto_vehiculo_base64: b64 }) }); };
        const recoResList = document.getElementById('perfil-reco-resenas-list');
        const recoResRefresh = document.getElementById('perfil-reco-resenas-refresh');
        async function loadRecoResenas(){ try{ const r = await fetch(`/api/resenas/recolector/${user.id}`, { headers: authHeaders() }); const list = await r.json(); if (recoResList){ recoResList.innerHTML=''; const arr = Array.isArray(list)?list:[]; arr.forEach(re=>{ const li=document.createElement('li'); const ts = new Date(re.creado_en||Date.now()).toLocaleString(); const stars = '★★★★★'.slice(0, Math.max(0, Math.min(5, Number(re.puntaje||0)))); const quien = String(re.evaluador_rol)==='empresa' ? (`Empresa #${re.evaluador_id}`) : (`Usuario #${re.evaluador_id}`); const msg = re.mensaje ? re.mensaje : '*****'; li.innerHTML = `<div class="row jc-between"><div><div><strong>${quien}</strong> <span class="muted">(${re.evaluador_rol})</span></div><div class="muted">${msg}</div></div><div class="right"><div class="muted">${ts}</div><div style="margin-top:4px;"><span class="badge">${stars}</span></div></div></div>`; recoResList.appendChild(li); }); if (arr.length===0){ const li=document.createElement('li'); li.className='muted'; li.textContent='Sin reseñas aún'; recoResList.appendChild(li); } } }catch{} }
        if (recoResRefresh) recoResRefresh.onclick = ()=> loadRecoResenas();
        await loadRecoResenas();
        return;
      } else {
        const pj = await (await fetch(`/api/usuarios/${user.id}/perfil`, { headers: authHeaders() })).json();
        const u = pj?.usuario||{};
        const mats = Array.isArray(pj?.materiales)? pj.materiales : [];
        const resenas = Array.isArray(pj?.resenas)? pj.resenas : [];
        const st = await (await fetch(`/api/usuarios/${user.id}/stats`, { headers: authHeaders() })).json();
        const puntos = Number(u.puntos_acumulados||user.puntos_acumulados||0);
        const kg = Number(u.kg_totales||user.kg_totales||0);
        const rep = Number(u.reputacion_promedio||user.reputacion_promedio||0);
        const resenasCount = Number(u.resenas_recibidas_count||user.resenas_recibidas_count||0);
        const monto = Number(st?.monto_total||0);
        const nombre = String(u.nombre||user.nombre||'').trim();
        const apellidos = String(u.apellidos||user.apellidos||'').trim();
        const foto = String(u.foto_perfil_path||user.foto_perfil_path||'').trim();
        const initials = (nombre||apellidos) ? (nombre.slice(0,1)+ (apellidos? apellidos.slice(0,1):'')).toUpperCase() : 'U';
        const avatar = foto ? `<img src="${foto}" alt="avatar" style="width:64px; height:64px; border-radius:999px; object-fit:cover; border:1px solid #dbeafe;" />` : `<div style="width:64px; height:64px; border-radius:999px; background:#e2f7ea; color:#10b981; display:flex; align-items:center; justify-content:center; font-weight:700;">${initials}</div>`;
        document.getElementById('perfil').innerHTML = `
          <div class="card">
            <div class="row jc-between ai-center">
              <div class="row ai-center gap-12">
                ${avatar}
                <div>
                  <div><strong>${((nombre||'Usuario') + (apellidos? (' '+apellidos):''))}</strong></div>
                  <div class="muted">ID ${user.id}</div>
                </div>
              </div>
            </div>
            <div class="stats-grid" style="margin-top:12px;">
              <div class="stat-card"><div class="stat-title">Puntos</div><div class="stat-value">${puntos}</div></div>
              <div class="stat-card"><div class="stat-title">Kg totales</div><div class="stat-value">${kg.toFixed(2)}</div></div>
              <div class="stat-card"><div class="stat-title">Monto ganado (S/)</div><div class="stat-value">${monto.toFixed(2)}</div></div>
              <div class="stat-card"><div class="stat-title">Reputación</div><div class="stat-value">${rep.toFixed(2)}</div></div>
              <div class="stat-card"><div class="stat-title">Reseñas</div><div class="stat-value">${resenasCount}</div></div>
            </div>
          </div>
        `;
        const matsBody = document.getElementById('perfil-usuario-materiales-body');
        const resList = document.getElementById('perfil-usuario-resenas-list');
        const extra = document.getElementById('perfil-usuario-extra');
        if (extra) extra.hidden = false;
        if (matsBody){ matsBody.innerHTML=''; mats.forEach(m=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="ta-left">${m.nombre}</td><td class="ta-right">${Number(m.kg_totales||0).toFixed(2)} kg</td>`; matsBody.appendChild(tr); }); }
        if (resList){ resList.innerHTML=''; resenas.forEach(r=>{ const li=document.createElement('li'); const ts = new Date(r.creado_en||Date.now()).toLocaleString(); const stars = '★★★★★'.slice(0, Math.max(0, Math.min(5, Number(r.puntaje||0)))); const msg = r.mensaje ? r.mensaje : '*****'; li.innerHTML = `<div class="row jc-between"><div><div><strong>${r.empresa_nombre}</strong> <span class="muted">(empresa)</span></div><div class="muted">${msg}</div></div><div class="right"><div class="muted">${ts}</div><div style="margin-top:4px;"><span class="badge">${stars}</span></div></div></div>`; resList.appendChild(li); }); }
        document.getElementById('perfil-materiales').hidden = true;
        const editBtn = document.getElementById('perfil-edit-btn');
        if (editBtn){ editBtn.onclick = openPerfilEdit; }
        const matRefresh = document.getElementById('perfil-usuario-materiales-refresh');
        const revRefresh = document.getElementById('perfil-usuario-resenas-refresh');
        if (matRefresh) matRefresh.onclick = ()=> loadPerfil();
        if (revRefresh) revRefresh.onclick = async ()=>{ try{ const r = await fetch(`/api/resenas/usuario/${user.id}`, { headers: authHeaders() }); const list = await r.json(); const rl = document.getElementById('perfil-usuario-resenas-list'); if (rl){ rl.innerHTML=''; (Array.isArray(list)?list:[]).forEach(r=>{ const li=document.createElement('li'); const ts = new Date(r.creado_en||Date.now()).toLocaleString(); const stars = '★★★★★'.slice(0, Math.max(0, Math.min(5, Number(r.puntaje||0)))); const msg = r.mensaje ? r.mensaje : '*****'; li.innerHTML = `<div class="row jc-between"><div><div><strong>${r.empresa_nombre}</strong> <span class="muted">(empresa)</span></div><div class="muted">${msg}</div></div><div class="right"><div class="muted">${ts}</div><div style="margin-top:4px;"><span class="badge">${stars}</span></div></div></div>`; rl.appendChild(li); }); } }catch{} };
      }
    }

    function openPerfilEdit(){
      const m = document.getElementById('perfil-edit-modal');
      if (!m) return;
      const nombre = String(user?.nombre||'');
      const apellidos = String(user?.apellidos||'');
      const nInp = document.getElementById('perfil-edit-nombre');
      const aInp = document.getElementById('perfil-edit-apellidos');
      if (nInp) nInp.value = nombre;
      if (aInp) aInp.value = apellidos;
      m.hidden = false;
    }
    function closePerfilEdit(){ const m = document.getElementById('perfil-edit-modal'); if (m) m.hidden = true; }
    async function savePerfilEdit(){
      const n = document.getElementById('perfil-edit-nombre').value;
      const a = document.getElementById('perfil-edit-apellidos').value;
      const f = document.getElementById('perfil-edit-foto').files?.[0]||null;
      let fotoB64 = null;
      if (f){ fotoB64 = await new Promise((resolve)=>{ const fr = new FileReader(); fr.onload = ()=> resolve(String(fr.result||'').split(',')[1] ? String(fr.result) : String(fr.result)); fr.readAsDataURL(f); }); }
      const payload = { nombre: n||null, apellidos: a||null, foto_base64: fotoB64||null };
      const r = await fetch(`/api/usuarios/${user.id}/perfil`, { method:'PATCH', headers: authHeaders(), body: JSON.stringify(payload) });
      const j = await r.json();
      const nu = { ...user, nombre: j?.nombre||n||user.nombre, apellidos: j?.apellidos||a||user.apellidos, foto_perfil_path: j?.foto_perfil_path||user.foto_perfil_path };
      localStorage.setItem('user', JSON.stringify(nu));
      closePerfilEdit();
      setTimeout(()=> loadPerfil(), 200);
    }

    function renderPerfilMateriales(){
      const tbody = document.getElementById('perfil-materiales-body');
      tbody.innerHTML = '';
      perfilMateriales.forEach(m=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:8px;">${m.nombre}</td>
          <td style="padding:8px; text-align:right;"><input type="number" step="0.01" value="${m.precio_por_kg.toFixed(2)}" style="width:120px;" data-mid="${m.material_id}" /></td>
          <td style="padding:8px; text-align:left;"><input type="text" value="${(m.condiciones||'').replace(/\"/g,'&quot;')}" style="width:220px;" data-midc="${m.material_id}" /></td>
          <td style="padding:8px; text-align:right;"><button class="btn" onclick="perfilRemoveMaterial(${m.material_id})">Quitar</button></td>
        `;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('input[data-mid]').forEach(inp=>{
        inp.addEventListener('input', (ev)=>{
          const mid = Number(ev.target.getAttribute('data-mid'));
          const val = Number(ev.target.value);
          const idx = perfilMateriales.findIndex(x=>x.material_id===mid);
          if (idx>=0) perfilMateriales[idx].precio_por_kg = isNaN(val) ? 0 : val;
        });
      });
      tbody.querySelectorAll('input[data-midc]').forEach(inp=>{
        inp.addEventListener('input', (ev)=>{
          const mid = Number(ev.target.getAttribute('data-midc'));
          const val = String(ev.target.value||'');
          const idx = perfilMateriales.findIndex(x=>x.material_id===mid);
          if (idx>=0) perfilMateriales[idx].condiciones = val;
        });
      });
      const sel = document.getElementById('perfil-add-select');
      sel.innerHTML = '';
      const ya = new Set(perfilMateriales.map(m=>m.material_id));
      perfilCatalogo.filter(c=>!ya.has(c.id)).forEach(c=>{
        const opt = document.createElement('option');
        opt.value = String(c.id);
        opt.textContent = c.nombre;
        sel.appendChild(opt);
      });
      const precioInp = document.getElementById('perfil-add-precio');
      sel.onchange = (ev)=>{
        const mid = Number(sel.value);
        const c = perfilCatalogo.find(x=>x.id===mid);
        if (c && precioInp) precioInp.value = (Number(c.precio_base_por_kg)||0).toFixed(2);
      };
      if (sel.options.length>0){
        const firstId = Number(sel.options[0].value);
        const c0 = perfilCatalogo.find(x=>x.id===firstId);
        if (c0 && precioInp) precioInp.value = (Number(c0.precio_base_por_kg)||0).toFixed(2);
      }
    }

    async function perfilAddMaterial(){
      const sel = document.getElementById('perfil-add-select');
      const mid = Number(sel.value);
      let precio = Number(document.getElementById('perfil-add-precio').value);
      if (!mid) return;
      const c = perfilCatalogo.find(x=>x.id===mid);
      if (!c) return;
      if (perfilMateriales.some(x=>x.material_id===mid)) return;
      if (!precio || precio<=0 || isNaN(precio)) precio = Number(c.precio_base_por_kg)||0;
      perfilMateriales.push({ material_id: mid, nombre: c.nombre, precio_por_kg: precio });
      document.getElementById('perfil-add-precio').value = '';
      renderPerfilMateriales();
    }

    async function perfilRemoveMaterial(mid){
      await fetch(`/api/empresas/${user.id}/materiales/${mid}`, { method:'DELETE', headers: authHeaders() });
      perfilMateriales = perfilMateriales.filter(m=>m.material_id!==Number(mid));
      renderPerfilMateriales();
    }

  async function perfilSaveMaterials(){
      const items = perfilMateriales.map(m=>({ material_id: m.material_id, precio_por_kg: m.precio_por_kg, condiciones: m.condiciones||null }));
      const r = await fetch(`/api/empresas/${user.id}/materiales/upsert`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ items }) });
      await r.json();
      alert('Cambios guardados');
      const mats = await (await fetch(`/api/empresas/${user.id}/materiales`, { headers: authHeaders() })).json();
      perfilMateriales = mats.map(m=>({ material_id: Number(m.material_id), nombre: m.nombre, precio_por_kg: Number(m.precio_por_kg), condiciones: String(m.condiciones||'') }));
      renderPerfilMateriales();
    }

    if (role === 'empresa') {
      document.getElementById('m-empresas').style.display = 'none';
      document.getElementById('m-solicitudes').textContent = 'Solicitudes Entrantes';
      document.getElementById('m-solicitudes').setAttribute('onclick', "setView('empresa_solicitudes')");
      document.getElementById('m-resenas').style.display = '';
      document.getElementById('m-rewards').style.display = 'none';
      setView('empresa_solicitudes');
      try { initNotificaciones(); } catch {}
    } else if (role === 'recolector') {
      document.getElementById('m-empresas').style.display = 'none';
      document.getElementById('m-resenas').style.display = 'none';
      document.getElementById('m-rewards').style.display = 'none';
      document.getElementById('m-solicitudes').textContent = 'Solicitudes Disponibles';
      setView('solicitudes');
      try { initNotificaciones(); } catch {}
    } else {
      document.getElementById('m-resenas').style.display = 'none';
      document.getElementById('m-rewards').style.display = '';
      setView('empresas');
      try { initNotificaciones(); } catch {}
    }
  </script>
</body>
<!-- Tu HTML termina aquí -->
</html>

<script>
  let mapaInit = false;
  let mapa = null;
  let selfMarker = null;
  let geoAccuracy = null;
  let distritosData = null;
  let distritoLayer = null;
  let distritoActual = null;
  let empresasList = [];
  let highlightLayer = null;
  let materialCatalog = [];

  function distanciaMetros(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) ** 2;

    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  async function initMapa() {
    mapaInit = true;

    let center = [-12.05, -77.03];

    try {
      await new Promise((resolve) => {
        if (!navigator.geolocation) return resolve(null);

        navigator.geolocation.getCurrentPosition(
          pos => {
            center = [pos.coords.latitude, pos.coords.longitude];
            resolve(null);
          },
          () => resolve(null),
          { enableHighAccuracy: true, timeout: 3000 }
        );
      });
    } catch {}

    // Inicializar mapa
    mapa = L.map("map").setView(center, 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(mapa);

    selfMarker = L.circleMarker(center, {
      radius: 8,
      color: '#3ac27f',
      weight: 2,
      fillColor: '#38c1b3',
      fillOpacity: 0.9
    }).addTo(mapa);
    selfMarker.bindPopup('Tu ubicación');

    const dbtn = document.getElementById('distrito-btn');
    if (dbtn) dbtn.onclick = verDistrito;
    if (document.getElementById('buscar-btn')) document.getElementById('buscar-btn').onclick = obtenerUbicacion;
    const cbtn = document.getElementById('casa-btn');
    if (cbtn) cbtn.onclick = verUbicacionCasa;
    obtenerUbicacion();
    if (document.getElementById('addr-btn')) document.getElementById('addr-btn').onclick = geocodeAddress;
    if (mapa) mapa.on('click', (e)=> updateSelf(e.latlng.lat, e.latlng.lng));

    // Obtener empresas
    const r = await fetch("/api/empresas", { headers: authHeaders() });
    const list = await r.json();
    empresasList = list.map((e)=>({ ...e }));

    empresasList.forEach(e => {
      const lat = parseFloat(e.lat);
      const lon = parseFloat(e.lon);
      if (isNaN(lat) || isNaN(lon)) return;

      const d = distanciaMetros(center[0], center[1], lat, lon);

      const marker = L.marker([lat, lon]).addTo(mapa);

      // Materiales
      const mat =
        (e.materiales || [])
          .map(m => `#${m.material_id} S/${m.precio_por_kg}`)
          .join(", ") || "Materiales no listados";

      // Escape seguro para popup
      const safeNombre = e.nombre.replace(/'/g, "\\'");
      const safeRuc = String(e.ruc).replace(/'/g, "\\'");
      const reputacion = Number(e.reputacion_promedio) || 0;

      const popupHTML = `
        <strong>${e.nombre}</strong>
        <div>RUC ${e.ruc}</div>
        <div>Distancia ${(d / 1000).toFixed(2)} km</div>
        <div class="muted">${mat}</div>
        <div style="margin-top:8px; text-align:right;">
          <button class="btn secondary"
            onclick="verEmpresa(${e.id}, '${safeNombre}', '${safeRuc}', ${reputacion})">
            Ver
          </button>
        </div>
      `;

      marker.bindPopup(popupHTML);
    });

    const aplicarBtn = document.getElementById('aplicar-filtro');
    if (aplicarBtn) aplicarBtn.onclick = aplicarFiltroMapa;
    const quitarBtn = document.getElementById('quitar-filtro');
    if (quitarBtn) quitarBtn.onclick = quitarFiltroMapa;
    const filtroSel = document.getElementById('map-filtro');
    if (filtroSel) filtroSel.onchange = onFiltroChange;

    try{
      const mr = await fetch('/api/materiales', { headers: authHeaders() });
      materialCatalog = await mr.json();
      const msel = document.getElementById('map-material');
      if (msel){
        msel.innerHTML='';
        materialCatalog.forEach((m)=>{
          const opt = document.createElement('option');
          opt.value = String(m.id);
          opt.textContent = m.nombre;
          msel.appendChild(opt);
        });
      }
    }catch{}
  }
  function verUbicacionCasa(){
    const hLat = (user && user.home_lat!=null) ? Number(user.home_lat) : NaN;
    const hLon = (user && user.home_lon!=null) ? Number(user.home_lon) : NaN;
    if (isNaN(hLat) || isNaN(hLon)) { alert('No hay ubicación de casa configurada'); return; }
    updateSelf(hLat, hLon);
    updateDistritoBadge();
  }
  function updateSelf(lat, lon){
    center = [lat, lon];
    if (selfMarker) selfMarker.setLatLng(center);
    if (mapa) mapa.panTo(center);
    updateAccBadge();
    updateDistritoBadge();
  }
  async function usarIP(){
    try{
      const r = await fetch("https://ipapi.co/json/");
      const d = await r.json();
      if (d && typeof d.latitude === 'number' && typeof d.longitude === 'number') { updateSelf(d.latitude, d.longitude); persistCurrentLocation(d.latitude, d.longitude); }
      geoAccuracy = null;
      updateAccBadge();
    }catch{}
  }
  function obtenerUbicacion(){
    if (navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        p=>{ geoAccuracy = Number(p.coords.accuracy)||null; const lat=p.coords.latitude, lon=p.coords.longitude; updateSelf(lat, lon); persistCurrentLocation(lat, lon); },
        _=>usarIP(),
        { enableHighAccuracy:true, timeout:8000 }
      );
    } else {
      usarIP();
    }
  }
  async function persistCurrentLocation(lat, lon){
    try{
      let j = null;
      if (role === 'usuario'){
        const r = await fetch(`/api/usuarios/${user.id}/ubicacion_actual`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ lat, lon }) });
        j = await r.json();
        if (j && j.usuario){ const nu = { ...user, current_lat: j.usuario.current_lat, current_lon: j.usuario.current_lon }; localStorage.setItem('user', JSON.stringify(nu)); }
      } else if (role === 'recolector'){
        const r = await fetch(`/api/recolector/${user.id}/ubicacion_actual`, { method:'POST', headers: authHeaders(), body: JSON.stringify({ lat, lon }) });
        j = await r.json();
        if (j && j.recolector){ const nu = { ...user, lat: j.recolector.lat, lon: j.recolector.lon }; localStorage.setItem('user', JSON.stringify(nu)); }
      }
      actualizarEstimado();
    }catch{}
  }
  function updateAccBadge(){
    const b = document.getElementById('acc-badge');
    if (!b) return;
    if (selfMarker && typeof selfMarker.getLatLng === 'function'){
      const ll = selfMarker.getLatLng();
      const lat = Number(ll.lat);
      const lon = Number(ll.lng);
      b.textContent = 'Lon '+lon.toFixed(5)+', Lat '+lat.toFixed(5);
    } else {
      b.textContent = 'Posición —';
    }
  }
  async function updateDistritoBadge(){
    const bd = document.getElementById('dist-badge');
    if (!bd || !selfMarker) return;
    const ll = selfMarker.getLatLng();
    if (!distritosData){
      try{
        const r = await fetch('/data/lima_callao_distritos.geojson');
        distritosData = await r.json();
      }catch{
        bd.textContent = 'Distrito —';
        return;
      }
    }
    let nombre = null;
    const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
    for (const f of feats){
      if (contieneFeature(f, ll.lat, ll.lng)){
        const p = f.properties||{};
        nombre = p.nombre||p.name||p.NOMBREDIST||p.distrito||null;
        break;
      }
    }
    if (nombre){
      const t = String(nombre).trim();
      const display = /^lurigancho$/i.test(t) ? 'LURIGANCHO-CHOSICA' : t;
      bd.textContent = 'Distrito: '+display;
    } else {
      bd.textContent = 'Distrito —';
    }
  }

  async function populateDistritosSelect(){
    if (!distritosData){ try{ const r = await fetch('/data/lima_callao_distritos.geojson'); distritosData = await r.json(); }catch{ return; } }
    const sel = document.getElementById('map-filtro-distrito');
    if (!sel) return;
    sel.innerHTML = '';
    const names = [];
    const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
    feats.forEach(f=>{ const p = f.properties||{}; const n = p.nombre||p.name||p.NOMBREDIST||p.distrito||null; if (n) names.push(String(n)); });
    names.sort((a,b)=> a.localeCompare(b, 'es-PE'));
    names.forEach(n=>{ const opt = document.createElement('option'); opt.value = n; opt.textContent = n; sel.appendChild(opt); });
  }

  async function populateDistritosSelectTo(sel){
    if (!distritosData){ try{ const r = await fetch('/data/lima_callao_distritos.geojson'); distritosData = await r.json(); }catch{ return; } }
    if (!sel) return;
    sel.innerHTML = '';
    const names = [];
    const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
    feats.forEach(f=>{ const p = f.properties||{}; const n = p.nombre||p.name||p.NOMBREDIST||p.distrito||null; if (n) names.push(String(n)); });
    names.sort((a,b)=> a.localeCompare(b, 'es-PE'));
    names.forEach(n=>{ const opt = document.createElement('option'); opt.value = n; opt.textContent = n; sel.appendChild(opt); });
  }

  async function onFiltroChange(){
    const sel = document.getElementById('map-filtro');
    const distSel = document.getElementById('map-filtro-distrito');
    const out = document.getElementById('filtro-res');
    const msel = document.getElementById('map-material');
    const limitWrap = document.getElementById('limit-dist-wrap');
    const limitChk = document.getElementById('map-limit-distrito');
    const limitSel = document.getElementById('map-limit-distrito-sel');
    if (!sel || !distSel || !out) return;
    out.textContent = '';
    const v = String(sel.value);
    if (v==='empresas_count'){
      await populateDistritosSelect();
      distSel.style.display = '';
    } else {
      distSel.style.display = 'none';
      distSel.innerHTML = '';
    }
    if (v==='mejor_material'){
      if (msel) msel.style.display='';
      if (limitWrap) limitWrap.style.display='';
      if (limitChk && limitSel){
        limitChk.onchange = async ()=>{
          if (limitChk.checked){ await populateDistritosSelectTo(limitSel); limitSel.style.display=''; }
          else { limitSel.style.display='none'; limitSel.innerHTML=''; }
        };
      }
    } else {
      if (msel) msel.style.display='none';
      if (limitWrap) limitWrap.style.display='none';
      if (limitSel){ limitSel.style.display='none'; limitSel.innerHTML=''; }
      if (limitChk) limitChk.checked = false;
    }
  }

  function empresaDistrito(e){
    const lat = parseFloat(e.lat), lon = parseFloat(e.lon);
    if (isNaN(lat) || isNaN(lon)) return null;
    if (!distritosData) return null;
    const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
    for (const f of feats){ if (contieneFeature(f, lat, lon)) { const p = f.properties||{}; return (p.nombre||p.name||p.NOMBREDIST||p.distrito||null); } }
    return null;
  }

  function avgPrecioEmpresa(e){
    const arr = Array.isArray(e.materiales) ? e.materiales : [];
    if (arr.length===0) return 0;
    let s=0; for (const m of arr) s += Number(m.precio_por_kg)||0;
    return s/arr.length;
  }

  function clearHighlight(){ if (highlightLayer){ try{ mapa.removeLayer(highlightLayer); }catch{} highlightLayer=null; } }
  function highlightEmpresas(list){
    clearHighlight();
    highlightLayer = L.layerGroup();
    list.forEach(e=>{
      const lat = parseFloat(e.lat), lon = parseFloat(e.lon);
      if (isNaN(lat)||isNaN(lon)) return;
      const c = L.circleMarker([lat,lon], { radius:10, color:'#f59e0b', weight:3, fillColor:'#fde68a', fillOpacity:0.5 });
      c.addTo(highlightLayer);
    });
    highlightLayer.addTo(mapa);
  }

  async function aplicarFiltroMapa(){
    const sel = document.getElementById('map-filtro');
    const out = document.getElementById('filtro-res');
    const distSel = document.getElementById('map-filtro-distrito');
    const msel = document.getElementById('map-material');
    const limitChk = document.getElementById('map-limit-distrito');
    const limitSel = document.getElementById('map-limit-distrito-sel');
    if (!sel || !out) return;
    const v = String(sel.value);
    if (v==='none'){ out.textContent = 'Seleccione un filtro'; return; }
    if (!distritosData){ try{ const r = await fetch('/data/lima_callao_distritos.geojson'); distritosData = await r.json(); }catch{ out.textContent='No se pudo cargar distritos'; return; } }
    const current = distritoActual;
    let empresasDistrito = empresasList.filter(e=> empresaDistrito(e) === current);
    if (v==='mejor_material'){
      if (!msel || !msel.value){ out.textContent='Seleccione un material'; return; }
      const materialId = Number(msel.value);
      let pool = empresasList.slice();
      if (limitChk && limitSel && limitChk.checked && limitSel.value){
        const target = String(limitSel.value);
        pool = pool.filter(e=> empresaDistrito(e) === target);
      }
      let best = null; let bestPrecio = -1;
      for (const e of pool){
        const arr = Array.isArray(e.materiales) ? e.materiales : [];
        const item = arr.find((m)=> Number(m.material_id)===materialId);
        const precio = item ? Number(item.precio_por_kg) : -1;
        if (precio>bestPrecio){ bestPrecio=precio; best=e; }
      }
      clearHighlight();
      if (!best || bestPrecio<0){ out.textContent='Sin datos de precios para el material seleccionado'; return; }
      const lat = parseFloat(best.lat), lon = parseFloat(best.lon);
      if (!isNaN(lat)&&!isNaN(lon)){
        highlightLayer = L.layerGroup();
        const c = L.circleMarker([lat,lon], { radius:12, color:'#ef4444', weight:3, fillColor:'#fecaca', fillOpacity:0.6 });
        c.addTo(highlightLayer);
        highlightLayer.addTo(mapa);
        try{ mapa.panTo([lat,lon]); }catch{}
      }
      const matName = (materialCatalog.find((m)=> Number(m.id)===materialId)?.nombre) || ('#'+String(materialId));
      out.textContent = 'Mejor pago por '+matName+': '+best.nombre+' — S/ '+bestPrecio.toFixed(2);
      return;
    }
    if (v==='mas_cercana'){
      if (!selfMarker){ out.textContent='Ubicación no disponible'; return; }
      const ll = selfMarker.getLatLng();
      let best = null; let bestDist = Infinity;
      for (const e of empresasList){
        const lat = parseFloat(e.lat), lon = parseFloat(e.lon);
        if (isNaN(lat)||isNaN(lon)) continue;
        const d = distanciaMetros(ll.lat, ll.lng, lat, lon);
        if (d < bestDist){ bestDist = d; best = e; }
      }
      clearHighlight();
      if (!best || !isFinite(bestDist)){ out.textContent='No se encontró empresa cercana'; return; }
      const lat = parseFloat(best.lat), lon = parseFloat(best.lon);
      if (!isNaN(lat)&&!isNaN(lon)){
        highlightLayer = L.layerGroup();
        const c = L.circleMarker([lat,lon], { radius:12, color:'#0ea5e9', weight:3, fillColor:'#bae6fd', fillOpacity:0.6 });
        c.addTo(highlightLayer);
        highlightLayer.addTo(mapa);
        try{ mapa.panTo([lat,lon]); }catch{}
      }
      out.textContent = 'Empresa más cercana: '+best.nombre+' — '+(bestDist/1000).toFixed(2)+' km';
      return;
    }
    if (v==='top_pagan'){
      const sorted = empresasDistrito.slice().sort((a,b)=> avgPrecioEmpresa(b)-avgPrecioEmpresa(a));
      const top = sorted.slice(0, Math.min(5, sorted.length));
      highlightEmpresas(top);
      out.textContent = top.length ? ('Top pagadores ('+top.length+') en '+(current||'—')) : 'Sin empresas en distrito';
      return;
    }
    if (v==='empresas_count'){
      if (!distSel || !distSel.value){ out.textContent = 'Seleccione un distrito'; return; }
      const target = String(distSel.value);
      empresasDistrito = empresasList.filter(e=> empresaDistrito(e) === target);
      clearHighlight();
      const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
      let found = null;
      for (const f of feats){ const p = f.properties||{}; const name = p.nombre||p.name||p.NOMBREDIST||p.distrito||null; if (name===target){ found=f; break; } }
      if (found){
        if (distritoLayer){ try{ mapa.removeLayer(distritoLayer); }catch{} distritoLayer=null; }
        distritoLayer = L.geoJSON(found, { style: { color:'#22c55e', weight:3, fillColor:'#86efac', fillOpacity:0.2 } });
        distritoLayer.addTo(mapa);
        try{ mapa.fitBounds(distritoLayer.getBounds(), { padding:[20,20] }); }catch{}
      }
      out.textContent = 'Empresas registradas en '+target+': '+String(empresasDistrito.length);
      return;
    }
    if (v==='mas_tx'){
      try{
        const r = await fetch('/api/empresas/stats_distritos', { headers: authHeaders() });
        const stats = await r.json();
        const best = stats && stats[0] ? String(stats[0].distrito) : null;
        const bestCount = stats && stats[0] ? Number(stats[0].transacciones_count) : 0;
        if (!best){ out.textContent='Sin datos de transacciones'; clearHighlight(); return; }
        if (!distritosData){ const rr = await fetch('/data/lima_callao_distritos.geojson'); distritosData = await rr.json(); }
        const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
        let found = null;
        for (const f of feats){ const p = f.properties||{}; const name = p.nombre||p.name||p.NOMBREDIST||p.distrito||null; if (name===best){ found=f; break; } }
        clearHighlight();
        if (found){
          if (distritoLayer){ try{ mapa.removeLayer(distritoLayer); }catch{} distritoLayer=null; }
          distritoLayer = L.geoJSON(found, { style: { color:'#22c55e', weight:3, fillColor:'#86efac', fillOpacity:0.2 } });
          distritoLayer.addTo(mapa);
          try{ mapa.fitBounds(distritoLayer.getBounds(), { padding:[20,20] }); }catch{}
        }
        out.textContent = 'Distrito con más transacciones: '+best+' ('+String(bestCount)+')';
      }catch{ out.textContent='No se pudo cargar estadísticas'; }
      return;
    }
    if (v==='mejor_distrito'){
      const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
      const byDist = new Map();
      empresasList.forEach(e=>{
        const d = empresaDistrito(e);
        if (!d) return;
        const arr = byDist.get(d)||[];
        arr.push(Number(e.reputacion_promedio)||0);
        byDist.set(d, arr);
      });
      let best = null; let bestAvg = -1;
      for (const [d, arr] of byDist.entries()){
        const avg = arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0;
        if (avg>bestAvg){ bestAvg=avg; best=d; }
      }
      if (!best){ out.textContent='Sin datos de reputación'; clearHighlight(); return; }
      let found = null;
      for (const f of feats){ const p = f.properties||{}; const name = p.nombre||p.name||p.NOMBREDIST||p.distrito||null; if (name===best){ found=f; break; } }
      if (!found){ out.textContent='Distrito no encontrado'; clearHighlight(); return; }
      if (distritoLayer){ try{ mapa.removeLayer(distritoLayer); }catch{} distritoLayer=null; }
      distritoLayer = L.geoJSON(found, { style: { color:'#22c55e', weight:3, fillColor:'#86efac', fillOpacity:0.2 } });
      distritoLayer.addTo(mapa);
      try{ mapa.fitBounds(distritoLayer.getBounds(), { padding:[20,20] }); }catch{}
      out.textContent = 'Mejor distrito por reputación: '+best+' (avg '+bestAvg.toFixed(2)+')';
      return;
    }
  }

  function quitarFiltroMapa(){
    const out = document.getElementById('filtro-res');
    if (out) out.textContent = '';
    clearHighlight();
    if (distritoLayer){ try{ mapa.removeLayer(distritoLayer); }catch{} distritoLayer=null; }
  }
  async function geocodeAddress(){
    const inp = document.getElementById('addr-input');
    if (!inp) return;
    const q = String(inp.value||'').trim();
    if (!q) return;
    try{
      const r = await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(q));
      const list = await r.json();
      if (Array.isArray(list) && list[0]) updateSelf(parseFloat(list[0].lat), parseFloat(list[0].lon));
    }catch{}
  }

  function puntoEnAnillo(lat, lon, ring){
    let inside = false;
    for (let i=0,j=ring.length-1;i<ring.length;j=i++){
      const xi = ring[i][1], yi = ring[i][0];
      const xj = ring[j][1], yj = ring[j][0];
      const intersect = ((yi>lon)!=(yj>lon)) && (lat < (xj - xi) * (lon - yi) / (yj - yi + 0.0000001) + xi);
      if (intersect) inside = !inside;
    }
    return inside;
  }
  function contieneFeature(feature, lat, lon){
    const g = feature && feature.geometry;
    if (!g) return false;
    if (g.type === 'Polygon'){
      const rings = g.coordinates || [];
      return puntoEnAnillo(lat, lon, rings[0]||[]);
    }
    if (g.type === 'MultiPolygon'){
      const polys = g.coordinates || [];
      for (const p of polys){ if (puntoEnAnillo(lat, lon, (p[0]||[]))) return true; }
      return false;
    }
    return false;
  }
  async function verDistrito(){
    if (!selfMarker) return;
    const ll = selfMarker.getLatLng();
    if (!distritosData){
      try{
        const r = await fetch('/data/lima_callao_distritos.geojson');
        distritosData = await r.json();
      }catch{ alert('No se pudo cargar distritos'); return; }
    }
    let found = null;
    const feats = Array.isArray(distritosData?.features) ? distritosData.features : [];
    for (const f of feats){ if (contieneFeature(f, ll.lat, ll.lng)) { found = f; break; } }
    if (!found){ alert('Ubicación fuera de distritos de Lima/Callao'); return; }
    if (distritoLayer){ try{ mapa.removeLayer(distritoLayer); }catch{} distritoLayer = null; }
    distritoLayer = L.geoJSON(found, { style: { color:'#0ea5e9', weight:3, fillColor:'#60a5fa', fillOpacity:0.15 } });
    distritoLayer.addTo(mapa);
    try{ mapa.fitBounds(distritoLayer.getBounds(), { padding:[20,20] }); }catch{}
    updateDistritoBadge();
  }
</script>
<script>/* stray cleanup
      const navDirect2 = document.getElementById('hist-nav-direct');
      const navHandoff2 = document.getElementById('hist-nav-handoff');
      if (navDirect2 && navHandoff2){
        const showReco = (role==='recolector' && v==='historial');
        navDirect2.style.display = showReco ? '' : 'none';
        navHandoff2.style.display = showReco ? '' : 'none';
        navDirect2.classList.toggle('active', showReco && histRecoTab==='direct');
        navHandoff2.classList.toggle('active', showReco && histRecoTab==='handoff');
      }
*/</script>
