<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Usuario</title>
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/components.css" />
  <link rel="stylesheet" href="/css/layout.css" />
  <style>
    body{background:linear-gradient(180deg,#eefaf3 0%, #e6f7ef 60%, #f6fbf7 100%)}
    .wrap{max-width:880px;margin:0 auto;padding:24px}
    .title{font-weight:800;font-size:28px;margin:0 0 8px}
    .subtitle{color:var(--color-muted);margin:0 0 18px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .full{grid-column:1 / -1}
    .hint{color:var(--color-muted);font-size:12px}
    .avatar{width:80px;height:80px;border-radius:999px;background:linear-gradient(180deg,#e8fbf2,#d6f5e6);border:1px solid #cfeeda;box-shadow:0 10px 20px rgba(34,197,94,0.20);display:flex;align-items:center;justify-content:center;font-size:30px}
  </style>
  <script>
    function setToken(t){ localStorage.setItem('token', t); }
    function setRole(r){ localStorage.setItem('role', r); }
    function setUser(u){ localStorage.setItem('user', JSON.stringify(u)); }
    function goHome(){ window.location.href='/'; }
    function prewarmGeo(){
      try{
        if(navigator.geolocation){
          try{
            const id = navigator.geolocation.watchPosition((p)=>{
              const acc = Number(p.coords.accuracy||9999);
              const cur = window.__bestPos || null;
              if(!cur || acc < Number(cur.acc||9999)){
                window.__bestPos = { lat:p.coords.latitude, lon:p.coords.longitude, acc };
                const homeLat=document.getElementById('home-lat');
                const homeLon=document.getElementById('home-lon');
                const curLat=document.getElementById('cur-lat');
                const curLon=document.getElementById('cur-lon');
                if(homeLat) homeLat.value=String(p.coords.latitude||'');
                if(homeLon) homeLon.value=String(p.coords.longitude||'');
                if(curLat) curLat.value=String(p.coords.latitude||'');
                if(curLon) curLon.value=String(p.coords.longitude||'');
              }
            }, ()=>{}, { enableHighAccuracy:true, maximumAge:0 });
            window.__geoWatchId = id;
          }catch{}
        }
      }catch{}
    }
    async function useLocation(){
      const homeLat=document.getElementById('home-lat');
      const homeLon=document.getElementById('home-lon');
      const curLat=document.getElementById('cur-lat');
      const curLon=document.getElementById('cur-lon');
      const btn=document.getElementById('use-loc-btn-user');
      function set(llat,llon){ if(homeLat) homeLat.value=String(llat||''); if(homeLon) homeLon.value=String(llon||''); if(curLat) curLat.value=String(llat||''); if(curLon) curLon.value=String(llon||''); }
      try{
        if(navigator.geolocation){
          const MAX_WAIT_MS = 20000;
          const ACC_THRESHOLD = 25;
          const curBest = window.__bestPos || null;
          if(curBest && curBest.lat!=null && curBest.lon!=null) set(curBest.lat, curBest.lon);
          if(btn) { try{ btn.setAttribute('disabled','true'); }catch{} }
          showAlert('Cargando ubicaci√≥n...', 'ok');
          let best = null;
          let done = false;
          const start = Date.now();
          try{
            const watchId = navigator.geolocation.watchPosition((p)=>{
              const acc = Number(p.coords.accuracy||9999);
              if(!best || acc < (best.acc||9999)){ best = { lat:p.coords.latitude, lon:p.coords.longitude, acc }; set(best.lat,best.lon); }
              if(acc <= ACC_THRESHOLD || (Date.now()-start) > MAX_WAIT_MS){
                try{ navigator.geolocation.clearWatch(watchId); }catch{}
                done = true;
                showAlert('Ubicaci√≥n lista','ok');
                if(btn) { try{ btn.removeAttribute('disabled'); }catch{} }
              }
            }, async ()=>{
              try{ const r=await fetch('https://ipapi.co/json'); const j=await r.json(); set(j?.latitude,j?.longitude); showAlert('Ubicaci√≥n lista (aprox.)','ok'); }catch{ showAlert('No se pudo obtener ubicaci√≥n','error'); }
              done = true;
              if(btn) { try{ btn.removeAttribute('disabled'); }catch{} }
            }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
            setTimeout(async ()=>{
              if(!done){
                try{ navigator.geolocation.clearWatch(watchId); }catch{}
                if(!best){
                  try{ const r=await fetch('https://ipapi.co/json'); const j=await r.json(); set(j?.latitude,j?.longitude); showAlert('Ubicaci√≥n lista (aprox.)','ok'); }catch{ showAlert('No se pudo obtener ubicaci√≥n','error'); }
                } else {
                  showAlert('Ubicaci√≥n lista','ok');
                }
                if(btn) { try{ btn.removeAttribute('disabled'); }catch{} }
              }
            }, MAX_WAIT_MS+1500);
          }catch{
            try{ const r=await fetch('https://ipapi.co/json'); const j=await r.json(); set(j?.latitude,j?.longitude); showAlert('Ubicaci√≥n lista (aprox.)','ok'); }catch{ showAlert('No se pudo obtener ubicaci√≥n','error'); }
            if(btn) { try{ btn.removeAttribute('disabled'); }catch{} }
          }
          return;
        }
      }catch{}
    }
    document.addEventListener('DOMContentLoaded', prewarmGeo);
    window.addEventListener('beforeunload', ()=>{ try{ const id = window.__geoWatchId; if(id!=null) navigator.geolocation.clearWatch(id); }catch{} });
    function readFileBase64(file){
      return new Promise((resolve)=>{ try{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.readAsDataURL(file); }catch{ resolve(null); } });
    }
    function showAlert(msg,type){ const el=document.getElementById('alert'); if(!el) return; el.textContent=msg; el.className='badge'; el.style.background= type==='error' ? '#ffecec' : '#F2FBF7'; el.style.borderColor= type==='error' ? '#fca5a5' : '#cfeeda'; }
    async function submit(){
      const nombre=(document.getElementById('nombre')||{}).value||'';
      const apellidos=(document.getElementById('apellidos')||{}).value||'';
      const dni=(document.getElementById('dni')||{}).value||'';
      const email=(document.getElementById('email')||{}).value||'';
      const pass=(document.getElementById('pass')||{}).value||'';
      const pass2=(document.getElementById('pass2')||{}).value||'';
      const homeLat=(document.getElementById('home-lat')||{}).value||'';
      const homeLon=(document.getElementById('home-lon')||{}).value||'';
      const curLat=(document.getElementById('cur-lat')||{}).value||'';
      const curLon=(document.getElementById('cur-lon')||{}).value||'';
      const em = String(email||'').trim();
      const pw = String(pass||'');
      const nm = String(nombre||'').trim();
      const ap = String(apellidos||'').trim();
      const dn = String(dni||'').trim();
      if(!nm || !ap){ showAlert('Nombre y apellidos son requeridos','error'); return; }
      if(!email || !pass){ showAlert('Email y contrase√±a son requeridos','error'); return; }
      if(pass!==pass2){ showAlert('Las contrase√±as no coinciden','error'); return; }
      if(pw.length<6){ showAlert('La contrase√±a debe tener al menos 6 caracteres','error'); return; }
      if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(em)){ showAlert('Formato de correo inv√°lido','error'); return; }
      if(!dni || !/^\d{1,7}$/.test(dni)){ showAlert('DNI debe tener hasta 7 d√≠gitos','error'); return; }
      if(homeLat){ const n=Number(homeLat); if(Number.isNaN(n) || n<-90 || n>90){ showAlert('Home Lat inv√°lida (-90 a 90)','error'); return; } }
      if(homeLon){ const n=Number(homeLon); if(Number.isNaN(n) || n<-180 || n>180){ showAlert('Home Lon inv√°lida (-180 a 180)','error'); return; } }
      if(curLat){ const n=Number(curLat); if(Number.isNaN(n) || n<-90 || n>90){ showAlert('Current Lat inv√°lida (-90 a 90)','error'); return; } }
      if(curLon){ const n=Number(curLon); if(Number.isNaN(n) || n<-180 || n>180){ showAlert('Current Lon inv√°lida (-180 a 180)','error'); return; } }
      let foto=null; const file=(document.getElementById('foto')||{}).files? (document.getElementById('foto').files[0]||null) : null; if(file){ foto = await readFileBase64(file); }
      try{
        const body={ email, password:pass, nombre, apellidos, dni, foto_base64: foto, home_lat: homeLat? Number(homeLat): null, home_lon: homeLon? Number(homeLon): null, current_lat: curLat? Number(curLat): null, current_lon: curLon? Number(curLon): null };
        const r=await fetch('/api/auth/register/usuario', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        const j=await r.json();
        if(j.token){ setToken(j.token); setRole('usuario'); setUser(j.usuario); window.location.href='/dashboard.html'; return; }
        showAlert('No se pudo registrar. Revisa los datos.','error');
      }catch{ showAlert('Error de red al registrar.','error'); }
    }
  </script>
</head>
<body>
  <div class="wrap">
    <div class="row jc-between ai-center">
      <div class="row ai-center gap-12"><div class="avatar">üë§</div><div><div class="title">Registro de Usuario</div><div class="subtitle">Completa tu perfil para comenzar a reciclar.</div></div></div>
      <button class="btn secondary" onclick="goHome()">Inicio</button>
    </div>
    <div id="alert" class="badge" style="display:block; margin-top:10px; background:#F2FBF7; border-color:#cfeeda"></div>
    <div class="panel mt-12">
      <div class="grid2">
        <div>
          <label>Nombre</label>
          <input id="nombre" type="text" placeholder="Nombre" required />
        </div>
        <div>
          <label>Apellidos</label>
          <input id="apellidos" type="text" placeholder="Apellidos" required />
        </div>
        <div>
          <label>DNI</label>
          <input id="dni" type="text" placeholder="M√°x. 7 d√≠gitos" autocomplete="off" required />
          <div class="hint">√önico e inmutable</div>
        </div>
        <div>
          <label>Correo</label>
          <input id="email" type="email" placeholder="correo@ejemplo.com" autocomplete="off" required />
        </div>
        <div>
          <label>Password</label>
          <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" required />
        </div>
        <div>
          <label>Confirmar</label>
          <input id="pass2" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" required />
        </div>
        <div class="full">
          <label>Foto de perfil</label>
          <input id="foto" type="file" accept="image/png,image/jpeg" />
          <div class="hint">Se guardar√° en /public/img</div>
        </div>
        <div>
          <label>Home Lat</label>
          <input id="home-lat" type="text" placeholder="opcional" />
        </div>
        <div>
          <label>Home Lon</label>
          <input id="home-lon" type="text" placeholder="opcional" />
        </div>
        <div>
          <label>Current Lat</label>
          <input id="cur-lat" type="text" placeholder="auto con ubicaci√≥n" />
        </div>
        <div>
          <label>Current Lon</label>
          <input id="cur-lon" type="text" placeholder="auto con ubicaci√≥n" />
        </div>
      </div>
      <div class="row jc-between mt-12">
        <button id="use-loc-btn-user" class="btn secondary" onclick="useLocation()">Usar mi ubicaci√≥n</button>
        <button class="btn" onclick="submit()">Crear cuenta</button>
      </div>
    </div>
    <div class="muted mt-12">Se recomienda que el usuario realice el registro desde su domicilio, a fin de que el sistema pueda ubicar correctamente su direcci√≥n en el mapa y garantizar la precisi√≥n del servicio de delivery.</div>
  </div>
</body>
</html>
